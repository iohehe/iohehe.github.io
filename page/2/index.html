<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Penlab</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="website">
<meta property="og:title" content="Penlab">
<meta property="og:url" content="http://example.com/page/2/index.html">
<meta property="og:site_name" content="Penlab">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="iohex">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Penlab" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.1.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Penlab</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">The Art of Flow</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-pointer-analysis" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/12/15/pointer-analysis/" class="article-date">
  <time class="dt-published" datetime="2021-12-15T09:57:35.000Z" itemprop="datePublished">2021-12-15</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/12/15/pointer-analysis/">pointer_analysis</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <blockquote>
<p>以南大视频课件为主</p>
</blockquote>
<ol type="1">
<li><p>Motivation</p></li>
<li><p>Introduction to Pointer Analysis 06:50</p>
<ul>
<li>Pointer Analysis and Alias Analysis 14:50</li>
<li>Application of Pointer Analysis 17:20</li>
</ul></li>
<li><p>Key Factors of Pointer Analysis 19:15</p>
<ul>
<li>Heap Abstration 21:30</li>
<li>Context Sensitivity 27:40</li>
<li>Flow Sensitivity 32:30</li>
<li>Analysis Scope 45:40</li>
<li>Pointer Analysis in This Course 52:20 --&gt; 60:20</li>
</ul></li>
<li><p>Concerned Statements 64:50</p></li>
<li><p>Conclusion&amp;下节课内容 77:00</p></li>
</ol>
<h1 id="指针分析">指针分析</h1>
<blockquote>
<p>南大小课堂开课啦～</p>
</blockquote>
<h2 id="problem-of-cha">Problem of CHA</h2>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">foo</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="type">Number</span> <span class="variable">n</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">One</span>();</span><br><span class="line">  <span class="type">int</span> <span class="variable">x</span> <span class="operator">=</span> n.get();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">Number</span> &#123;</span><br><span class="line">  <span class="type">int</span> <span class="title function_">get</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Zero</span> <span class="keyword">implements</span> <span class="title class_">Number</span> &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">get</span><span class="params">()</span> &#123; <span class="keyword">return</span> <span class="number">0</span>; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">One</span> <span class="keyword">implements</span> <span class="title class_">Number</span> &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">get</span><span class="params">()</span> &#123; <span class="keyword">return</span> <span class="number">1</span>; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Two</span> <span class="keyword">implements</span> <span class="title class_">Number</span> &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">get</span><span class="params">()</span> &#123;<span class="keyword">return</span> <span class="number">2</span>;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这个例子中，很显然object n，new的是一个One。</p>
<p>因此返回1。</p>
<blockquote>
<p>如果按照CHA, 那么X就是根据变量类型(Number)来解， 而Number有三个子类。因此此时x指向3个值(0, 1, 2)</p>
</blockquote>
<p>一句话，CHA看不到object的声明类型。</p>
<p>因此在做常量传播的时候，我们的CHA方法就会拿到两个假值(0,2)，此时的结果就是NAC(不精确)。</p>
<p>而做指针分析， 故名思义，就是知道n指向哪个object。</p>
<blockquote>
<p>一个 class在new 的时候， 会做如下事情： 在内存中构造一个object, 运行构造函数，并使用n指向这个object, 因此这里的n就等同与一个指向object地址的指针。</p>
</blockquote>
<p>这个例子中，指针分析可以知道n指向<code>new One</code>这个唯一对象。然后构造调用图(对new One做dispatch)， 得到唯一一个get方法。</p>
<hr />
<h2 id="指针分析介绍">指针分析介绍</h2>
<h3 id="定义">定义</h3>
<p>指针分析可以看作一个基础的静态分析， 他回答的问题是程序中每个指针可以指向那些地址。</p>
<p>对于OO语言 来说，指针分析回答的是一个变量(或者field)可以指向哪些object(may analysis)。</p>
<blockquote>
<p>Answer: Which <strong>object</strong> a <strong>pointer</strong> can point to?</p>
</blockquote>
<p>Let's explain it by an analysis process:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">foo</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="type">A</span> <span class="variable">a</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">A</span>();</span><br><span class="line">  <span class="type">B</span> <span class="variable">x</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">B</span>();</span><br><span class="line">  a.setB(x);</span><br><span class="line">  <span class="type">B</span> <span class="variable">y</span> <span class="operator">=</span> a.getB();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">A</span> &#123;</span><br><span class="line">  B b;</span><br><span class="line">  <span class="keyword">void</span> <span class="title function_">setB</span><span class="params">(B b)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.b = b;</span><br><span class="line">  &#125;</span><br><span class="line">  B <span class="title function_">getB</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.b;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>本例子中，类A 是类B的容器，并提供了get, set方法。 在foo()方法中，独立的new了A和B。 而变量a是<code>new A</code>的指针，变量x是<code>new B</code>的指针。 之后，a调用 setB方法将<code>new B()</code>，store进了<code>new A()</code>。接着又声明了变量y，通过getB方法获取了<code>new B</code>（指向，没 new）。</p>
<p><img src="https://penlab-1252869057.cos.ap-beijing.myqcloud.com/2022-03-31-043531.png" alt="image-20211215193741664" style="zoom:50%;" /></p>
<blockquote>
<p>很datalog</p>
</blockquote>
<h2 id="key-factors-of-pointer-analysis">Key Factors of Pointer Analysis</h2>
<h3 id="allocation-site-abstraction">Allocation-Site Abstraction</h3>
<p>### Context Sensitivity</p>
<blockquote>
<p>How to model calling contexts?</p>
</blockquote>
<p>上下文敏感，在指针分析中，如何对调用上下文进行建模。</p>
<p><code>上下文</code>这个概念有点抽象。就是一个过程调用另一个过程时工作栈上的状态(好像更抽象了)。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">foo</span><span class="params">(<span class="type">int</span> p)</span> &#123;</span><br><span class="line"> 		<span class="keyword">if</span> (p == <span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"><span class="keyword">void</span> <span class="title function_">foo</span><span class="params">()</span> &#123;</span><br><span class="line">  	<span class="type">Test</span> <span class="variable">a</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Test</span>();</span><br><span class="line">    <span class="type">Test</span> <span class="variable">b</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Test</span>();</span><br><span class="line">    <span class="type">int</span> <span class="variable">x</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">test_a</span> <span class="operator">=</span> a.foo(x);</span><br><span class="line">  	x = <span class="number">2</span>;	</span><br><span class="line">  	<span class="type">boolean</span> <span class="variable">test_b</span> <span class="operator">=</span> b.foo(x);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>对于上下文敏感，对于同一个方法，他有多个上下文，么个上下文分别分析一次</p>
<p><img src="https://penlab-1252869057.cos.ap-beijing.myqcloud.com/2022-03-31-043534.png" alt="image-20211215201557399" style="zoom:80%;" /></p>
<p>这里有两个上下文，就会有两个不同的分析。</p>
<p>对于上下文不敏感：</p>
<figure>
<img src="https://penlab-1252869057.cos.ap-beijing.myqcloud.com/2022-03-31-043536.png" alt="image-20211215202037637" /><figcaption aria-hidden="true">image-20211215202037637</figcaption>
</figure>
<p>方法foo()只分析一次。 汇合上下文可能会丢失精度。</p>
<blockquote>
<p>向下文敏感技术是一个重要技术，他能很大程度提高分析精度</p>
</blockquote>
<h3 id="flow-sensitivity">Flow Sensitivity</h3>
<blockquote>
<p>How to model control flow?</p>
</blockquote>
<p>因为同样的语句，如果顺序不同可能结果就不一样</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> a = <span class="number">1</span>;</span><br><span class="line"><span class="type">int</span> b = <span class="number">2</span>;</span><br><span class="line">a = b;</span><br><span class="line"><span class="type">int</span> c;</span><br><span class="line">c = b-a;</span><br><span class="line">c = a-b;</span><br></pre></td></tr></table></figure>
<p>在程序的每一个点,都维护着一个映射(状态)。 每一条语句，都存着数据流到达这一点的数据流信息</p>
<p>在指针分析中要做的流敏感，就要让每一个指针维持一个指向关系集合：</p>
<figure>
<img src="https://penlab-1252869057.cos.ap-beijing.myqcloud.com/2022-03-31-043539.png" alt="image-20211215203219981" /><figcaption aria-hidden="true">image-20211215203219981</figcaption>
</figure>
<p>在这个图片中， 可以看到变量c指向了<code>new C</code>, 经过Allocation-site Abstraction后就是o1</p>
<blockquote>
<p>c-&gt;{o1}</p>
</blockquote>
<p>然后第二句对一个字面量<code>"x"</code>进行了store操作，符号c.f也就是<code>o1.f</code>。</p>
<p>第三句中<code>s = c.f</code>把o1.f取出来塞给了s。</p>
<p>到了第四句<code>o1.f</code>更新了。</p>
<p>人为的去审计当然是指影响<code>o1.f</code>了，因为顺序执行,<code>s</code>的赋值语句已经被执行过了。</p>
<p>但是在流不敏感的情况下， 分析程序只知道: <code>s = o1.f</code>，至于在<code>程序流</code>的哪个位置上是不管的。</p>
<p>因此在第四行：</p>
<ul>
<li>流敏感: s-&gt;{"x"}, o1.f-&gt;{"y"}</li>
</ul>
<figure>
<img src="https://penlab-1252869057.cos.ap-beijing.myqcloud.com/2022-03-31-043541.png" alt="image-20211215203935009" /><figcaption aria-hidden="true">image-20211215203935009</figcaption>
</figure>
<ul>
<li><p>流不敏感：</p>
<p>把程序当成无序集合， 将所有的控制流信息忽略掉。</p>
<p>因此在整个程序中，流不敏感<code>只维护一个指针集</code></p></li>
</ul>
<p><img src="https://penlab-1252869057.cos.ap-beijing.myqcloud.com/2022-03-31-043544.png" alt="image-20211215204252197" style="zoom:67%;" /></p>
<p>所有只维护一个map, 记录程序在运行期间所有指向的对象。</p>
<p>注意由于流不敏感的分析忽略了控制流信息，因此为了保证分析结果是<code>safe</code>的，在分析到s指向o1.f后，就要把程序中所有o1.f map的对象全部传给s(保守期间)。</p>
<blockquote>
<p>! 目前没有证据在JAVA上Flow Sensitive 对 Flow Senisitive 精确许多</p>
</blockquote>
<h3 id="analysis-scope">Analysis Scope</h3>
<blockquote>
<p>Which parts of program should be analyzed?</p>
</blockquote>
<ul>
<li><p>全程序分析(Whole-program)</p></li>
<li><p>按需分析(Demand-driven)</p></li>
</ul>
<p><img src="https://penlab-1252869057.cos.ap-beijing.myqcloud.com/2022-03-31-043546.png" alt="image-20211215204816102" style="zoom:80%;" /></p>
<p>对于如下例子:</p>
<p><img src="https://penlab-1252869057.cos.ap-beijing.myqcloud.com/2022-03-31-043548.png" alt="image-20211215205000523" style="zoom:67%;" /></p>
<p>如果我们只想知道程序中第5行的call graph,那么我们只需要对变量z做指针分析就可以了。</p>
<blockquote>
<p>z-&gt;{o4}</p>
</blockquote>
<blockquote>
<p>有时候按需分析不一定比全程序块，可能设计大量冗余计算。</p>
</blockquote>
<hr />
<h2 id="what-do-we-analyze">What Do We Analyze?</h2>
<p>以下是语句不会修改指针指向的语句：</p>
<p><del>if else</del></p>
<p><del>switch case</del></p>
<p><del>for/while/do...while</del></p>
<p><del>break/continue</del></p>
<p>...</p>
<p>Java当中有哪些指针：</p>
<ul>
<li>Local variable: x (数量最多)</li>
<li>Static field: C.f (与处理variable类似，有文献看作是global field)</li>
<li>Instance field: x.f (instance field是将x.f的组合看作一个指针，也是需要重点分析)</li>
<li>Array element: array[i]</li>
</ul>
<p>对于数组， 静态分析的通用做法是建模成只有一个field的object</p>
<blockquote>
<p>Ignore indexes. Modeled as an object(pointed by array) with a <code>single field</code>, say arr, which may point to any value stored in array.</p>
</blockquote>
<figure>
<img src="https://penlab-1252869057.cos.ap-beijing.myqcloud.com/2022-03-31-043552.png" alt="image-20211216194745810" /><figcaption aria-hidden="true">image-20211216194745810</figcaption>
</figure>
<p>在右边的指针分析中，注意array在声明时new 无长度信息， 因为将array看作一个object, 包含唯一的field arr. 对所有下标(无视下标)都看作对这个field进行store。</p>
<p>所以，指针分析基本上就是围绕以下五条语句：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">x = <span class="keyword">new</span> <span class="title class_">T</span>()   <span class="comment">// New </span></span><br><span class="line">x = y <span class="comment">// Assign</span></span><br><span class="line">x.f = y <span class="comment">// Store</span></span><br><span class="line">y = x.f <span class="comment">// Load  </span></span><br><span class="line">r = x.k(a, ...)  <span class="comment">// Call </span></span><br></pre></td></tr></table></figure>
<h3 id="使用三地址码简化分析">使用三地址码简化分析</h3>
<blockquote>
<p>Complex memory-accesses will be converted to <code>three-address code</code> by introducing temporary variables</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">x.f.g.h = y;</span><br><span class="line">t1 = x.f;</span><br><span class="line">t2 = t1.g;</span><br><span class="line">t2.h = y;</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/12/15/pointer-analysis/" data-id="cl1q2wlhv000y47w55rtngnyx" data-title="pointer_analysis" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-freedo" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/09/18/freedo/" class="article-date">
  <time class="dt-published" datetime="2021-09-18T14:56:57.000Z" itemprop="datePublished">2021-09-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/09/18/freedo/">论自由</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>我觉得我比谁都热爱自由， 但是这事最不能比较， 因为一旦有比较， 其实你就不自由了。</p>
<p>我不喜欢被任何组织约束，这一点不得不承认克氏对我影响很深。 他的"中观"思想，能够让我保持在一种不加任何评判的观察者状态。我觉得这是一件很科学的事情，最近发现其实很多学科的"科学"根基并不牢靠，或者说并没有彻底弄清楚。 但是很多上层的“赛先生”们无比执着科学这件事情，这本身就不科学，如果不能从已知中解脱，从一个客观(或者说中观)的角度去观察问题，就不科学。</p>
<p>我本身也有许多问题要改正，比如成家这件事情。 我一想到自己会被"束缚"就浑身不自在。 但是最近突然觉得享受一个家庭带来的温馨欢乐其实也不错。 :)</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/09/18/freedo/" data-id="cl1q2wlhq000n47w593vbc137" data-title="论自由" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-exp" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/08/16/exp/" class="article-date">
  <time class="dt-published" datetime="2021-08-16T12:55:19.000Z" itemprop="datePublished">2021-08-16</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/08/16/exp/">教训与感悟</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <ol type="1">
<li>凡事提前一点打算， 选择了拖延就选择了心灵受折磨。</li>
<li>所谓成熟，大概就是敢于对自己的行为承担后果。</li>
<li>削减做其他事情的时间只是制造时间变多了的假象，真正有效的是把自己聚起来去解决问题。</li>
<li>保持正念正思维， 把人事都往好处想。</li>
<li>把心量打开，用广阔的视角去看世界， 让自己快乐，也要让别人快乐。</li>
<li>全心全意活在当下，不念过去，不畏未来。</li>
<li>攻是最好的防， 输出是最好的输入。最好的输出方式，应该是自然地流露。</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/08/16/exp/" data-id="cl1q2wlhq000m47w52gv91d3v" data-title="教训与感悟" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-ml-2021-1" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/07/07/ml-2021-1/" class="article-date">
  <time class="dt-published" datetime="2021-07-07T12:28:37.000Z" itemprop="datePublished">2021-07-07</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/07/07/ml-2021-1/">台大深度学习2021-1</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>从上次南大静态分析搞完之后，就说博客再也不写学习笔记了。 于是，我就很久没有更新了...</p>
<p>算了， 还是把博客搞成学习笔记本好了...xD</p>
<p>李宏毅老师的机器学习课程非常的棒，我一定要好好学习....</p>
<h2 id="定义">定义</h2>
<p>对于机器学习可以理解成：</p>
<figure>
<img src="https://penlab-1252869057.cos.ap-beijing.myqcloud.com/2022-03-31-043405.png" alt="image-20210707203503647" /><figcaption aria-hidden="true">image-20210707203503647</figcaption>
</figure>
<p>其实就是约等于一个找函数的能力， 如：</p>
<ul>
<li><p>语音辨识(Image Recognition)：</p>
<p><img src="https://penlab-1252869057.cos.ap-beijing.myqcloud.com/2022-03-31-043407.png" alt="image-20210707203601984" style="zoom:80%;" /></p></li>
</ul>
<p>这里的声音信号做为输入， 而对应的文字作为输出。 这种函数会非常的复杂， 因此我们期望通过机器把它找出来。</p>
<ul>
<li><p>图像识别(Image Recognition):</p>
<p><img src="https://penlab-1252869057.cos.ap-beijing.myqcloud.com/2022-03-31-043412.png" alt="image-20210707203916147" style="zoom:80%;" /></p></li>
</ul>
<p>同理图像识别图片是输入，输出是图片的内容。</p>
<p>等等...</p>
<hr />
<h3 id="专有名词介绍">专有名词介绍</h3>
<ul>
<li><p><code>Regression</code>: The function outputs a scalar.</p>
<p><img src="https://penlab-1252869057.cos.ap-beijing.myqcloud.com/2022-03-31-043416.png" alt="image-20210707204151325" style="zoom:80%;" /></p></li>
</ul>
<p>如上图所示，是一个回归(Regression)任务，此函数输入是今天已知的与输出有关的各种参数， 输出是对于明天PM2.5指数的预测。</p>
<ul>
<li><code>Classification</code>: Given options(classes), the function outputs the correct one.</li>
</ul>
<p>Classification是做选择题:</p>
<p><img src="https://penlab-1252869057.cos.ap-beijing.myqcloud.com/2022-03-31-043418.png" alt="image-20210707204729572" style="zoom:80%;" /></p>
<p>如上图，一个函数帮我们甄别是否一封邮件是垃圾邮件。他的输入就是一封电子邮件，输出是一个选项(选项是提前设定好的)。 选项可以有多个， 如:</p>
<p><img src="https://penlab-1252869057.cos.ap-beijing.myqcloud.com/2022-03-31-043420.png" alt="image-20210707205158308" style="zoom:50%;" /></p>
<p>Playing Go 也是一个Classification, 他有19*19(棋盘大小)个选项。</p>
<ul>
<li>Structured Learning: 除了Regression和Classification以外，如机器不止是产生一个数字或者做一个选择题。 他需要Create something with structure(e.g., image, document)，那么就称为Structured Learning（让机器学会创造）</li>
</ul>
<hr />
<h2 id="case-study">Case Study</h2>
<p>来直观的看一下如何通过机器学习解决问题。</p>
<p>老师的YouTube地址: https://www.youtube.com/c/HungyiLeeNTU</p>
<p><img src="https://penlab-1252869057.cos.ap-beijing.myqcloud.com/2022-03-31-043423.png" alt="image-20210707205846249" style="zoom:50%;" /></p>
<p>后台记录了每一天的观看人数等数据。 现在， 老师想找到一个function，他能够帮我们预测今天有多少人会观看老师的频道。 机器学习找这个function，需要三个步骤：</p>
<h3 id="function-with-unknown-parameters">1. Function with unknown parameters</h3>
<p>写出一个带有<code>未知参数(unknow parameters)</code>的函数:</p>
<p><img src="https://penlab-1252869057.cos.ap-beijing.myqcloud.com/2022-03-31-043425.png" alt="image-20210707210146306" style="zoom:100%;" /></p>
<p>我们来猜测一下， 我们要找的数学式是: <span class="math display">\[
y = b+wx_1
\]</span> 这个带有unknown parameters的函数我们就称为模型(Model)。</p>
<p>其中<code>y</code>是我们所需要的预测的，当天观看频道的总人数。 而<code>x1</code>是我们输入的，已知的昨天观看该频道的人数。</p>
<p>而<code>b</code>和<code>w</code>就是unknow parameters。其中<code>b</code>定义为<code>bias</code>， 而<code>w</code>定义为<code>weight</code>。</p>
<p>这个model不一定是对的，等下会有修正。</p>
<h2 id="define-loss-from-training-data">2. Define Loss from Training Data</h2>
<p>第二步骤， 定义一个Loss Function: <span class="math display">\[
L(b, w)
\]</span> L的输入就是我们model里的参数<code>b</code>跟<code>w</code>; 输出是一个代表了model使用改组参数的好坏。</p>
<p>假设现在设置: <span class="math display">\[
L(0.5k, 1)
\]</span> 那么我们的model就变为： <span class="math display">\[
y = b+ wx_1 \rightarrow y=0.5k +1x_1
\]</span> 那么如何衡量目前这个已定参数的model有多好呢？就需要使用Loss Function。</p>
<p>我们需要从训练资料中找答案：</p>
<p><img src="https://penlab-1252869057.cos.ap-beijing.myqcloud.com/2022-03-31-043434.png" alt="image-20210708204015376" style="zoom:30%;" /></p>
<p>如上图中， 使用我们已定的model去计算已知的，从2017/01/01到2020/12/30日的数据。 我们都可以将每一天的数值带入model， 得到隔天的估测数据，然后计算与真实值的误差来衡量model: <span class="math display">\[
e_2 = \vert y-\hat{y}\vert = 2.1k
\]</span></p>
<blockquote>
<p>每一天的真实数值就叫做Label</p>
</blockquote>
<p>如e2代表我们对2017/01/02的估值。 我们可以依次算出三年的训练资料的误差：</p>
<p><img src="https://penlab-1252869057.cos.ap-beijing.myqcloud.com/2022-03-31-043443.png" alt="image-20210708205313401" style="zoom:20%;" /></p>
<p>这个L越大效果越差， 越小效果越小。</p>
<p>这种依据绝对值求Loss的方法叫做<code>MAE</code>, 而使用平方和求Loss的方法叫做<code>MSE</code>:</p>
<p><img src="https://penlab-1252869057.cos.ap-beijing.myqcloud.com/2022-03-31-043439.png" alt="image-20210708205441134" style="zoom:25%;" /></p>
<p>两种求误差的方法根据需求选择。</p>
<p><img src="https://penlab-1252869057.cos.ap-beijing.myqcloud.com/2022-03-31-043447.png" alt="image-20210708205619696" style="zoom:30%;" /></p>
<p>经过作者对Model进行一系列的调参后的真实结果， 在穷举各种<code>w</code>和<code>b</code>后，使用真实数据计算出来的Loss结果。各种组合的Loss表示为上边的等高线图，越偏红色， 表示计算出的Loss越大， <code>w</code>跟<code>b</code>放入mdoel，效果越差。可以看到估测最准的大约在<code>w</code>在1，b在100左右。</p>
<h2 id="optimization">3. Optimization</h2>
<p>第三步是解一个最佳化的问题， 找到一组最好的<code>w</code>跟<code>b</code>(<code>w*</code>, <code>b*</code>)，可以让Loss的值最小 ：</p>
<p><img src="https://penlab-1252869057.cos.ap-beijing.myqcloud.com/2022-03-31-043452.png" alt="image-20210709202254891" style="zoom:25%;" /></p>
<p>此门课程中唯一用到的Optimization方法是<code>Gradient Descent</code>。</p>
<p>上大图：</p>
<p><img src="https://penlab-1252869057.cos.ap-beijing.myqcloud.com/2022-03-31-043456.png" alt="image-20210709202351925" style="zoom:50%;" /></p>
<p>如图， 为了简化期间， 假设我们已知参数<code>b</code>, 只有一个参数<code>w</code>未知。 当<code>w</code>在不同的数值的时候， 就会得到不同的Loss, 由于简化为只有一个参数， 所以是一条曲线(1D)。</p>
<p>现在的问题是， 如何找到一个<code>w</code>， 使得<code>Loss</code>的值最小?</p>
<p>首先， 我们随机选择一个随机的点<code>w0</code>。 接下来计算， 当<code>w=w0</code>时， <code>w</code>这个参数对<code>L</code>的微分。 即使计算<code>w0</code>点的<code>error surface</code>的切线斜率。如果是<code>Negative</code>就<code>Increase w</code>, 反之。</p>
<p>如图就是猴子哥现在的位置。猴子哥站在那里， 看到左高右低，就向右<code>Increase w</code>。</p>
<p><img src="https://penlab-1252869057.cos.ap-beijing.myqcloud.com/2022-03-31-043458.png" alt="image-20210709203107456" style="zoom:50%;" /></p>
<p>再来一张图，此时猴子哥移动了一段位置，由<code>w0</code>到了<code>w1</code>, 这段距离还依赖于一个参数<code>η</code>, 这个参数是认为设定的<code>learning rate</code>。</p>
<blockquote>
<p>在机器学习中， 自己设定的值，就叫做hyperparameters</p>
</blockquote>
<p>继续反复操作， 最后停下了： 两种情况下停下了: 1)到上限了(hyperparameters) 2) 到达极值点</p>
<p><img src="https://penlab-1252869057.cos.ap-beijing.myqcloud.com/2022-03-31-043504.png" alt="image-20210709203845841" style="zoom:50%;" /></p>
<p>如图假设我们移动到了<code>Local minima</code>的位置停止了， 那么， 我们其实没有到达真正最好的， 可以让<code>Loss</code>最小的<code>w</code>(global minima)。但是实际上，这是一个假问题(不是实际中真正的痛点)。</p>
<p>以上例子只有一个参数<code>w</code>。 那么有<code>w</code>, 跟<code>b</code>如何做<code>Gradient Descent</code>呢？</p>
<ul>
<li><p>给定随机初始值 <code>w0</code>, <code>b0</code></p></li>
<li><p>分别在初始位置计算<code>w</code>和<code>b</code>对<code>L</code>的微分</p></li>
<li><p>更新<code>w</code>跟<code>b</code>，得到<code>w1</code>跟<code>b1</code></p>
<p><img src="https://penlab-1252869057.cos.ap-beijing.myqcloud.com/2022-03-31-043509.png" alt="image-20210709204432226" style="zoom:33%;" /></p></li>
<li><p>迭代更新， 找到<code>w*</code>跟<code>b*</code></p></li>
</ul>
<p><img src="https://penlab-1252869057.cos.ap-beijing.myqcloud.com/2022-03-31-043511.png" alt="image-20210709204603236" style="zoom:50%;" /></p>
<p>将<code>w</code>跟<code>b</code>结合起来，得到箭头的方向，一直移动...</p>
<p>算出来的<code>w*=0.97</code>, <code>b*=0.1k</code> , <code>Loss=0.48K</code>(观看误差大约500人)。</p>
<p>我们以上的三个步骤， 叫做训练。 我们真正要做的是， 对未来的未知的观看次数的预测。</p>
<p><img src="https://penlab-1252869057.cos.ap-beijing.myqcloud.com/2022-03-31-043514.png" alt="image-20210709204838642" style="zoom:50%;" /></p>
<p>如图我们发现在2021的误差值是0.58。因此在位置的数据上， 误差相对较大。</p>
<p>如何再缩小误差， 分析结果：</p>
<p><img src="https://penlab-1252869057.cos.ap-beijing.myqcloud.com/2022-03-31-043518.png" alt="image-20210709205158675" style="zoom:50%;" /></p>
<p>蓝色的线几乎是红色向右平移，因为这个model只参考前一天的结果。 找规律， 发现有<code>每七天一个循环</code>，也许使用一个参考7天的model结果会更准确。修改模型</p>
<blockquote>
<p>对模型的修改往往来自于对问题的理解(Domain Knowledge)</p>
</blockquote>
<p><img src="https://penlab-1252869057.cos.ap-beijing.myqcloud.com/2022-03-31-043519.png" alt="image-20210709205554126" style="zoom:33%;" /></p>
<p>第二个模型，将7天的数据，都列入考虑。我们得到了一个更低的<code>Loss</code>（0.38k）。这个模型中计算了前七天的<code>wjxj</code>, 每一个<code>w</code>跟<code>b</code>都用Gradient Descent计算，来看每一天的<code>w*</code>，让<code>L</code>减小的是<code>w2, w4, w5</code>为负值。</p>
<p><img src="https://penlab-1252869057.cos.ap-beijing.myqcloud.com/2022-03-31-043523.png" alt="image-20210709205750727" style="zoom:50%;" /></p>
<p>以此类推考虑更多天...28天...56天...<code>Loss</code>在没有看过的资料上还是<code>0.46k</code>。</p>
<p>这种将x(feature)乘上一个weight, 再加上bias得到预测结果的模型， 叫做<code>Linear models</code>。</p>
<p>下一讲介绍如何将linear model做到更好。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/07/07/ml-2021-1/" data-id="cl1q2wlhs000r47w59ww01cvc" data-title="台大深度学习2021-1" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-xss-patterns" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/04/07/xss-patterns/" class="article-date">
  <time class="dt-published" datetime="2021-04-07T08:06:34.000Z" itemprop="datePublished">2021-04-07</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/04/07/xss-patterns/">xss patterns</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>There are some source code patterns for XSS I should cover</p>
<h2 id="unserialize">1. unserialize</h2>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$tainted</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;input&#x27;</span>];</span><br><span class="line"><span class="variable">$arr</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$tainted</span>);</span><br><span class="line"><span class="keyword">echo</span>(<span class="variable">$arr</span>[<span class="string">&#x27;foo&#x27;</span>]);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">  </span><br><span class="line">---</span><br><span class="line">exploit localhost:<span class="number">9000</span>/vuln.php/?input=a:<span class="number">1</span>:&#123;s:<span class="number">3</span>:<span class="string">&quot;foo&quot;</span>;s:<span class="number">26</span>:<span class="string">&quot;&lt;script&gt;alert(1);&lt;/script&gt;&quot;</span>;&#125;</span><br></pre></td></tr></table></figure>
<h2 id="string-function-call">2. String function call</h2>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getParam</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$_GET</span>[<span class="string">&#x27;input&#x27;</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$funcName</span> = <span class="string">&#x27;getParam&#x27;</span>;</span><br><span class="line"><span class="variable">$tainted</span> = <span class="variable">$funcName</span>();</span><br><span class="line"><span class="keyword">echo</span>(<span class="variable">$tainted</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">exploit localhost:<span class="number">9000</span>/vuln.php/?input=&lt;script&gt;<span class="title function_ invoke__">alert</span>(<span class="number">1</span>);&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<h2 id="call_user_func">3. call_user_func</h2>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getParam</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$_GET</span>[<span class="string">&#x27;input&#x27;</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$tainted</span> = <span class="title function_ invoke__">call_user_func</span>(<span class="string">&#x27;getParam&#x27;</span>);</span><br><span class="line"><span class="keyword">echo</span>(<span class="variable">$tainted</span>);</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">exploit localhost:<span class="number">9000</span>/vuln.php/?input=&lt;script&gt;<span class="title function_ invoke__">alert</span>(<span class="number">1</span>);&lt;/script&gt;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="call_user_func_array">4. call_user_func_array</h2>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getParam</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$_GET</span>[<span class="string">&#x27;input&#x27;</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$array</span> = [];</span><br><span class="line"></span><br><span class="line"><span class="variable">$tainted</span> = <span class="title function_ invoke__">call_user_func_array</span>(<span class="string">&#x27;getParam&#x27;</span>, <span class="variable">$array</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span>(<span class="variable">$tainted</span>);</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">  exploit localhost:<span class="number">9000</span>/vuln.php/?input=&lt;script&gt;<span class="title function_ invoke__">alert</span>(<span class="number">1</span>);&lt;/script&gt;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="xml-template">5. xml template</h2>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">vul.php</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$tainted</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;tainted&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="variable">$output</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"><span class="variable">$title</span> = <span class="string">&#x27;target&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># template</span></span><br><span class="line"><span class="variable">$template_xml</span> = <span class="title function_ invoke__">simplexml_load_file</span>(<span class="string">&quot;template.xml&quot;</span>);</span><br><span class="line"><span class="variable">$res</span> = <span class="variable">$template_xml</span>-&gt;<span class="title function_ invoke__">xpath</span>(<span class="string">&quot;//template[@name=&#x27;<span class="subst">&#123;$title&#125;</span>&#x27;]&quot;</span>)[<span class="number">0</span>];</span><br><span class="line"><span class="variable">$str</span> = <span class="string">&quot;\$output .= \&quot;&quot;</span>.<span class="variable">$res</span>.<span class="string">&quot;\&quot;;&quot;</span>;</span><br><span class="line"><span class="keyword">eval</span>(<span class="variable">$str</span>); <span class="comment"># critical unsanitized data into a eval function!</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#output</span></span><br><span class="line"><span class="title function_ invoke__">print_r</span>(<span class="variable">$output</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">  ---</span><br><span class="line">template.xml</span><br><span class="line">  </span><br><span class="line"><span class="meta">&lt;?</span>xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span><span class="meta">?&gt;</span></span><br><span class="line">&lt;theme name=<span class="string">&quot;MyBB Master Style&quot;</span> version=<span class="string">&quot;1600&quot;</span>&gt;</span><br><span class="line"></span><br><span class="line">&lt;template name=<span class="string">&quot;target&quot;</span> version=<span class="string">&quot;123&quot;</span>&gt;&lt;![CDATA[</span><br><span class="line">&lt;h1&gt;<span class="variable">$tainted</span>&lt;/h1&gt;</span><br><span class="line">]]&gt;&lt;/template&gt;</span><br><span class="line">&lt;/theme&gt;</span><br><span class="line">  </span><br><span class="line"> ---</span><br><span class="line">  exploit localhost:<span class="number">9000</span>/vuln.php/?tainted=&lt;script&gt;<span class="title function_ invoke__">altert</span>(<span class="number">1</span>);&lt;/script&gt;</span><br><span class="line"> </span><br></pre></td></tr></table></figure>
<h2 id="ob-template">6. ob template</h2>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">vuln.php</span><br><span class="line">  <span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$id</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;id&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">ob_start</span>();</span><br><span class="line"><span class="keyword">include</span>( <span class="string">&#x27;template.php&#x27;</span> ); </span><br><span class="line"><span class="variable">$data</span> = <span class="title function_ invoke__">ob_get_contents</span>();</span><br><span class="line">@<span class="title function_ invoke__">ob_end_clean</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span>(<span class="variable">$data</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">  ---</span><br><span class="line">  template.php</span><br><span class="line">  &lt;h1&gt; example &lt;/h1&gt;</span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$id</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">  ---</span><br><span class="line">  exploit localhost:<span class="number">9000</span>/vuln.php?id=&lt;script&gt;<span class="title function_ invoke__">alert</span>(<span class="number">1</span>);&lt;/script&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="php_self">7. PHP_SELF</h2>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$tainted</span> = <span class="variable">$_SERVER</span>[<span class="string">&#x27;PHP_SELF&#x27;</span>];</span><br><span class="line"><span class="keyword">echo</span>(<span class="variable">$tainted</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">  ---</span><br><span class="line">  exploit localhost:<span class="number">9000</span>/vuln.php/&lt;script&gt;<span class="title function_ invoke__">alert</span>(<span class="number">1</span>)&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<h2 id="foreach">8. FOREACH</h2>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$_GET</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$value</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">  ---</span><br><span class="line">  exploit localhost:<span class="number">9000</span>/vuln.php/?input=&lt;script&gt;<span class="title function_ invoke__">alert</span>(<span class="number">1</span>);&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<h2 id="cookie">9. COOKIE</h2>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$tainted</span> = <span class="variable">$_COOKIE</span>[<span class="string">&#x27;input&#x27;</span>];</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$tainted</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">  ---</span><br><span class="line">  exploit curl <span class="string">&#x27;http://localhost:9000/vuln.php&#x27;</span> --cookie <span class="string">&quot;input=&lt;/script&gt; &lt;script&gt; alert(1) &lt;/script&gt;&quot;</span></span><br></pre></td></tr></table></figure>
<h2 id="print_r">10. print_r</h2>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="meta">?&gt;</span></span><br><span class="line">[<span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$pId</span> = <span class="string">&quot;0&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$pId</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;id&#x27;</span>];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">print_r</span>( <span class="variable">$pId</span> );</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span>]</span><br><span class="line">  </span><br><span class="line">  ---</span><br><span class="line">  exploit localhost:<span class="number">9000</span>/vuln.php?id=&lt;script&gt;<span class="title function_ invoke__">alert</span>(<span class="number">1</span>);&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<h2 id="singleton单例模式">11. Singleton（单例模式）</h2>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require_once</span>(<span class="string">&#x27;singleton.php&#x27;</span>);</span><br><span class="line"><span class="title class_">Singleton</span>::<span class="title function_ invoke__">getInstance</span>()-&gt;<span class="title function_ invoke__">setParam</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;input&#x27;</span>]);</span><br><span class="line"><span class="keyword">echo</span>(<span class="title class_">Singleton</span>::<span class="title function_ invoke__">getInstance</span>()-&gt;<span class="title function_ invoke__">getParam</span>());</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">  </span><br><span class="line">  singleton.php</span><br><span class="line">  <span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Singleton</span></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$variable</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># from: https://de.wikibooks.org/wiki/Websiteentwicklung:_PHP:_Muster_Singleton</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="built_in">static</span> <span class="variable">$_instance</span> = <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * clone</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * Kopieren der Instanz von aussen ebenfalls verbieten</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">__clone</span>(<span class="params"></span>) </span>&#123;&#125;</span><br><span class="line">   </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * constructor</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * externe Instanzierung verbieten</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getInstance</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> === <span class="built_in">self</span>::<span class="variable">$_instance</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">self</span>::<span class="variable">$_instance</span> = <span class="keyword">new</span> <span class="built_in">self</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">self</span>::<span class="variable">$_instance</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setParam</span>(<span class="params"><span class="variable">$par</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;variable = <span class="variable">$par</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getParam</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;variable;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">  </span><br><span class="line">  ---</span><br><span class="line">  exploit localhost:<span class="number">9000</span>/vuln.php/?input=&lt;script&gt;<span class="title function_ invoke__">alert</span>(<span class="number">1</span>);&lt;/script&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="type-validation">12. type validation</h2>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$tainted</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;tainted&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="title function_ invoke__">is_numeric</span>(<span class="variable">$tainted</span>))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="variable">$tainted</span>=<span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$tainted</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="string-replace-escape">13. string replace escape</h2>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$tainted</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;tainted&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="variable">$tainted</span> = <span class="title function_ invoke__">preg_replace</span>(<span class="string">&quot;/[^a-zA-Z]/&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="variable">$tainted</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$tainted</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="build-in-sanitize">14. build-in sanitize</h2>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$tainted</span> = <span class="title function_ invoke__">htmlspecialchars</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;tainted&#x27;</span>]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$tainted</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">  </span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$tainted</span> = <span class="title function_ invoke__">htmlentities</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;tainted&#x27;</span>]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$tainted</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="vendor-sanitize">15. vendor sanitize</h2>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$tainted</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;tainted&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">require_once</span> <span class="string">&#x27;htmlpurifier/HTMLPurifier.auto.php&#x27;</span>;</span><br><span class="line"><span class="variable">$config</span> = <span class="title class_">HTMLPurifier_Config</span>::<span class="title function_ invoke__">createDefault</span>();</span><br><span class="line"><span class="variable">$config</span>-&gt;<span class="title function_ invoke__">set</span>(<span class="string">&#x27;HTML.Allowed&#x27;</span>, <span class="string">&#x27;b,strong,i,em,u,a[href|title],ul,ol,li,p[style],br,span[style]&#x27;</span>);</span><br><span class="line"><span class="variable">$config</span>-&gt;<span class="title function_ invoke__">set</span>(<span class="string">&#x27;CSS.AllowedProperties&#x27;</span>, <span class="string">&#x27;font,font-size,font-weight,font-style,font-family,text-decoration,padding-left,color,background-color,text-align&#x27;</span>);</span><br><span class="line"><span class="variable">$purifier</span> = <span class="keyword">new</span> <span class="title class_">HTMLPurifier</span>(<span class="variable">$config</span>);</span><br><span class="line"><span class="variable">$tainted</span> = <span class="variable">$purifier</span>-&gt;<span class="title function_ invoke__">purify</span>(<span class="variable">$tainted</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$tainted</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="list">16. List</h2>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$arr</span> = <span class="keyword">array</span>(<span class="string">&#x27;useless&#x27;</span>, <span class="variable">$_GET</span>[<span class="string">&#x27;input&#x27;</span>] );</span><br><span class="line">[<span class="variable">$useless</span>, <span class="variable">$tainted</span>]= <span class="variable">$arr</span>; </span><br><span class="line"><span class="keyword">echo</span>(<span class="variable">$tainted</span>);</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">  exploit localhost:<span class="number">9000</span>/vuln.php/?input=&lt;script&gt;<span class="title function_ invoke__">alert</span>(<span class="number">1</span>);&lt;/script&gt;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="return_by_reference">17. return_by_reference</h2>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getParam</span>(<span class="params">&amp;<span class="variable">$ref</span></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$ref</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;input&#x27;</span>];</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$tainted</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( <span class="title function_ invoke__">getParam</span>(<span class="variable">$tainted</span>))&#123;</span><br><span class="line">    <span class="keyword">echo</span>(<span class="variable">$tainted</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">  </span><br><span class="line">---</span><br><span class="line">  exploit localhost:<span class="number">9000</span>/vuln.php/?input=&lt;script&gt;<span class="title function_ invoke__">alert</span>(<span class="number">1</span>);&lt;/script&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="global">18. global</h2>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">source.php</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">  <span class="variable">$global_var</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;input&#x27;</span>];</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">vul.php  </span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require_once</span>(<span class="string">&#x27;source.php&#x27;</span>);</span><br><span class="line"><span class="keyword">echo</span>(<span class="variable">$global_var</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">  exploit localhost:<span class="number">9000</span>/vuln.php/?input=&lt;script&gt;<span class="title function_ invoke__">alert</span>(<span class="number">1</span>);&lt;/script&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getParam</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">global</span> <span class="variable">$var</span>;</span><br><span class="line">    <span class="variable">$var</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;input&#x27;</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">printGlobal</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">global</span> <span class="variable">$var</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$var</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">getParam</span>();</span><br><span class="line"><span class="title function_ invoke__">printGlobal</span>();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="field">19. Field</h2>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">vuln.php</span><br><span class="line">  <span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require_once</span>(<span class="string">&#x27;classassignment.php&#x27;</span>);</span><br><span class="line"><span class="variable">$foo</span> = <span class="keyword">new</span> <span class="title class_">Foo</span>();</span><br><span class="line"><span class="variable">$foo</span>-&gt;<span class="title function_ invoke__">setParam</span>(<span class="string">&#x27;variable&#x27;</span>, <span class="variable">$_GET</span>[<span class="string">&#x27;input&#x27;</span>]);</span><br><span class="line"><span class="keyword">echo</span>(<span class="variable">$foo</span>-&gt;<span class="title function_ invoke__">getParam</span>());</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">  </span><br><span class="line">classassignment.php</span><br><span class="line">  <span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Foo</span></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$variable</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setParam</span>(<span class="params"><span class="variable">$variableName</span>, <span class="variable">$par</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="variable">$variableName</span> = <span class="variable">$par</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getParam</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;variable;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">  </span><br><span class="line">  ---</span><br><span class="line">  exploit localhost:<span class="number">9000</span>/vuln.php/?input=&lt;script&gt;<span class="title function_ invoke__">alert</span>(<span class="number">1</span>);&lt;/script&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/04/07/xss-patterns/" data-id="cl1q2wli6001w47w5hovwg1pd" data-title="xss patterns" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-static-sum" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/03/17/static-sum/" class="article-date">
  <time class="dt-published" datetime="2021-03-17T00:52:56.000Z" itemprop="datePublished">2021-03-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/03/17/static-sum/">静态分析之殇</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="x00-前言">0x00 前言</h1>
<p>计算机高级语言带来了软件开发的便利性， 其解决的问题是：如何使用更接近人类的交流方式与机器进行交流。 因此不可或缺的是一个从人类阅读的语言到机器阅读的语言之间的一个桥梁。 这个转化过程叫做编译。 在编译过程中，从信息的高级语言形式，到机器码形式我们可以看到还有几层中间语言：AST, IR...其实汇编语言就很像机器语言了，可以看成他的一层壳。但是语义还不是很方便人类提取，高级语言解决了这个问题。 再看高级语言往汇编去的路上。 有AST， 为什么要有这一层，我想，因为AST是一种将语法结构化的数据结构。 而高级语言和机器语言是给人和机器去看的， 而中间语言是要被处理的。 而计算机处理一种信息最方便的方式就是将他结构化，对信息中的每一个最小单元进行定位。 而树状结构是层级的，方便与遍历token之间的关系，从而检查语法， 解析语义。 但是程序是用来执行的， 他是一种强逻辑性语言，没有歧义。 因此程序中每一条执行流都是明确的。 而如果要分析程序中的控制流， 和数据流等，AST这种结构就不太合适了。一个是因为，流分析往往是以基本块为单位的，基本块的最小单位是一条statement，而一条statement表示成AST树状结构很复杂， 也没有必要(这样就成了在树上画图，结构会很复杂，见属性图)。对于流分析，这种statement展开是没有必要的，而此时,AST也要向汇编码汇聚，所以我猜这样才出现了IR。</p>
<p>可以把软件分析分作两个阶段：1. Complie 阶段和2. Run-time阶段，在compile的分析都是静态阶段， 此时，程序还没有产生Activation Records。</p>
<h1 id="x01-流">0x01 流</h1>
<p>静态分析， 就是自动化的去分析程序的流。 我们常见的流有一个过程内的控制流和数据流，以及过程间的调用。这些流会在程序中构造一张张的图。 控制流图， 数据流图， 调用图， 类图...。每一张图对应一种不同的层级关系或者功能。有几点需要注意：</p>
<ol type="1">
<li><p>控制流图唯一，数据流图不唯一。 控制流图往往取决于AST结构。 AST结构定了，控制流图就定了(这里我觉得我可能 有误解)。而数据流图会对分析的目的不同而不同，可以正向构建也可以后向构建。只要目的达成， 就有意义。通常过程内的流图，叫做CFG, 而过程间的(加上Call Graph)的大流图，叫做ICFG</p></li>
<li><p>常见的数据流分析问题有reache definition, live variable和available expression。</p></li>
</ol>
<h1 id="x02-问题">0x02 问题</h1>
<h2 id="敏感问题">敏感问题</h2>
<p>其实有各种各样的敏感问题，就是指的静态分析不能cover所有情况而引起的误报。</p>
<h3 id="流敏感">流敏感</h3>
<p>流敏感， 指的是一个程序的执行流上，每条语句上相同的变量可能是不同的。 这是静态下所不能覆盖所有情况的(理论上)，比如一个变量初始化声明后被外部输入影响了，静态怎确定？所以纯静态只能做到相对的减少这些误报。实现流敏感一般是需要基于控制流图。</p>
<h3 id="路径敏感">路径敏感</h3>
<p>路径敏感，是指对执行流上的分支的， 程序实际会走那条路径，纯静态在理论上也是不能确定所有情况的。</p>
<h3 id="上下文敏感">上下文敏感</h3>
<p>上下文是过程间的调用， 一个过程被调用，在不同的调用点(call site)其返回值也不同。</p>
<h3 id="fieldindex-敏感">Field/Index 敏感</h3>
<p>一个复合数组， 在理论上是可以无穷维度的， 因此静态怎么去分析？ 传统的静态分析做法是， 将数组标识符看作一个变量， 而不考虑下标的影响。(静态分析解决此类问题也可以叫数组敏感哈(随便你怎么叫))</p>
<ul>
<li><p>field敏感问题:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Foo</span> <span class="variable">foo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Foo</span>();</span><br><span class="line">foo.ParamA = GetUserInput();</span><br><span class="line">foo.ParamB = String.Empty;</span><br><span class="line">            </span><br><span class="line">Execute(foo.ParamB);</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Foo</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> string ParamA;</span><br><span class="line">    <span class="keyword">public</span> string ParamB;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>source点，和sink点不是一个field</p></li>
<li><p>index敏感问题：</p></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">string [] myArray = <span class="keyword">new</span> <span class="title class_">string</span>[len];</span><br><span class="line">myArray[<span class="number">0</span>] = GetUserInput();</span><br><span class="line">myArray[<span class="number">1</span>] = String.Empty;</span><br><span class="line">Execute(myArray[<span class="number">1</span>]); </span><br></pre></td></tr></table></figure>
<p>数组敏感中可以看到user_input传到了索引0中，而执行的是下标1的元素。</p>
<h3 id="object-敏感">Object 敏感</h3>
<p>字段这种存储在object上的内容，他的生存周期不是一个函数栈， 因此他可以经由不同函数操作。实现字段敏感可使用安德森算法(流不敏感，上下文不敏感)先做个指针分析，找到每个object指针指向的内容(提高指针分析的精度对后续精度的提升目前来看可能不大)。</p>
<p>解决各种敏感问题，常见的思路，一个在每个program point 建立记录信息，这是静态思路。 还有就是动静结合的方式。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Foo</span> <span class="variable">foo1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Foo</span>();</span><br><span class="line">foo1.ParamA = GetUserInput();</span><br><span class="line"><span class="type">Foo</span> <span class="variable">foo2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Foo</span>();</span><br><span class="line">foo2.ParamA = String.Empty;</span><br><span class="line">Execute(foo2.ParamA); </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Foo</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> string ParamA;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="动态问题">动态问题</h2>
<h2 id="调用">调用</h2>
<p>一个数据被传到一个过程中，理论上， 是可以抛出去无限层的， 每一层的返回值都不一定包含原来的信息了。因此静态很难确定， 通常的做法也是去限定层数。</p>
<h2 id="循环问题">循环问题</h2>
<p>对于循环和递归，理论上，是可以有无限层的， 这也导致了，很难确定，一个变量的具体值。 对于循环，对于不同分析，需要不同考虑，比如污点分析， 可能不需要考虑回边情况。 因为循环的回边，如果没有因外的话，是回到了前必经节点，也就是说， 对信息流传播不会有影响，因为不会引入新的节点(至少我现在是这么想)。</p>
<p>对于递归，要做全程序分析，是不得不处理的，同循环一样，去掉自己到自己的调用边，还有的处理方式是， 在调用点建summary（啊呀具体我忘了，之后补充）。</p>
<h2 id="指针分析与动态特性">指针分析与动态特性</h2>
<p>这是大问题， 在java中，指针分析加反射就够受的了。 在脚本语言中， 还有各种动态特性(具体可以看RIPS14年NDSS那一篇built-in函数建模的)。这个， 再议～</p>
<h1 id="x03-web安全">0x03 web安全</h1>
<p>这一张的题目起的比较大，这里指的其实是信息流安全， 就是web中的信息流漏洞，如各种漏洞。通常静态使用污点分析的方式去做。</p>
<h2 id="数据流分析">数据流分析</h2>
<h2 id="前后向">前后向</h2>
<p>作为一种数据流分析，没有标准， 前向和后向流分析都可以。后向分析，有时候可以排除路径爆炸，但是后向很难知道数据边上具体传的是啥。</p>
<h2 id="算法">算法</h2>
<p>通常使用的是迭代数据流算法，即在控制流上对program point进行数据流推算，然后迭代收敛，到达不定点。</p>
<p>图可达性算法， 将数据流做成有向图结构，在图上作分析。[2002 Mohen]</p>
<h2 id="check">CHECK</h2>
<p>除了污点分析自身的各种敏感问题，和静态分析很难cover的复合结构和调用问题》 还有各种CHECK的检查问题。</p>
<p>在我看来， CHECK可以分为两大类： validation和sanitization。 validation就是通过分支，将不安全的输入引导一个敏感函数不可达的分支中。 而sanitization就是通过对用户输入变形， 从而让威胁失去意义。 sanitization通常有很多叫法，一般的，在输入端做的叫sanitization, 而在输入数据走完逻辑后输出的地方叫做escaping， 反正意思都是一样就是转译。</p>
<p>不论是validation还是sanitization都要有规则， 其中都可以用黑白名单实现。而sanitization中除了黑白名单规则，还可以进行编码，如htmlspecialchars, htmlenities，将敏感符号转义成html实体编码。</p>
<p>还有一种通常叫cast, 就是强制类型转换(int)$a。</p>
<p>以上是对数据流进行直接check， 还有间接check。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">  <span class="variable">$action</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;action&#x27;</span>];</span><br><span class="line"><span class="keyword">switch</span>(<span class="variable">$action</span>)</span><br><span class="line">  <span class="keyword">case</span> <span class="string">&quot;login&quot;</span>:</span><br><span class="line">					<span class="keyword">echo</span> <span class="variable">$action</span>;</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> <span class="string">&quot;logout&quot;</span>:</span><br><span class="line">					<span class="keyword">echo</span> <span class="variable">$action</span>;</span><br><span class="line">					<span class="keyword">break</span></span><br><span class="line">  <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>如这个简易的路由。 这时看起来并没有显示的安全检测， 但是其实是隐式的限制，数据是在一个指定的域里才可以进入危险分支。</p>
<p>再如，用户输入必须在数据库中存在， 才能进入危险分支， 这种在web非常常见。</p>
<p>最后就是一些用户身份验证， 和表单验证。 这些常常在路径中截断控制流。 因此我们做静态分析时，很难达到一个精准的状态。</p>
<h2 id="触发">触发</h2>
<p>静态分析到了漏洞， 不行，不一定能出发， 这也是很多扫描器和AGE工具比静态分析工具好使的原因。 在触发环节， 你可能要满足各种验证条件和访问顺序才能把控制流引过了， 且污点数据依旧有效，这具有很大的不确定性。</p>
<p>在web中，要达到这一点，需要考虑：</p>
<ol type="1">
<li>资源加载问题， 通常对于PHP这一种脚本语言， 加载代码是自动化的。 而且现在的代码通常是结构化mvc，实现自动化加载，总之。你要找到你的污点信息流在客户端的操作入口。需要分析路由(多入口web能相对简单一些)。</li>
<li>函数可达性， 确定资源被加载了， 就要进入该过程。</li>
<li>块可达性， 确定信息流入口的基本块是可达的。</li>
</ol>
<h3 id="reference">Reference</h3>
<p>https://medium.com/swlh/sensitivities-in-static-code-analysis-3cab7b07dea</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/03/17/static-sum/" data-id="cl1q2wli1001h47w52kz87r21" data-title="静态分析之殇" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-soundiness" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/02/02/soundiness/" class="article-date">
  <time class="dt-published" datetime="2021-02-02T00:37:44.000Z" itemprop="datePublished">2021-02-02</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/02/02/soundiness/">soundiness</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="x01-从soundness到soundiness">0x01 从soundness到soundiness</h1>
<blockquote>
<p>The typical reasons for such choices are engineering compromises: implementers of such tools are well aware of how they could handle complex language features soundly (e.g., by assuming that a complex language feature can exhibit any behavior), but do not do so because this would make the analysis unscalable or imprecise to the point of being useless. Therefore, the dominant practice is one of treating soundness as an engineering choice.[1]</p>
</blockquote>
<p>目前，所有的静态分析工具都希望他们的工具能覆盖所有的情况(soundness), but现在的程序结构越来越复杂...势必有很多问题，是当前静态分析技术无法解决的(称之为Hard Language Feature)。</p>
<p>首先， 我们来看什么是soundness</p>
<blockquote>
<h2 id="soundness">Soundness</h2>
<p>Conservative approximation: the analysis captures all program behaviors, or the analysis result all possible executions of the program.</p>
</blockquote>
<p>这里的Conservative其实就是Over, 可以看到理想的soundness理论上分析处出实际程序运行时所有的路径和情形。</p>
<p>然而，无论是当前学术界和工业界都无法达到soundness。但是这些文章或技术一般都不会说自己是unsoundness的，因为通常unsoundness是故意的忽略掉分析一些行为，以达到更高效率的目的。 而这一些技术是想soundness的，但是又无法达到理想的soundness，在这种情形下，这些文章就会产生一些误导。 如一些分析工具，文章说的很好， 但是实际用起来有很多的情况cover不了导致大量误报造成结果直接不可用...</p>
<p>在想sound，sound不了。我又不是unsound的，这种情况下，就产生了soundy分析的概念。15年提出[2]的，呼吁将这一类分析结果，是soundiness的。</p>
<figure>
<img src="https://penlab-1252869057.cos.ap-beijing.myqcloud.com/2022-03-31-043246.png" alt="truthiness" /><figcaption aria-hidden="true">truthiness</figcaption>
</figure>
<h1 id="x02-hard-language-features">0x02 hard language features</h1>
<p>几乎所有现代语言中，都有一些对于静态分析来比较hard 的点：</p>
<p><img src="https://penlab-1252869057.cos.ap-beijing.myqcloud.com/2022-03-31-043248.png" alt="image-20210202094033999" style="zoom: 50%;" /></p>
<h2 id="java-reflection">Java Reflection</h2>
<p>以反射为例：</p>
<p><img src="https://penlab-1252869057.cos.ap-beijing.myqcloud.com/2022-03-31-043251.png" alt="image-20210202094244020" style="zoom:20%;" /></p>
<p>反射的提出为了使得软件架构低耦合，高复用的目的。 如MVC框架中，框架要和web程序解耦，就需要通过反射去调用控制器中的方法，而不是改框架调用控制器。</p>
<p>在Java中， 反射使用的是对Class, method, field分别生成Metaobject, 然后使用这些metaobject来调用反射API接口来动态的达到静态调用效果。</p>
<p>反射是很重要的， 那么，如何静态分析呢？05年的APLAS提出了<code>String Constant analysis + Pointer Analysis</code>。</p>
<p>他们的工作， 他是通过字符串常量分析+指针分析去分析的。直观理解就是通过指针分析定位到每个metaobject的定义处，然后做字符串常量分析，去全文匹配到目标的位置。 但是问题是， 这种只能cover发射中的触发参数写在程序中的。 但是如果string value不存在， 何如？</p>
<blockquote>
<ul>
<li>Configuration files (配置文件输入)</li>
<li>Internet. (网络输入)</li>
<li>Command lines (命令行输入)</li>
<li>Complex string manipulations (复杂的字符串解析)</li>
<li>Dynamically generated (动态生成)</li>
<li>Encrypted (加密的，需要解码)</li>
</ul>
</blockquote>
<p>(插一句， 在静态安全分析中，字符串输入当作标识符真的是一大难题，感觉处理好了字符串输入，就能处理好许多静态安全问题)</p>
<p>(而我觉得目前来说，之所以大部分的漏洞都是通过手工和fuzz得到，就是因为静态分析不能cover许许多多问题)</p>
<p>这个工作的问题可以总结为： 名字不知道，啥也不知道。</p>
<p>在14年ECOOP, 南大李樾和谭添老师做了一个工作[4] (膜)，他们的方法 <code>Type Inference+String analysis+Pointer Analysis</code></p>
<p>他们的方法为：生时不可解， 用时亦可推。</p>
<p><img src="https://penlab-1252869057.cos.ap-beijing.myqcloud.com/2022-03-31-043313.png" alt="image-20210202113047743" style="zoom:20%;" /></p>
<p>通过反射使用点，结合java强大的类型系统，去推到这个方法的线索(如有几个参数， 这些参数是什么类型)[5]。</p>
<p>目前解决这些问题还是使用动态方式比较通用，如[6]去跑java的测试用例，得到的信息供给静态分析使用， 此类工作(Assisted by Dynamic Analysis)快，准。但是soundness做的不够好。</p>
<h2 id="native-code">Native Code</h2>
<p>Native Code 是另外一种hard analysis的情况。 核心就是一种跨语言的调用，如何去静态分析。</p>
<p><img src="https://penlab-1252869057.cos.ap-beijing.myqcloud.com/2022-03-31-043328.png" alt="image-20210202114600176" style="zoom:25%;" /></p>
<p>Java中提供了native关键字去声明调用JNI(Java Native Interface), 他是一套java调用底层平台c/c++功能的接口， 没有函数体。实现逻辑在c/c++中。这种机制能够使JVM同本地的动态链接库进行交互。</p>
<p><img src="https://penlab-1252869057.cos.ap-beijing.myqcloud.com/2022-03-31-043335.png" alt="image-20210202114857543" style="zoom:33%;" /></p>
<p>那么这种跨语言，如何去做程序分析呢？</p>
<p>现在通常分析器通常去进行手工建模(Manually models the critical native code)...</p>
<p><img src="https://penlab-1252869057.cos.ap-beijing.myqcloud.com/2022-03-31-043344.png" alt="image-20210202115838235" style="zoom:20%;" /></p>
<p>这里是对调用c/c++中的arraycopy进行手工建模成java逻辑， 然后转化为三地址码。</p>
<p>最近的工作[7] (ISSTA2020), 有直接在二进制上分析跨语言的调用。</p>
<h1 id="reference">reference</h1>
<p><a target="_blank" rel="noopener" href="http://soundiness.org/#Introduction">[1] http://soundiness.org/#Introduction</a></p>
<p><a target="_blank" rel="noopener" href="https://dl.acm.org/doi/10.1145/2644805">[2] https://dl.acm.org/doi/10.1145/2644805</a></p>
<p><a target="_blank" rel="noopener" href="https://www.semanticscholar.org/paper/Reflection-Analysis-for-Java-Livshits-Whaley/aa15b4f072b5d9f8f72b41b39c060ee5b5fb2807">[3] https://www.semanticscholar.org/paper/Reflection-Analysis-for-Java-Livshits-Whaley/aa15b4f072b5d9f8f72b41b39c060ee5b5fb2807</a></p>
<p><a target="_blank" rel="noopener" href="https://yuleisui.github.io/publications/ecoop14.pdf">[4] https://yuleisui.github.io/publications/ecoop14.pdf</a></p>
<p><a target="_blank" rel="noopener" href="https://www.semanticscholar.org/paper/Understanding-and-Analyzing-Java-Reflection-Li-Tan/3e358882af7a2e782fdb02c0ccf260f00728aff0">[5] https://www.semanticscholar.org/paper/Understanding-and-Analyzing-Java-Reflection-Li-Tan/3e358882af7a2e782fdb02c0ccf260f00728aff0</a></p>
<p><a target="_blank" rel="noopener" href="https://www.semanticscholar.org/paper/Taming-reflection%3A-Aiding-static-analysis-in-the-of-Bodden-Sewe/1753d3e97fdbe7799b9625cb873b77eef506a608">[6] https://www.semanticscholar.org/paper/Taming-reflection%3A-Aiding-static-analysis-in-the-of-Bodden-Sewe/1753d3e97fdbe7799b9625cb873b77eef506a608</a></p>
<p><a target="_blank" rel="noopener" href="https://www.semanticscholar.org/paper/Identifying-Java-calls-in-native-code-via-binary-Fourtounis-Triantafyllou/8da9ef89f6b211193e2376a7d289f6b087f7cb5c">[7] https://www.semanticscholar.org/paper/Identifying-Java-calls-in-native-code-via-binary-Fourtounis-Triantafyllou/8da9ef89f6b211193e2376a7d289f6b087f7cb5c</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/02/02/soundiness/" data-id="cl1q2wlhy001647w59bfo8mjv" data-title="soundiness" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-security" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/01/15/security/" class="article-date">
  <time class="dt-published" datetime="2021-01-15T01:14:26.000Z" itemprop="datePublished">2021-01-15</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/01/15/security/">安全性分析</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>这是我<del>最后一次</del>抄ppt了(认真脸)</p>
<h1 id="x01-安全">0x01 安全</h1>
<p>信息安全基本功，(完整性、保密性、可用性)...</p>
<p>首先讨论一个基本问题，什么是安全：</p>
<blockquote>
<p>Achieving some goals in the presence of adversaries</p>
<p>在有敌人的情况下仍要达到某个特殊目标</p>
</blockquote>
<p><img src="https://tva1.sinaimg.cn/large/008eGmZEgy1gmru5lf4ghj306006hq2u.jpg" /></p>
<p>在cyber世界， 我们的坏人不言而喻， 我们的目标保护我们的计算机系统在有坏人的情况下还能正常运行，而且数据不会泄露。</p>
<p><img src="debreach/image-20210118143612640.png" alt="image-20210118143612640" style="zoom:33%;" /></p>
<p><img src="https://penlab-1252869057.cos.ap-beijing.myqcloud.com/2022-03-31-045327.png" alt="image-20210118143702213" style="zoom:33%;" /></p>
<p>我们来关注注入问题和信息泄露问题，为啥呢？ 因为他们属于一大类问题： 信息流的问题。</p>
<h1 id="x02-信息流安全">0x02 信息流安全</h1>
<p><img src="debreach/image-20210118143903537.png" alt="image-20210118143903537" style="zoom:33%;" /></p>
<p>在一个wechat登录界面中， 密码是一个敏感信息， 合法的信息流动是将密码从客户端流到服务器(可信赖一方)。</p>
<p>如果敏感信息流到了怀仁手上，是我们不想要的。</p>
<p>如何保护保护信息呢？</p>
<p>最常用的手段是访问控制(Access Control), 应用程序需要有授权才能访问一个信息， 它关心的是信息任何被访问。 但是信息一旦被访问， 如何操作就不在其管辖范围。</p>
<p>而信息流安全(Information Flow Security), 会追踪信息的流动， 保证程序以安全的方式处理这些信息。 关注的是信息是如何传播的， 在端到端之间的信息流动中保证数据的安全。</p>
<p>所以说一个实际的信息系统，想要保护信息安全，就既要有访问控制机制，又要有信息流安全检查[1]。</p>
<h2 id="什么是信息流">什么是信息流</h2>
<blockquote>
<p>Information flow: if the information in variable x is transferred to variable y, then there is information flow x-&gt;y [2]</p>
</blockquote>
<p><img src="https://penlab-1252869057.cos.ap-beijing.myqcloud.com/2022-03-31-045337.png" alt="image-20210118145110826" style="zoom:33%;" /></p>
<p>信息载体(变量x)，传入了y, 这就是系统中的一个信息流动。</p>
<h2 id="信息流和security结合">信息流和Security结合</h2>
<p>要考虑信息流和安全结合起来， 需要考虑两点， 第一我们就要给信息流的载体，变量进行一个安全分级， 第二点我们需要在安全等级的基础上制定信息流动的策略。</p>
<h3 id="security-levels">Security Levels</h3>
<p>最简单说是将变量分为两级:</p>
<ol type="1">
<li><p>H, meaning <code>high</code> security, secret information (秘密信息)</p></li>
<li><p>L, meaning <code>low</code>security, public observable information (系统以外可已观测到的)</p>
<p><img src="debreach/image-20210118145706312.png" alt="image-20210118145706312" style="zoom: 50%;" /></p></li>
</ol>
<p>以上代码 broadcast(l)就是可以被广播出去的信息， h就是不能被信息系统之外不允许被观测到的。</p>
<p>这种安全等级可以抽象为格来表述的[3]。</p>
<p><img src="https://penlab-1252869057.cos.ap-beijing.myqcloud.com/2022-03-31-045349.png" alt="image-20210118150635775" style="zoom:67%;" /></p>
<p>格可以很复杂， 而且它可能不是线性上升的。</p>
<p><img src="debreach/image-20210118150709113.png" alt="image-20210118150709113" style="zoom:50%;" /></p>
<p>现在有了安全等级分类， 下一步就是制定策略</p>
<h3 id="information-flow-policy">Information Flow Policy</h3>
<p>信息流安全策略是限制这个信息流如何在不同安全等级中进行流动的。这里介绍一种不干涉策略(Noninterreference policy)[4]， 他的思想是：</p>
<blockquote>
<p>高安全等级的变量不能影响到信息流中地安全等级的变量。就是说你不能够在信息可观测的底安全等级变量中，观测到高安全等级信息。</p>
</blockquote>
<p><img src="https://penlab-1252869057.cos.ap-beijing.myqcloud.com/2022-03-31-045404.png" alt="image-20210118151455095" style="zoom: 50%;" /></p>
<p>嗯...</p>
<p><img src="debreach/image-20210118151610860.png" alt="image-20210118151610860" style="zoom:50%;" /></p>
<p>看这些例子， 总之，高密集变量不能赋值给地密级遍历中。</p>
<p><img src="debreach/image-20210118151657627.png" alt="image-20210118151657627" style="zoom:50%;" /></p>
<p>就是保证格上始终是按照边上升的</p>
<p><img src="debreach/image-20210118151733378.png" alt="image-20210118151733378" style="zoom:50%;" /></p>
<h1 id="x03-confidentiality保密性-and-integrity完整性">0x03 Confidentiality(保密性) and Integrity(完整性)</h1>
<p>从信息泄露的角度讲，需要阻止的信息流是从高到低， 但是完整性与保密性正好相反， 他要阻止的是从低安全流向高安全从而破坏高安全信息的完整性[5]。</p>
<p><img src="debreach/image-20210118152255244.png" alt="image-20210118152255244" style="zoom:50%;" /></p>
<p>完整性涵盖了一大类漏洞，如注入漏洞, 注入漏洞...还是注入漏洞。</p>
<p><img src="debreach/image-20210118152448073.png" alt="image-20210118152448073" style="zoom:50%;" /></p>
<p>从而可见， 保密性和完整性是信息流安全中的一体两面。 如此， 我们可以用一种手段解决这两种问题。</p>
<h2 id="扩展安全性概念">扩展安全性概念</h2>
<p>完整性要保证数据在信息系统中的准确性(accuracy)、完全性(completeness)、一致性(consistency)</p>
<ul>
<li><p>Accuracy</p>
<p>可信的关键数据应该不被污染(操作才能正常， 如信息流安全中的各种注入)</p></li>
<li><p>Completeness</p>
<p>数据库应该存储所有完整的数据</p></li>
<li><p>Consistency</p>
<p>文件传输系统发送方和接收方内容必须一致。</p></li>
</ul>
<p>完整性需要保证整个系统运行是正确的。</p>
<h1 id="x04-显式流explicit-flows和隐藏信道covert-channels">0x04 显式流(Explicit Flows)和隐藏信道(Covert Channels)</h1>
<p>该部分讨论了信息流中，信息的传播方式，所有的流都是显示传播的吗(沿数据流图传播)。 当然还有侧信道(隐藏信道)或者隐式流。</p>
<figure>
<img src="https://penlab-1252869057.cos.ap-beijing.myqcloud.com/2022-03-31-045431.png" alt="image-20210118153545945" /><figcaption aria-hidden="true">image-20210118153545945</figcaption>
</figure>
<p>控制流可以被敏感信息影响， 通过控制流的方式去泄漏信息。</p>
<p><img src="https://penlab-1252869057.cos.ap-beijing.myqcloud.com/2022-03-31-045440.png" alt="image-20210118160246443" style="zoom:50%;" /></p>
<p>以上例子是一些隐藏信道[6]。</p>
<ul>
<li><p>Implicit flows: 隐式流， 不是为了传递信息，仍然能够利用控制信息传递出敏感信息。</p></li>
<li><p>Termination channels： 终止信息， 通过程序是否终止传递敏感信息</p></li>
<li><p>Timing channels: 时间通道，根据运行时间的区别，获得隐藏信息</p></li>
<li><p>Exceptions: 通过异常泄露数据</p>
<p>...</p></li>
<li><p><img src="https://penlab-1252869057.cos.ap-beijing.myqcloud.com/2022-03-31-045448.png" alt="image-20210118160625484" style="zoom:50%;" /></p></li>
</ul>
<p>虽然隐式流比较难以发现， 但是隐藏信道泄露出的数据往往是有限的。</p>
<h1 id="x05-taint-analysis">0x05 Taint Analysis</h1>
<p>污点分析是目前大量使用的信息流安全问题的分析方法。</p>
<p>思路：将数据分为两类， 其中将关注的一类数据打上标记，关注这些数据的传播。</p>
<h2 id="source">source</h2>
<p>污点数据的源头， 污点数据的来源往往是某些特定方法的返回值。</p>
<h2 id="sink">sink</h2>
<p>污点分析关心的是，从source打上标记的污点数据，是否会流向特殊的sink。</p>
<figure>
<img src="https://penlab-1252869057.cos.ap-beijing.myqcloud.com/2022-03-31-045450.png" alt="image-20210118161205249" /><figcaption aria-hidden="true">image-20210118161205249</figcaption>
</figure>
<p>两个例子：</p>
<p><img src="https://penlab-1252869057.cos.ap-beijing.myqcloud.com/2022-03-31-045553.png" alt="image-20210118161501315" style="zoom:50%;" /></p>
<h2 id="taint-and-pointer-analysis-together">Taint and Pointer Analysis, Together</h2>
<p>2017年的P/Taint论文正式提出要将指针分析和污点分析结合起来[7]。</p>
<p>污点分析本质上是追踪程序中的污点数据， 而指针分析的本质上是跟踪程序中的抽象对象如何在程序中流动。</p>
<p>那么我们就可以看作一类问题：</p>
<ul>
<li>Treat tainted data as (artificial) objects ---&gt; 将污点数据看作一类特殊的object</li>
<li>Treats source as allocation sites(of tainted data) ---&gt; 将source看作是敏感数据的allocation site</li>
<li>Leverages pointer analysis to propagate tainted data. ----&gt; 借助指针分析追踪污点数据</li>
</ul>
<p>那么通过上下文不敏感指针分析为例，来改造成一个污点分析。</p>
<h2 id="define">Define</h2>
<ol type="1">
<li><p>Domain:</p>
<p><img src="https://penlab-1252869057.cos.ap-beijing.myqcloud.com/2022-03-31-045501.png" alt="image-20210118162349114" style="zoom:50%;" /></p></li>
</ol>
<p>在指针分析的Domain(varibales, Fields, Objects)的基础上加入一类Tainted data。 （ti表示来自于程序中call site i中的数据）</p>
<p>(可以右边图中看到原先指针分析中的All objects(堆上的object), 现在分为两类，tainted data也看作一个T字头的objects。。。)</p>
<ol start="2" type="1">
<li><p>Inputs:</p>
<ul>
<li><p>Source: 一类方法关注他的return</p></li>
<li><p>Sink: 另一类方法， 关注他的参数中是否传入了taint</p></li>
</ul></li>
<li><p>Outputs:</p>
<ul>
<li>TaintFlows: 输出一个集合， 元素是&lt;ti, m&gt;这个pairs, 表示在call site i处会有一个污点数据t,将流到sink方法m当中。</li>
</ul></li>
</ol>
<h2 id="rules">Rules</h2>
<p>污点分析借助指针分析做的，</p>
<h1 id="x06-使用datalog实现污点分析操作">0x06 使用Datalog实现污点分析操作</h1>
<h2 id="datalog">Datalog</h2>
<p><img src="https://penlab-1252869057.cos.ap-beijing.myqcloud.com/2022-03-31-045547.png" alt="image-20210126115602820" style="zoom:50%;" /></p>
<p>简单说一下Datalog是一门逻辑声明式编程语言，他的操作元素是一系列的谓词(predicate)，为此中是一个一个的fact。最初输入的谓词叫做EDB, 而推出来的是IDB。而对于谓词逻辑推导叫做Rules，Rules左边是头部，通过一个一个的原子操作(包含relational和arithmetic)复合逻辑运算(逗号是与，还有或非)得到头部(头部可以是多个谓词)。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">//  symbol declare</span><br><span class="line">.type P &lt;: symbol</span><br><span class="line">.type A &lt;: number</span><br><span class="line"></span><br><span class="line">// EDB predict</span><br><span class="line">.decl Age(person: P, age: A)</span><br><span class="line"></span><br><span class="line">// facts</span><br><span class="line">Age(&quot;Xiaoming&quot;, 18).</span><br><span class="line">Age(&quot;Xiaohong&quot;, 23).</span><br><span class="line">Age(&quot;Alan&quot;, 16).</span><br><span class="line">Age(&quot;Abao&quot;, 31).</span><br><span class="line"></span><br><span class="line">// IDB predict</span><br><span class="line">.decl Audlt(person: P, age: A) output</span><br><span class="line"></span><br><span class="line">// rules</span><br><span class="line">Audlt(person, age) :- Age(person, age), age&gt;=18.</span><br></pre></td></tr></table></figure>
<p>上文就是使用souffle实现的图示的datalog关系，可以看到灰常的直观，那么他的输出IDB为：</p>
<p><img src="https://penlab-1252869057.cos.ap-beijing.myqcloud.com/2022-03-31-045511.png" alt="image-20210126120329197" style="zoom:50%;" /></p>
<p>以为datalog支持谓词推出自己的facts(递归)， 因此支持很多复杂的操作， 如指针分析：</p>
<p><img src="https://penlab-1252869057.cos.ap-beijing.myqcloud.com/2022-03-31-045538.png" alt="image-20210126120426056" style="zoom: 33%;" /></p>
<p>如上是一个简单的过程内指针分析, 它的推导出的内容：</p>
<p><img src="https://penlab-1252869057.cos.ap-beijing.myqcloud.com/2022-03-31-045531.png" alt="image-20210126120514215" style="zoom:33%;" /></p>
<p><img src="https://penlab-1252869057.cos.ap-beijing.myqcloud.com/2022-03-31-045534.png" alt="image-20210126120520304" style="zoom:50%;" /></p>
<p>看和表中是一毛一样。</p>
<p>然后再演示一个过程间的：</p>
<p><img src="https://penlab-1252869057.cos.ap-beijing.myqcloud.com/2022-03-31-045619.png" alt="image-20210126141708850" style="zoom:50%;" /></p>
<p>目标代码中，为了处理第五行里的call, 需要4个东西：</p>
<ol type="1">
<li><p>Dispatch：</p>
<p>EDB需要增加</p>
<ul>
<li>VCall(l:S, x:V, k:M) 记录l点的call方法k, x接收</li>
<li>Dispatch(o:O, k:M, m:M) 记录Dispatch到的方法</li>
<li>ThisVar(m:M, this:V) 记录方法中的this</li>
</ul>
<p>IDB需要增加</p>
<ul>
<li>CallGraph(l:S, m:M), l点的call</li>
<li>Reachable(m:M), 记录可达方法</li>
</ul></li>
<li><p>传参数</p>
<p>EDB增加：</p>
<ul>
<li>Argument(l:S, i:N, a:V), l点的调用的实参列表</li>
<li>Parameter(m:M, i:N, p:V), 形参列表</li>
</ul></li>
<li><p>传返回值</p>
<p>EDB增加:</p>
<p>MethodReturn(m:M, ret:V), 方法的return</p>
<p>CallReturn(l:S, r:V), 接受返回值</p>
<p><img src="https://penlab-1252869057.cos.ap-beijing.myqcloud.com/2022-03-31-045623.png" alt="image-20210126170849123" style="zoom: 33%;" /></p></li>
</ol>
<p>污点分析还需要改点。</p>
<p><img src="https://penlab-1252869057.cos.ap-beijing.myqcloud.com/2022-03-31-045647.png" alt="image-20210126171038704" style="zoom:25%;" /></p>
<p><img src="https://penlab-1252869057.cos.ap-beijing.myqcloud.com/2022-03-31-045655.png" alt="image-20210126171054264" style="zoom: 33%;" /></p>
<h1 id="reference">reference</h1>
<p>[1] A practical system needs both access and flow control to satisfy all security requirements. -- D.Denning, 1976</p>
<p>[2] Dorothy E.Denning and Peter J.Denning, "Certification of Programs for Secure Information Flow". CACM 1977</p>
<p>[3] Dorothy E.Denning, "A Lattice Model of Secure Information Flow". CACM 1976</p>
<p>[4] J.A. Goguen and J.Meseguer, "Security policies and security models". S&amp;P 1982</p>
<p>[5] Ken Biba, “<em>Integrity Considerations for Secure Computer Systems</em>”. Technical Report, ESD-TR-76-372, USAF Electronic Systems Division, Bed-ford, MA, 1977.</p>
<p>[6] <em>Butler W. Lampson, “</em>A Note on the Confinement Problem*”. CACM 1973.</p>
<p>[7] <em>Neville Grech and Yannis Smaragdakis, “</em>P/Taint: Unified Points-to and Taint Analysis*”. OOPSLA 2017.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/01/15/security/" data-id="cl1q2wlhx001547w53xc58s26" data-title="安全性分析" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-cha" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/01/02/cha/" class="article-date">
  <time class="dt-published" datetime="2021-01-01T23:01:39.000Z" itemprop="datePublished">2021-01-02</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/01/02/cha/">CHA</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>资料： https://www.bilibili.com/video/BV1GQ4y1T7zm?from=search&amp;seid=7528278619420042576</p>
<blockquote>
<p>01:30 Motivation</p>
<p>04:40 Call Graph Construction(CHA)</p>
<p>65:40 Interprocedural Control-Flow Graph</p>
<p>71:45 Interprocedural Data-Flow Analysis</p>
</blockquote>
<h1 id="problem-of-intraprocedural-analysis">Problem of Intraprocedural Analysis</h1>
<p>过程内的常量传播过于保守， 造成结果的不准确</p>
<p><img src="https://penlab-1252869057.cos.ap-beijing.myqcloud.com/2022-03-31-043605.png" alt="image-20210102095211276" style="zoom:40%;" /></p>
<p>如上所示，对于一个常量传播:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">foo</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> ten();  <span class="comment">// 返回一个常量10</span></span><br><span class="line">  addOne(<span class="number">42</span>); <span class="comment">// 传出一个常量42</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">ten</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">10</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">addOne</span><span class="params">(<span class="type">int</span> x)</span> &#123;</span><br><span class="line">  <span class="type">int</span> <span class="variable">y</span> <span class="operator">=</span> x + <span class="number">1</span>;  <span class="comment">// y值本程序中是确定的，但是只做过程内分析是不确定的。</span></span><br><span class="line">  <span class="keyword">return</span> y;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>涉及到过程间方法调用的元素： 1. Call site(实参) 2. function decl(形参) 。</p>
<p>实际上，在分析foo的时候n就是10, 在分析addOne的时候x就是42,y就是43，但是过程内分析的时候，是不知道过程外的信息的，因此这里就是NAC。</p>
<p>在传统的过程内分析中，都是保守的假设(safe-approximation)。</p>
<p><img src="https://penlab-1252869057.cos.ap-beijing.myqcloud.com/2022-03-31-043608.png" alt="image-20210102095421699" style="zoom:40%;" /></p>
<p>在过程间分析时，作为caller, foo就可以通过return边得到n的值。</p>
<p>作为callee, addOne就可以通过call边得到x和y的值。(caller得return, callee得实参)。</p>
<p>这样就可以弥补过程内数据流分析过度假设造成精度的丢失。</p>
<p>做过程间分析需要的信息有：</p>
<ol type="1">
<li>构造call graph</li>
<li>根据call graph，构造ICFG（过程间控制流图）</li>
<li>IDFG（过程间数据流分析）</li>
</ol>
<h1 id="call-graph">Call Graph</h1>
<p>为了过程间分析， 引入了call graph。</p>
<p><img src="https://penlab-1252869057.cos.ap-beijing.myqcloud.com/2022-03-31-043620.png" alt="image-20210102100152715" style="zoom:20%;" /></p>
<blockquote>
<p>本图foo函数作为caller，call了bar和baz, bar又调用了baz。</p>
</blockquote>
<p>重要程度不言而喻（要有过程间的控制流边，就先要建立call graph边那(所有跨函数分析的基础)）</p>
<h2 id="构造cg">构造CG</h2>
<p><img src="https://penlab-1252869057.cos.ap-beijing.myqcloud.com/2022-03-31-043623.png" alt="image-20210102100255628" style="zoom:30%;" /></p>
<p>蓝色为精度指标， 绿色为速度指标。 这里介绍CHA。</p>
<p>首先看下java中函数调用方法。</p>
<p><img src="https://penlab-1252869057.cos.ap-beijing.myqcloud.com/2022-03-31-043628.png" alt="image-20210102100409591" style="zoom:30%;" /></p>
<ul>
<li>static call: 静态调用（有点像非oo的function call）</li>
<li>Special call:
<ul>
<li>如：</li>
<li><ol type="1">
<li>调用构造函数</li>
<li>调用类自己的私有的实例方法</li>
<li>调用父类中的实例方法</li>
</ol></li>
</ul></li>
<li>Virtual call: 其他调用实例方法(大部分的oo调用，用来实现__多态__特性)</li>
</ul>
<p>static call和special call的目标方法只有一个， 比较好处理的。 关键是处理virtual call。</p>
<p>在程序中，某一个程序点在其运行时Receiving objects的不同，可能调用不同的目标方法，所以由于__多态__的原因(polymorphism), 一个virtual call在运行期间调用的method可能是__大于一个__的(<code>运行时才能决定，取决于运行时的具体reciving object</code>)。</p>
<blockquote>
<p>所以对于OO语言， 如何处理virtual call 是构造call graph的关键所在</p>
</blockquote>
<h2 id="method-dispatch-of-virtual-calls">Method Dispatch of Virtual Calls</h2>
<p>在处理virtual call中， 一个关键的步骤就是<code>method dispatch</code>。</p>
<p>__Dispatch__在过程间分析中比较重要的一个概念。</p>
<p><img src="https://penlab-1252869057.cos.ap-beijing.myqcloud.com/2022-03-31-043639.png" alt="image-20210102101028005" style="zoom:30%;" /></p>
<p>在程序运行时， call site调用 virtual call, 要去解这个方法需要两个关键：</p>
<ol type="1">
<li>Receiver object 的具体类型。（右边例子里变量o指向的对象的具体类型）</li>
<li>Call site处方法的具体签名。(右边的例子里为foo(...))</li>
</ol>
<p>动态的时候去求解这个virtual call的过程也叫做<code>method dispatch</code></p>
<p>通过一个signature可以确定唯一的一个方法：</p>
<p><img src="https://penlab-1252869057.cos.ap-beijing.myqcloud.com/2022-03-31-043644.png" alt="image-20210102102131163" style="zoom:20%;" /></p>
<ul>
<li>Class type: 类名</li>
<li>Method name: 方法名</li>
<li>Descriptor： 由两部分构成： 1.返回值类型 2. 参数类型</li>
</ul>
<p><img src="https://penlab-1252869057.cos.ap-beijing.myqcloud.com/2022-03-31-043658.png" alt="image-20210102102936695" style="zoom:25%;" /></p>
<p>定义一个函数Dispatch， 这个函数模拟了动态时dispatch一个virtual call的具体过程。他的输入就是c(receiver object 的类型)， m(call si te这一点方法的签名)。</p>
<p>dispatch函数的目的是找到一个能够被调用的方法， 必须是一个具体的有方法体的方法，所以返回的必须是一个非抽象的方法。</p>
<ol type="1">
<li><p>首先在c类中找是否有这样一个非抽象方法m',</p></li>
<li><p>如果c没有，就去找c的所有父类c'(注意，是找父类)，直到找到目标方法m'。</p></li>
</ol>
<p><img src="https://penlab-1252869057.cos.ap-beijing.myqcloud.com/2022-03-31-043701.png" alt="image-20210102103447307" style="zoom:33%;" /></p>
<p>这个例子中有ABC三个类，如果dispatch中x.foo()这个call site的两个元素：1. x: receiver object的具体类型是 B(因为它指向 new B()这个类), 2. Foo()这个call site的签名： &lt;B: void foo() &gt; 。所以首先回到B类中进行dispatch, B类中没有foo方法， 就去父类A中去找。</p>
<p>y.foo()中就是C的foo方法, 因为他的dispatch函数中，c是receiver object 指向的new C() 类型， 而且内部有一个foo方法供m匹配上。</p>
<h1 id="chaclass-hierarchy-analysis">CHA(Class Hierarchy Analysis)</h1>
<h2 id="dispatch">Dispatch</h2>
<p><img src="https://penlab-1252869057.cos.ap-beijing.myqcloud.com/2022-03-31-043711.png" alt="image-20210102105706369" style="zoom:25%;" /></p>
<p>CHA是用来解整个程序call graph的一方法， 他需要知道整个程序的class以及继承信息。 核心思想是对于一个virtual call， 基于这个virtual call的声明类型(不是recevier的具体类型)，以及receiver variable a。</p>
<p><img src="https://penlab-1252869057.cos.ap-beijing.myqcloud.com/2022-03-31-043718.png" alt="image-20210102110314592" style="zoom:25%;" /></p>
<p>核心思想是给定一个receiver variable a, 他可能会指向他的类型下的所有子类型(即本身)。</p>
<p>来看CHA的算法：</p>
<p><img src="https://penlab-1252869057.cos.ap-beijing.myqcloud.com/2022-03-31-043722.png" alt="image-20210103195541252" style="zoom:25%;" /></p>
<p>CS： call site, 即调用点</p>
<p>T: target methods，返回的目标方法</p>
<p>m: 目标方法的签名</p>
<p>有三个分支， 分别处理<code>static call</code>, <code>special call</code>和<code>virtual call</code></p>
<ol type="1">
<li><p>static call: 静态调用直接放入</p></li>
<li><p>Special call: special call有三种： 父类方法(super), 构造方法和似有方法</p>
<p>其中父类方法比较特殊，需要Dispatch(cm,m) cm指的是方法m的类型(不是声明类型，A c = new C(), 从C类找)。</p></li>
<li><p>Virtual call:</p>
<p><img src="https://penlab-1252869057.cos.ap-beijing.myqcloud.com/2022-03-31-043730.png" alt="image-20210103200229662" style="zoom:25%;" /></p></li>
</ol>
<p>注意这里不是唯一的了， 所以使add 目标调用点的声明类型开始找所有符合方法签名m的本类或子类中的c'。</p>
<p><img src="https://penlab-1252869057.cos.ap-beijing.myqcloud.com/2022-03-31-043736.png" alt="image-20210103200405069" style="zoom:25%;" /></p>
<p>注意三点：</p>
<ol type="1">
<li>从本类以及子类中找所有的foo方法</li>
<li>其中包含dispatch, 如果本类中没有foo, 回望父类中找，因此Resolve(b.foo())中B无foo(),因此dispatch到了A.foo()。</li>
<li>和new B()无关(尽管new B()中不能调c.foo(), d.foo())，还是根据variable b的声明类(即B类)去找。</li>
</ol>
<h2 id="通过cha构建call-graph">通过CHA构建Call Graph</h2>
<p><img src="https://penlab-1252869057.cos.ap-beijing.myqcloud.com/2022-03-31-043743.png" alt="image-20210103201000619" style="zoom:25%;" /></p>
<p>从入口方法开始，没遇到一个可达方法，去解目标方法，得到新的方法后，再去解新的方法的可达方法。。。知道算法停止，得到call grap:</p>
<p><img src="https://penlab-1252869057.cos.ap-beijing.myqcloud.com/2022-03-31-043749.png" alt="image-20210103201150287" style="zoom:25%;" /></p>
<p>三个数据结构：</p>
<ul>
<li>WL: worklist , 需要被处理的目标方法， 开始只有入口方法。</li>
<li>CG: Call graph, 存调用变。</li>
<li>RM: 可达方法，一个方法进入RM说明已经分析过了。</li>
</ul>
<p>算法：</p>
<p>一个大的While循环。以起初main方法为例，首先将main方法从worklist中取出来，如果main方法不在RM中说明没有分析过， 进入call graph分析过程， 从main方法中找到所有的call site, 对每一个call site进行单个call site结点的CHA resolve(cs)得到该call site所有可能的target method, 对于每一个target method m', 将其在call graph中与main方法中对应的call site相连(cs-&gt;m'), 并将这些target method标记为可达method(add m' to WL), 此时main方法加入到RM里了，之后不会再被重复分析。(每次分析的目标方法:remove m from WL, add m to RM)。</p>
<p><img src="https://penlab-1252869057.cos.ap-beijing.myqcloud.com/2022-03-31-043754.png" alt="image-20210103202612835" style="zoom:25%;" /></p>
<p>虚线是call graph其中C.m()并无调用关系。 此时WL=[]，构造完成，其中橙色的是每一个需要分析的method, 从中去找每一个call site（如B.bar()这个函数体为空，因此无任何call site), 找到所有call site, 对每个call site进行CHA 的resolve，得到调用边放入(cg，即虚线关系)，新增加的method放入WL（如果和RM重复就不分析了，因为已经分析过了）。</p>
<h1 id="interprocedural-contrl-flow-graph">Interprocedural Contrl-Flow Graph</h1>
<p><img src="https://penlab-1252869057.cos.ap-beijing.myqcloud.com/2022-03-31-043759.png" alt="image-20210103203046532" style="zoom:25%;" /></p>
<p>ICFG就是在过程内的CFG的过程加上一堆call site的调用边和返回边连接起来。</p>
<p><img src="https://penlab-1252869057.cos.ap-beijing.myqcloud.com/2022-03-31-043807.png" alt="image-20210103203135345" style="zoom:25%;" /></p>
<p><img src="https://penlab-1252869057.cos.ap-beijing.myqcloud.com/2022-03-31-043811.png" alt="image-20210103210513165" style="zoom:25%;" /></p>
<h1 id="interprocedural-data-flow-graph">Interprocedural Data-Flow Graph</h1>
<p>在ICFG的基础上进行常量传播为例</p>
<p><img src="https://penlab-1252869057.cos.ap-beijing.myqcloud.com/2022-03-31-043822.png" alt="image-20210103210615560" style="zoom:25%;" /></p>
<p>这里的转移函数除了node上的， 还需要加上边上的x=val(a)的参数传递以及b=val(y)的return传递，而加上那一条实现边(黄色标注)是为了传播a中的常量，如果没有这条边a的内容就会从过程外传到c=b-3这很不科学。</p>
<p><img src="https://penlab-1252869057.cos.ap-beijing.myqcloud.com/2022-03-31-043829.png" alt="image-20210103211000777" style="zoom:25%;" /></p>
<p>还有一点要注意就是，如下b=ten()需要把b从过程内的常量传播中移除，这样b=10传到下一条stmt，不然b=7传下来的话就是NAC。</p>
<p>O了。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/01/02/cha/" data-id="cl1q2wlhp000j47w53kefeihg" data-title="CHA" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-loops" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/12/06/loops/" class="article-date">
  <time class="dt-published" datetime="2020-12-06T01:07:21.000Z" itemprop="datePublished">2020-12-06</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/12/06/loops/">程序分析之Loops in Flow Graphs</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>此文为编译原理(龙书)9.6章， 补充南大重续分析第6节之后。</p>
<h1 id="支配结点">1. 支配结点</h1>
<h2 id="定义">定义</h2>
<h3 id="支配结点-1">支配结点</h3>
<p>Dominators, 即支配结点， 如果从一段程序的entry point 到结点n的所有路径， 都经过结点m，那么我们就可以说m支配n，<code>记为 m dom n</code></p>
<p>支配结点性质：</p>
<ul>
<li>reflexive: a dom a （每个结点支配本身，不过为了区分的本身的支配结点也可以叫strict dom）</li>
<li>transitive: a dom b and b dom c =&gt; a dom c (具有传递性)</li>
<li>antisymmetric: a dom b and b dom a =&gt; a==b</li>
</ul>
<h3 id="直接支配结点">直接支配结点</h3>
<p>此外， 在到达一个结点的支配路径上的最后一个结点，记为<code>直接支配结点（immediate dominator）</code>， 如果一个结点记为n，他的直接支配结点记为m<code>(m idom n)</code>。在n的支配路径上，当支配结点不是自身时，支配节点d一定也支配m。</p>
<p>为啥要强调直接支配呢？要看我们表示流图中支配关系的数据结构： 支配树</p>
<h3 id="支配树">支配树</h3>
<p>首先，手工来找每一个支配结点的支配对象。此处我们的入口结点是1号结点， 我们可以看到，1号结点支配所有结点， 而2号结点在1号结点的分支上，下层所有结点都可以从3号结点到达， 因此2号结点仅支配它自身(任何结点都支配自身)。 如图，以此类推。如此生成一颗支配结点树。</p>
<p><img src="https://penlab-1252869057.cos.ap-beijing.myqcloud.com/2022-03-30-125517.png" alt="image-20201208181751573 " style="zoom:20%;" /></p>
<p>这颗树上，入口为程序根结点，每个结点支配它的后代结点：</p>
<p><img src="https://penlab-1252869057.cos.ap-beijing.myqcloud.com/2022-03-30-125520.png" alt="image-20201208182015843 " style="zoom:30%;" /></p>
<p>生成树的性质：</p>
<ul>
<li><p>顶点： 程序入口点</p></li>
<li><p>边： 直接支配结点</p></li>
<li><p>路径： 所有支配路径</p></li>
</ul>
<h2 id="支配路径分析算法">支配路径分析算法</h2>
<p>要设计一个算法，来求出一段程序中每个结点的支配路径。 那么整个算法的思想如下：</p>
<blockquote>
<p>如果p1,p2,p3....pk是结点n的所有前驱， 并且d不等于n, 那么当且仅当每个d dom pi时(pi为每个p)，d dom n。</p>
</blockquote>
<p>也就是说，n的一个前驱结点如果要是称为n的支配结点d，那么必须支配到达n点的所有前驱。因此他表示成的数据结构也就是一棵树(回溯祖先只有一条路经)。</p>
<p>比如上面的程序流图中，4到8点之间有5，6，7三个点， 4号结点同时支配5,6,7,因此4号结点支配8号结点；而5号结点到8号结点之间有7号结点， 5号结点并不支配7号结点(他只支配本身)， 因此5号结点并不能支配8号结点。</p>
<p>好算法原理介绍完了，接下来我们设计这个程序分析。</p>
<p><img src="https://penlab-1252869057.cos.ap-beijing.myqcloud.com/2022-03-30-125523.png" alt="截屏2020-05-17 下午9.56.10 " style="zoom:80%;" /></p>
<p>对照这张表，分析次算法。</p>
<ul>
<li><p>Domain: 基于抽象的数据集， 应该选择所有点</p></li>
<li><p>Direction: 求每个程序点的支配路径，Forwards更直观</p></li>
<li><p>May/Must: 为了保证我们的分析结果safe，那么这应该是一个must-approximation，以确保支配路径的唯一性。</p></li>
<li><p>Boundary: 边界条件，由于是前向的，Must分析， 那么程序的边界应该是OUT[entry]， 从上到下，而初始应该不是空集，而是本结点为支配结点(入口结点是所有结点的支配结点)，即OUT[entry] = {entry}</p></li>
<li><p>Initialization: 因为Meet是交运算，每个程序结点的初始化应该是所有路径OUT[B]=N(假设所有结点都是他的支配结点)</p></li>
<li><p>Transfer funciton: 每个基本块内的转移函数，因为是前向分析，所以转移函数应该IN[B]union上本身{B}。F(x) = xU{B}</p></li>
<li><p>在merge处(程序数据的合并点)我们取交集。</p></li>
</ul>
<p><img src="https://penlab-1252869057.cos.ap-beijing.myqcloud.com/2022-03-30-125527.png" alt="image-20201206101945309 " style="zoom:67%;" /></p>
<p>这个算法的Transfer function和之前的-kill +gen的不同， 需要注意。</p>
<p>拿来那张Must分析的图：</p>
<p><img src="https://penlab-1252869057.cos.ap-beijing.myqcloud.com/2022-03-30-125530.png" alt="截屏2020-08-13 上午8.54.34 " style="zoom:67%;" /></p>
<p>初始时所有前驱点都是支配结点，然后将这个集合不断缩小知道最大不动点，求最大下界。</p>
<p>因此我们的Iterative Algorithm有：</p>
<p><img src="https://penlab-1252869057.cos.ap-beijing.myqcloud.com/2022-03-30-125533.png" alt="image-20201206102844236 " style="zoom:50%;" /></p>
<p>来看具体的例子：</p>
<p><img src="https://penlab-1252869057.cos.ap-beijing.myqcloud.com/2022-03-30-125536.png" alt="image-20201206104654556 " style="zoom:50%;" /></p>
<p>D(n)是所有结点的支配结点的集合。</p>
<p>D(1)是入口结点， 支配结点就是它本身。</p>
<p>D(2)中的转移函数回吧IN[B]即D(1)union上自身{2} =&gt; {1,2}</p>
<p>D(3)同理， 转移函数{3}unionIN[B]，这里的IN[B]是有四条边， 根据merge取并集，我们有D(1)nD(2)nD(4)nD(8)因为4，8没有分析，所以他们的OUT[B]都是初始值，所有点。因此D3 = {1,3}。</p>
<p>停止条件：</p>
<p>因为我们的OUT[B]=IN[B]union本身，我们看第一次迭代后，其实已经达到了不动点。比如D(3)在第二次迭代时，D(1)是恒不变的，D(2)就是不变的。此时D(4) = {1,3,4}, D(8) = {1,3,4,7,8} 他们的并集一定是小于等于4的结点集合,即{1,3,4}，而只要有前驱1,2在，那么支配结点的并集就一定是小于3的。(不考虑环路)</p>
<p>如果不考虑环路了， 那么在无环图上，根据支配结点的性质， <code>除了入口结点，每一个结点都有唯一的直接支配结点</code>。再比如4号结点，有3和7两个入边，要证明停止， 我们就要证明7号的支配结点一定包含{1,3}而不会再包含2，那么算法就停止了。也就是说只计算一次，路径中的所有支配结点都出现了，不会再添加其他的了。如果再添加了2，即{1,2,3}那么程序中到达4就会有两条路经，1，3，4和1，2，3，4。</p>
<p>如此一来， 算法变成了：</p>
<p><img src="https://penlab-1252869057.cos.ap-beijing.myqcloud.com/2022-03-30-125539.png" alt="image-20201206113136795 " style="zoom:50%;" /></p>
<p>没有了while循环。</p>
<h1 id="深度优先生成树">2. 深度优先生成树</h1>
<p>我们需要分析循环XD，现在，我们根据支配路径分析算法， 得到了生成树，也就是说得到了流图上每一个点的支配路径信息。而实际控制流图所走的路径中间夹杂着支配结点之外的结点。此外，要在流图中刻画循环，我们需要知道流图中什么时候前进，什么时候回退了。这些信息需要生成一个深度优先生成树来提供。</p>
<p><img src="https://penlab-1252869057.cos.ap-beijing.myqcloud.com/2022-03-30-125542.png" alt="image-20201207105042417 " style="zoom:70%;" /></p>
<p>要在流图上进行深度优先搜索所得到的序列: 1,2,3,4,5,6,7,8,9,10 。我们可以生成深度优先生成树， 这棵树的后序遍历序列(10,9,8,7,6,5,4,3,2,1)之反就是我们所需的序列。</p>
<p>实现这个算法：</p>
<p><img src="https://penlab-1252869057.cos.ap-beijing.myqcloud.com/2022-03-30-125545.png" alt="image-20201207105419198 " style="zoom:30%;" /></p>
<p>具体算法：</p>
<p><img src="https://penlab-1252869057.cos.ap-beijing.myqcloud.com/2022-03-30-125549.png" alt="image-20201207105454286 " style="zoom:60%;" /></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding=utf-8</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">dfst</span></span><br><span class="line"><span class="string">～～～～</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">_visit = <span class="built_in">set</span>()</span><br><span class="line"></span><br><span class="line">_graph = &#123;</span><br><span class="line">        <span class="number">1</span>: [<span class="number">3</span>, <span class="number">2</span>],</span><br><span class="line">        <span class="number">2</span>: [<span class="number">3</span>],</span><br><span class="line">        <span class="number">3</span>: [<span class="number">4</span>],</span><br><span class="line">        <span class="number">4</span>: [<span class="number">3</span>, <span class="number">6</span>, <span class="number">5</span>],</span><br><span class="line">        <span class="number">5</span>: [<span class="number">7</span>],</span><br><span class="line">        <span class="number">6</span>: [<span class="number">7</span>],</span><br><span class="line">        <span class="number">7</span>: [<span class="number">4</span>, <span class="number">8</span>],</span><br><span class="line">        <span class="number">8</span>: [<span class="number">10</span>, <span class="number">9</span>],</span><br><span class="line">        <span class="number">9</span>: [<span class="number">1</span>],</span><br><span class="line">        <span class="number">10</span>: [<span class="number">7</span>]</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">_c = <span class="built_in">len</span>(_graph)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">search</span>(<span class="params">n</span>):</span><br><span class="line">    _visit.add(n)</span><br><span class="line">    <span class="built_in">print</span>(n)</span><br><span class="line">    <span class="keyword">for</span> s <span class="keyword">in</span> _graph[n]:</span><br><span class="line">        <span class="keyword">if</span> s <span class="keyword">not</span> <span class="keyword">in</span> _visit:</span><br><span class="line">            search(s)</span><br><span class="line">    <span class="keyword">global</span> _c</span><br><span class="line">    _c = _c -<span class="number">1</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;_c = &#123;&#125;&quot;</span>.<span class="built_in">format</span>(_c))</span><br><span class="line"></span><br><span class="line">search(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">output=&gt;</span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">3</span></span><br><span class="line"><span class="number">4</span></span><br><span class="line"><span class="number">6</span></span><br><span class="line"><span class="number">7</span></span><br><span class="line"><span class="number">8</span></span><br><span class="line"><span class="number">10</span></span><br><span class="line">_c=<span class="number">9</span></span><br><span class="line"><span class="number">9</span></span><br><span class="line">_c=<span class="number">8</span></span><br><span class="line">_c=<span class="number">7</span></span><br><span class="line">_c=<span class="number">6</span></span><br><span class="line">_c=<span class="number">5</span></span><br><span class="line"><span class="number">5</span></span><br><span class="line">_c=<span class="number">4</span></span><br><span class="line">_c=<span class="number">3</span></span><br><span class="line">_c=<span class="number">2</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line">_c=<span class="number">1</span></span><br><span class="line">_c=<span class="number">0</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>如此一来可以看到：</p>
<p><img src="https://penlab-1252869057.cos.ap-beijing.myqcloud.com/2022-03-30-125552.png" alt="image-20201208100007943" style="zoom:50%;" /></p>
<p>图中流图的边可以分为三种：</p>
<p>1） 实线边，即深度优先生成树算法生成的边，也就是<code>前进边(Advancing edge)</code>，这些边推进流图向下执行。</p>
<ol start="2" type="1">
<li>虚线边中从子节点指向其祖先的，也就是<code>后退边(Retreating edge)</code>，这些边指向上层。</li>
</ol>
<p>3）另外一些虚线边(5-&gt;7, 2-&gt;3)，这些边互相都不为祖先。也即是<code>交叉边(cross edge)</code>。</p>
<h1 id="自然循环">3. 自然循环</h1>
<h2 id="回边">回边</h2>
<p>给了一个流图， 要对循环进行分析。首先，我们定义了支配结点这一二元关系。然后通过直接支配结点，我们构建了一颗深度优先生成树，在这颗树上，顶点就是程序入口点，边就是直接支配关系，所有的路径就是所有的支配路径。有了这层关系，我们在树上不上了虚边，在后退边中，我们现在定义一种回边。这种回边一定是后退边(但是后退边不一定是回边)。回边的定义是这样的如果1 dom 9 现在有一条边，他的头是9，尾是1那么也就是说尾支配了头，这就是一条回边。</p>
<p>上边说了，后退边不一定是回边，如：</p>
<p><img src="https://penlab-1252869057.cos.ap-beijing.myqcloud.com/2022-03-30-125600.png" alt="image-20201208174753377" style="zoom:60%;" /></p>
<p>这是鲸书第七章的一个例子。从流图a中我们可以看到c和d的流形成一个环路， 但是他生成的任意一种深度优先生成树(或de在前或c在前)。都有一条后退边，指向一个他的非支配结点。</p>
<blockquote>
<p>因为我们在第一步计算了一个结点的所有支配对象，在第二步计算出了流图的深度优先生成树。那么我们就可以拿到所有支配路径，以及支配路径上所有结点的支配结点信息。通过生成树，我们就可以知道流图上那一些边是后退边，通过支配结点的计算，我们就可以知道后退边指向的是不是支配他的结点，从而判断一条后退边是不是回边。</p>
</blockquote>
<h2 id="自然循环-1">自然循环</h2>
<p>如果一个流图中，他的每一种深度优先生成树中所有后退边都是回边，那么这张流图就是 <code>可规约的（reducible）</code>，此时他每一种遍历情况下生成的深度优先生成树的所有后退边的集合，都是相同的。</p>
<h3 id="自然循环定义">自然循环定义：</h3>
<ul>
<li>必须具有一个唯一的入口结点， 称为循环头(header)。</li>
<li>具有一条进入循环头的回边。</li>
</ul>
<p><img src="https://penlab-1252869057.cos.ap-beijing.myqcloud.com/2022-03-30-125611.png" alt="image-20201208204910207 " style="zoom:30%;" /></p>
<p>在此图中可以看到， 在流图中找自然循环， 首先，找出所有回边。</p>
<p>然后如4-3: 这歌循环中3号结点为循环头，找到所有不经过3而到达4的结点：</p>
<p>4， 5，6，7，8，10。 然后再加上循环头3就是这个自然循环的组成。</p>
<h3 id="构造一条回边的自然循环">构造一条回边的自然循环：</h3>
<p><img src="https://penlab-1252869057.cos.ap-beijing.myqcloud.com/2022-03-30-125617.png" alt="image-20201208205823633 " style="zoom:33%;" /></p>
<p>算法说明一下，注意两点，一是n初始的时候已经在Loop中了， 二是找的是栈顶指针的前驱，弹出后，有前驱再压栈。比如还是在4-3的自然循环中，我们第一次循环压入了4， 然后找到了前驱m=[3,8], 3是循环头不过if, 因此8被压栈；下一轮8出栈，7入栈；再一轮7出栈，5、6、10入栈。。。</p>
<blockquote>
<p>所以说这里就是以循环头为上界进行一个流图的反向深度遍历。</p>
</blockquote>
<h3 id="自然循环性质">自然循环性质</h3>
<ul>
<li>除非两个循环有相同的循环头， 否则他们要不分离，要么嵌套。</li>
<li>一个循环不包含其他循环称为最内层循环(innermost loop)/同理流图中包含所有循环的是最外循环</li>
<li>下图中包含同一个循环头，很难说哪一个是最内循环(可能是循环中的if...else)，因此合并循环</li>
</ul>
<p><img src="https://penlab-1252869057.cos.ap-beijing.myqcloud.com/2022-03-30-125622.png" alt="image-20201208211513630 " style="zoom:30%;" /></p>
<h1 id="后记-循环优化">后记： 循环优化</h1>
<p>补充虎书第18章循环优化的内容</p>
<h2 id="loop-nest-tree">Loop-nest Tree</h2>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2020/12/06/loops/" data-id="cl1q2wlhs000q47w577x6efxf" data-title="程序分析之Loops in Flow Graphs" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/3/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/paper/" rel="tag">paper</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/php/" rel="tag">php</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pl/" rel="tag">pl</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/paper/" style="font-size: 15px;">paper</a> <a href="/tags/php/" style="font-size: 10px;">php</a> <a href="/tags/pl/" style="font-size: 20px;">pl</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/04/">April 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/03/">March 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/02/">February 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/01/">January 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/12/">December 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/09/">September 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/08/">August 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/07/">July 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/04/">April 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">March 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/02/">February 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">January 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">December 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">November 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">October 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">September 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">August 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">July 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">June 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">May 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">January 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">September 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">November 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">July 2018</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2022/04/06/taint-2/">PHP污点分析</a>
          </li>
        
          <li>
            <a href="/2022/03/31/nlp-1/">NLP入门(一)</a>
          </li>
        
          <li>
            <a href="/2022/02/24/web/">Web应用系中注入类漏洞调研</a>
          </li>
        
          <li>
            <a href="/2022/02/18/data-mining/">data_mining</a>
          </li>
        
          <li>
            <a href="/2022/02/06/logic-machine/">Logic Machine</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2022 iohex<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>






  </div>
</body>
</html>