<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Penlab</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="website">
<meta property="og:title" content="Penlab">
<meta property="og:url" content="http://example.com/page/3/index.html">
<meta property="og:site_name" content="Penlab">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="iohex">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Penlab" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 6.1.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Penlab</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-PAAA-1" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/07/07/PAAA-1/" class="article-date">
  <time class="dt-published" datetime="2021-07-07T10:29:06.000Z" itemprop="datePublished">2021-07-07</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/07/07/PAAA-1/">Program Analysis An Appetizer读书笔记： 第一章</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p><img src="/PAAA-1/image-20210707182952591.png" alt="image-20210707182952591"></p>
<p>本书在结构上如上图所示：本书没有使用任何具体的程序语言， 而是使用作者设计的两套prototypical programming languages, based on Guarded Commands and a subset of C，即上图A和B。</p>
<ul>
<li>第一章：  介绍了basic model of program graphs</li>
<li>第二章和第三章： 介绍了基本的过程内程序分析： 四个经典的bit-vector analyses, monotone framework。</li>
</ul>
<h1 id="第一章：-Programs-as-Graphs"><a href="#第一章：-Programs-as-Graphs" class="headerlink" title="第一章： Programs as Graphs"></a>第一章： Programs as Graphs</h1><p><img src="/PAAA-1/image-20210707184040462.png" alt="image-20210707184040462"></p>
<p>Figure 1.1 的有向图表示了一个程序图， 其中有五个点，定点表示了<code>initial node</code>, 最右边的叶子节点是<code>final node</code>。 q1, q2, q3 是三个<code>additional nodes</code>。</p>
<p>边上的label是该边相关的<code>actions</code> ， 构成了程序的语义。 可以看出这个程序是在迭代的计算阶乘。</p>
<h2 id="1-1-Actions"><a href="#1-1-Actions" class="headerlink" title="1.1 Actions"></a>1.1 Actions</h2><p>根据上面所描述的， 程序图的边上的actions代表了程序的语义。 </p>
<p><img src="/PAAA-1/image-20210707191056485.png" alt="image-20210707191056485"></p>
<p>以上是对每一个action的形式化的描述：首先看第一个第一式子中有七种可能， </p>
<ul>
<li><p>Assign: 分别是变量或数组赋值，</p>
</li>
<li><p>Input: 从channel或文件读取的数据赋值给变量或数组，</p>
</li>
<li><p>Output: 将数据写入channle或文件</p>
</li>
<li><p>Boolean</p>
</li>
<li><p>skip</p>
</li>
</ul>
<p>其中a代表一个算数表达式， b代表一个布尔表达式， 也给出了定义。</p>
<h2 id="1-2-Memories"><a href="#1-2-Memories" class="headerlink" title="1.2 Memories"></a>1.2 Memories</h2><p>Memory is in order to describe the meaning of the actions. There are three kinds of components we should consider: </p>
<ol>
<li><code>Variables</code>: The values of the variables</li>
<li><code>Arrays</code>:  The contents of the arrays</li>
<li><code>Channels</code>: The data available  on the Channels.</li>
</ol>
<ul>
<li><p>Variables: The values of the variables are modelled by a mapping:<br>$$<br>\sigma_v: Var \rightarrow Int<br>$$<br><code>Var</code> is a finite set of variables that we are interesting; and the set called <code>the domain of the mapping</code>.</p>
<p>This mapping can determines the value of each variable. </p>
<p><img src="/PAAA-1/image-20210712124107530.png" alt="image-20210712124107530"></p>
</li>
</ul>
<p>The Figure 1.2 shows a memory:<br>$$<br>\sigma: {x,y} \rightarrow Int<br>$$</p>
<p><img src="/PAAA-1/image-20210712124309441.png" alt="image-20210712124309441"></p>
<p>The Figuare 1.3 shows an update of the memory by assignment, and it can be represented by:</p>
<p><img src="/PAAA-1/image-20210712124532326.png" alt="image-20210712124532326"></p>
<ul>
<li><p>Arrays. The values of arrays are modelled by a mapping:<br>$$<br>\sigma_A: Arr \rightarrow Int^*<br>$$</p>
<p>Arr is a set of interesting array names;</p>
<p>Int* denotes lists of values.</p>
<p><img src="/PAAA-1/image-20210712124914015.png" alt="image-20210712124914015"></p>
</li>
</ul>
<p>Figure 1.4 shows a memory of two Arrays <code>A</code> (length 3)and <code>B</code>(length 4).</p>
<p><img src="/PAAA-1/image-20210712125206806.png" alt="image-20210712125206806"> </p>
<p>We can update memory in the <code>Figure 1.5</code> <img src="/PAAA-1/image-20210712125353559.png" alt="image-20210712125353559"></p>
<ul>
<li>Channels.<br>$$<br>\sigma_c: Chan \rightarrow Int^*<br>$$</li>
</ul>
<p>Chan is a finite set of channel names:</p>
<p><img src="/PAAA-1/image-20210712125532398.png" alt="image-20210712125532398"></p>
<p><img src="/PAAA-1/image-20210712125836056.png" alt="image-20210712125836056"></p>
<p><img src="/PAAA-1/image-20210712125828401.png" alt="image-20210712125828401"></p>
<h2 id="1-3-Semantics"><a href="#1-3-Semantics" class="headerlink" title="1.3 Semantics"></a>1.3 Semantics</h2><p>the semantics of the actions is about how to determine the values of the arithmetic expressions using the memories and how to determine the truth values of the boolean expressions&#x2F;</p>
<ul>
<li><p>Arthmetic expressions.</p>
</li>
<li><p>Boolean expressions.</p>
</li>
<li><p>Actions</p>
</li>
</ul>
<h2 id="1-4-Program-Graphs"><a href="#1-4-Program-Graphs" class="headerlink" title="1.4 Program Graphs"></a>1.4 Program Graphs</h2><img src="PAAA-1/image-20210713123451105.png" alt="image-20210713123451105" style="zoom:60%;" />

<img src="PAAA-1/image-20210713123516499.png" alt="image-20210713123516499" style="zoom:60%;" />

<p>The definition of the program graph is a graph includes a set of  nodes like q_start and q_end, and it has a set of directed edges <code>labelled by actions</code>.</p>
<img src="PAAA-1/image-20210713123810628.png" alt="image-20210713123810628" style="zoom:60%;" />

<img src="PAAA-1/image-20210713123840735.png" alt="image-20210713123840735" style="zoom:60%;" />





<h2 id="1-5-Execution-Sequences"><a href="#1-5-Execution-Sequences" class="headerlink" title="1.5 Execution Sequences"></a>1.5 Execution Sequences</h2><h2 id="1-6-The-Nature-of-Approximation"><a href="#1-6-The-Nature-of-Approximation" class="headerlink" title="1.6 The Nature of Approximation"></a>1.6 The Nature of Approximation</h2>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/07/07/PAAA-1/" data-id="cl1d6yigp0008kjw53r32a03b" data-title="Program Analysis An Appetizer读书笔记： 第一章" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-dynamic-tech" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/04/21/dynamic-tech/" class="article-date">
  <time class="dt-published" datetime="2021-04-21T06:24:26.000Z" itemprop="datePublished">2021-04-21</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/04/21/dynamic-tech/">All You Ever Wanted to Know About Dynamic Taint Analysis and Forward Symbolic Execution</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>  把这篇文章当博客写一方面是自己动态分析水平太差了， 一直以来拒绝各种动态工具(如FUZZ)，想想还是太执着。动静结合其实还是很好玩的， 而且动态污点分析和动态污点分析看起来也非常艺术。</p>
<p> 另一方面， 我觉着，笔者的文笔太好了。 值得我好好好好学习。</p>
<h1 id="0x00-摘要"><a href="#0x00-摘要" class="headerlink" title="0x00 摘要"></a>0x00 摘要</h1><h2 id="1-第一段：-问题介绍"><a href="#1-第一段：-问题介绍" class="headerlink" title="1. 第一段： 问题介绍"></a>1. 第一段： 问题介绍</h2><ul>
<li><ol>
<li>动态污点分析和前向符号执行越来越流行(提出主题)</li>
</ol>
</li>
<li><ol start="2">
<li>用在漏洞挖掘，恶意代码检测等领域(两种技术的应用场景举例)</li>
</ol>
</li>
<li><ol start="3">
<li>尽管用处很广，但是目前业界没有形式化的定义其算法与总结其关键技术难题(提出挑战)</li>
</ol>
</li>
</ul>
<h2 id="2-第二段：-工作介绍"><a href="#2-第二段：-工作介绍" class="headerlink" title="2. 第二段： 工作介绍"></a>2. 第二段： 工作介绍</h2><ul>
<li><ol>
<li>我们的贡献有两部分：</li>
</ol>
</li>
<li><ol start="2">
<li>一是我们精确的描述了两种技术的算法</li>
</ol>
</li>
<li><ol start="3">
<li>二是我们把安全场景下实现两种技术的难点都列了出来</li>
</ol>
</li>
</ul>
<p>由于这是一片类似于总结性的文章， 所以摘要中没有效果说明部分。(所以这篇文章也并不是design, evaluation架构的八股文)</p>
<h1 id="0x01-Introduction"><a href="#0x01-Introduction" class="headerlink" title="0x01 Introduction"></a>0x01 Introduction</h1><h2 id="1-动态分析技术"><a href="#1-动态分析技术" class="headerlink" title="1 动态分析技术"></a>1 动态分析技术</h2><ul>
<li><p>Dynamic analysis - the ability to monitor code as it executes - has become a fundamental tool in computer security research.(我啥时候才能写出这样牛逼的句子)</p>
</li>
<li><p>Dynamic analysis is attractive because it allows us to reason about actual executions, and thus can perform precise security analysis based upon run-time information.（动态分析666）</p>
</li>
<li><p>Further, dynamic analysis is simple: we need only consider facts about a single execution at a time.(进一步666)</p>
</li>
</ul>
<h2 id="2-引出两种具体的技术"><a href="#2-引出两种具体的技术" class="headerlink" title="2 引出两种具体的技术"></a>2 引出两种具体的技术</h2><ul>
<li>Two of the most commonly employed dynamic analysis techniques in security research are dynamic taint analysis and forward symbolic execution.（引出两种技术）</li>
<li>Dynamic taint analysis runs a program and observes which computations are affected by predefined taint source such as user input.(污点分析一句介绍，用了被动)</li>
<li>Dynamic forward symbolic execution automatically builds a logical formula describing a program execution path, which reduces the problem of reasoning about the execution to the domain of logic(这一句有点懵)</li>
<li>The two analyses can be used in conjunction to bulid formulas</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/04/21/dynamic-tech/" data-id="cl1d6yigy000pkjw5ga6aedgf" data-title="All You Ever Wanted to Know About Dynamic Taint Analysis and Forward Symbolic Execution" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-xss-patterns" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/04/07/xss-patterns/" class="article-date">
  <time class="dt-published" datetime="2021-04-07T08:06:34.000Z" itemprop="datePublished">2021-04-07</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/04/07/xss-patterns/">xss patterns</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>There are some source code patterns for XSS I should cover</p>
<h2 id="1-unserialize"><a href="#1-unserialize" class="headerlink" title="1. unserialize"></a>1. unserialize</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$tainted</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;input&#x27;</span>];</span><br><span class="line"><span class="variable">$arr</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$tainted</span>);</span><br><span class="line"><span class="keyword">echo</span>(<span class="variable">$arr</span>[<span class="string">&#x27;foo&#x27;</span>]);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">  </span><br><span class="line">---</span><br><span class="line">exploit localhost:<span class="number">9000</span>/vuln.php/?input=a:<span class="number">1</span>:&#123;s:<span class="number">3</span>:<span class="string">&quot;foo&quot;</span>;s:<span class="number">26</span>:<span class="string">&quot;&lt;script&gt;alert(1);&lt;/script&gt;&quot;</span>;&#125;</span><br></pre></td></tr></table></figure>



<h2 id="2-String-function-call"><a href="#2-String-function-call" class="headerlink" title="2. String function call"></a>2. String function call</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getParam</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$_GET</span>[<span class="string">&#x27;input&#x27;</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$funcName</span> = <span class="string">&#x27;getParam&#x27;</span>;</span><br><span class="line"><span class="variable">$tainted</span> = <span class="variable">$funcName</span>();</span><br><span class="line"><span class="keyword">echo</span>(<span class="variable">$tainted</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">exploit localhost:<span class="number">9000</span>/vuln.php/?input=&lt;script&gt;<span class="title function_ invoke__">alert</span>(<span class="number">1</span>);&lt;/script&gt;</span><br></pre></td></tr></table></figure>



<h2 id="3-call-user-func"><a href="#3-call-user-func" class="headerlink" title="3. call_user_func"></a>3. call_user_func</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getParam</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$_GET</span>[<span class="string">&#x27;input&#x27;</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$tainted</span> = <span class="title function_ invoke__">call_user_func</span>(<span class="string">&#x27;getParam&#x27;</span>);</span><br><span class="line"><span class="keyword">echo</span>(<span class="variable">$tainted</span>);</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">exploit localhost:<span class="number">9000</span>/vuln.php/?input=&lt;script&gt;<span class="title function_ invoke__">alert</span>(<span class="number">1</span>);&lt;/script&gt;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>



<h2 id="4-call-user-func-array"><a href="#4-call-user-func-array" class="headerlink" title="4. call_user_func_array"></a>4. call_user_func_array</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getParam</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$_GET</span>[<span class="string">&#x27;input&#x27;</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$array</span> = [];</span><br><span class="line"></span><br><span class="line"><span class="variable">$tainted</span> = <span class="title function_ invoke__">call_user_func_array</span>(<span class="string">&#x27;getParam&#x27;</span>, <span class="variable">$array</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span>(<span class="variable">$tainted</span>);</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">  exploit localhost:<span class="number">9000</span>/vuln.php/?input=&lt;script&gt;<span class="title function_ invoke__">alert</span>(<span class="number">1</span>);&lt;/script&gt;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>



<h2 id="5-xml-template"><a href="#5-xml-template" class="headerlink" title="5. xml template"></a>5. xml template</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">vul.php</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$tainted</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;tainted&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="variable">$output</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"><span class="variable">$title</span> = <span class="string">&#x27;target&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># template</span></span><br><span class="line"><span class="variable">$template_xml</span> = <span class="title function_ invoke__">simplexml_load_file</span>(<span class="string">&quot;template.xml&quot;</span>);</span><br><span class="line"><span class="variable">$res</span> = <span class="variable">$template_xml</span>-&gt;<span class="title function_ invoke__">xpath</span>(<span class="string">&quot;//template[@name=&#x27;<span class="subst">&#123;$title&#125;</span>&#x27;]&quot;</span>)[<span class="number">0</span>];</span><br><span class="line"><span class="variable">$str</span> = <span class="string">&quot;\$output .= \&quot;&quot;</span>.<span class="variable">$res</span>.<span class="string">&quot;\&quot;;&quot;</span>;</span><br><span class="line"><span class="keyword">eval</span>(<span class="variable">$str</span>); <span class="comment"># critical unsanitized data into a eval function!</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#output</span></span><br><span class="line"><span class="title function_ invoke__">print_r</span>(<span class="variable">$output</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">  ---</span><br><span class="line">template.xml</span><br><span class="line">  </span><br><span class="line"><span class="meta">&lt;?</span>xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span><span class="meta">?&gt;</span></span><br><span class="line">&lt;theme name=<span class="string">&quot;MyBB Master Style&quot;</span> version=<span class="string">&quot;1600&quot;</span>&gt;</span><br><span class="line"></span><br><span class="line">&lt;template name=<span class="string">&quot;target&quot;</span> version=<span class="string">&quot;123&quot;</span>&gt;&lt;![CDATA[</span><br><span class="line">&lt;h1&gt;<span class="variable">$tainted</span>&lt;/h1&gt;</span><br><span class="line">]]&gt;&lt;/template&gt;</span><br><span class="line">&lt;/theme&gt;</span><br><span class="line">  </span><br><span class="line"> ---</span><br><span class="line">  exploit localhost:<span class="number">9000</span>/vuln.php/?tainted=&lt;script&gt;<span class="title function_ invoke__">altert</span>(<span class="number">1</span>);&lt;/script&gt;</span><br><span class="line"> </span><br></pre></td></tr></table></figure>





<h2 id="6-ob-template"><a href="#6-ob-template" class="headerlink" title="6. ob template"></a>6. ob template</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">vuln.php</span><br><span class="line">  <span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$id</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;id&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">ob_start</span>();</span><br><span class="line"><span class="keyword">include</span>( <span class="string">&#x27;template.php&#x27;</span> ); </span><br><span class="line"><span class="variable">$data</span> = <span class="title function_ invoke__">ob_get_contents</span>();</span><br><span class="line">@<span class="title function_ invoke__">ob_end_clean</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span>(<span class="variable">$data</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">  ---</span><br><span class="line">  template.php</span><br><span class="line">  &lt;h1&gt; example &lt;/h1&gt;</span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$id</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">  ---</span><br><span class="line">  exploit localhost:<span class="number">9000</span>/vuln.php?id=&lt;script&gt;<span class="title function_ invoke__">alert</span>(<span class="number">1</span>);&lt;/script&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="7-PHP-SELF"><a href="#7-PHP-SELF" class="headerlink" title="7. PHP_SELF"></a>7. PHP_SELF</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$tainted</span> = <span class="variable">$_SERVER</span>[<span class="string">&#x27;PHP_SELF&#x27;</span>];</span><br><span class="line"><span class="keyword">echo</span>(<span class="variable">$tainted</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">  ---</span><br><span class="line">  exploit localhost:<span class="number">9000</span>/vuln.php/&lt;script&gt;<span class="title function_ invoke__">alert</span>(<span class="number">1</span>)&lt;/script&gt;</span><br></pre></td></tr></table></figure>





<h2 id="8-FOREACH"><a href="#8-FOREACH" class="headerlink" title="8. FOREACH"></a>8. FOREACH</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$_GET</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$value</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">  ---</span><br><span class="line">  exploit localhost:<span class="number">9000</span>/vuln.php/?input=&lt;script&gt;<span class="title function_ invoke__">alert</span>(<span class="number">1</span>);&lt;/script&gt;</span><br></pre></td></tr></table></figure>





<h2 id="9-COOKIE"><a href="#9-COOKIE" class="headerlink" title="9. COOKIE"></a>9. COOKIE</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$tainted</span> = <span class="variable">$_COOKIE</span>[<span class="string">&#x27;input&#x27;</span>];</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$tainted</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">  ---</span><br><span class="line">  exploit curl <span class="string">&#x27;http://localhost:9000/vuln.php&#x27;</span> --cookie <span class="string">&quot;input=&lt;/script&gt; &lt;script&gt; alert(1) &lt;/script&gt;&quot;</span></span><br></pre></td></tr></table></figure>





<h2 id="10-print-r"><a href="#10-print-r" class="headerlink" title="10. print_r"></a>10. print_r</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="meta">?&gt;</span></span><br><span class="line">[<span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$pId</span> = <span class="string">&quot;0&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$pId</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;id&#x27;</span>];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">print_r</span>( <span class="variable">$pId</span> );</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span>]</span><br><span class="line">  </span><br><span class="line">  ---</span><br><span class="line">  exploit localhost:<span class="number">9000</span>/vuln.php?id=&lt;script&gt;<span class="title function_ invoke__">alert</span>(<span class="number">1</span>);&lt;/script&gt;</span><br></pre></td></tr></table></figure>





<h2 id="11-Singleton（单例模式）"><a href="#11-Singleton（单例模式）" class="headerlink" title="11. Singleton（单例模式）"></a>11. Singleton（单例模式）</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require_once</span>(<span class="string">&#x27;singleton.php&#x27;</span>);</span><br><span class="line"><span class="title class_">Singleton</span>::<span class="title function_ invoke__">getInstance</span>()-&gt;<span class="title function_ invoke__">setParam</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;input&#x27;</span>]);</span><br><span class="line"><span class="keyword">echo</span>(<span class="title class_">Singleton</span>::<span class="title function_ invoke__">getInstance</span>()-&gt;<span class="title function_ invoke__">getParam</span>());</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">  </span><br><span class="line">  singleton.php</span><br><span class="line">  <span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Singleton</span></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$variable</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># from: https://de.wikibooks.org/wiki/Websiteentwicklung:_PHP:_Muster_Singleton</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="built_in">static</span> <span class="variable">$_instance</span> = <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * clone</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * Kopieren der Instanz von aussen ebenfalls verbieten</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">__clone</span>(<span class="params"></span>) </span>&#123;&#125;</span><br><span class="line">   </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * constructor</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * externe Instanzierung verbieten</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getInstance</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> === <span class="built_in">self</span>::<span class="variable">$_instance</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">self</span>::<span class="variable">$_instance</span> = <span class="keyword">new</span> <span class="built_in">self</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">self</span>::<span class="variable">$_instance</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setParam</span>(<span class="params"><span class="variable">$par</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;variable = <span class="variable">$par</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getParam</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;variable;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">  </span><br><span class="line">  ---</span><br><span class="line">  exploit localhost:<span class="number">9000</span>/vuln.php/?input=&lt;script&gt;<span class="title function_ invoke__">alert</span>(<span class="number">1</span>);&lt;/script&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<h2 id="12-type-validation"><a href="#12-type-validation" class="headerlink" title="12. type validation"></a>12. type validation</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$tainted</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;tainted&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="title function_ invoke__">is_numeric</span>(<span class="variable">$tainted</span>))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="variable">$tainted</span>=<span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$tainted</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>



<h2 id="13-string-replace-escape"><a href="#13-string-replace-escape" class="headerlink" title="13. string replace escape"></a>13. string replace escape</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$tainted</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;tainted&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="variable">$tainted</span> = <span class="title function_ invoke__">preg_replace</span>(<span class="string">&quot;/[^a-zA-Z]/&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="variable">$tainted</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$tainted</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>



<h2 id="14-build-in-sanitize"><a href="#14-build-in-sanitize" class="headerlink" title="14. build-in sanitize"></a>14. build-in sanitize</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$tainted</span> = <span class="title function_ invoke__">htmlspecialchars</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;tainted&#x27;</span>]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$tainted</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">  </span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$tainted</span> = <span class="title function_ invoke__">htmlentities</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;tainted&#x27;</span>]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$tainted</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>





<h2 id="15-vendor-sanitize"><a href="#15-vendor-sanitize" class="headerlink" title="15. vendor sanitize"></a>15. vendor sanitize</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$tainted</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;tainted&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">require_once</span> <span class="string">&#x27;htmlpurifier/HTMLPurifier.auto.php&#x27;</span>;</span><br><span class="line"><span class="variable">$config</span> = <span class="title class_">HTMLPurifier_Config</span>::<span class="title function_ invoke__">createDefault</span>();</span><br><span class="line"><span class="variable">$config</span>-&gt;<span class="title function_ invoke__">set</span>(<span class="string">&#x27;HTML.Allowed&#x27;</span>, <span class="string">&#x27;b,strong,i,em,u,a[href|title],ul,ol,li,p[style],br,span[style]&#x27;</span>);</span><br><span class="line"><span class="variable">$config</span>-&gt;<span class="title function_ invoke__">set</span>(<span class="string">&#x27;CSS.AllowedProperties&#x27;</span>, <span class="string">&#x27;font,font-size,font-weight,font-style,font-family,text-decoration,padding-left,color,background-color,text-align&#x27;</span>);</span><br><span class="line"><span class="variable">$purifier</span> = <span class="keyword">new</span> <span class="title class_">HTMLPurifier</span>(<span class="variable">$config</span>);</span><br><span class="line"><span class="variable">$tainted</span> = <span class="variable">$purifier</span>-&gt;<span class="title function_ invoke__">purify</span>(<span class="variable">$tainted</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$tainted</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>



<h2 id="16-List"><a href="#16-List" class="headerlink" title="16. List"></a>16. List</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$arr</span> = <span class="keyword">array</span>(<span class="string">&#x27;useless&#x27;</span>, <span class="variable">$_GET</span>[<span class="string">&#x27;input&#x27;</span>] );</span><br><span class="line">[<span class="variable">$useless</span>, <span class="variable">$tainted</span>]= <span class="variable">$arr</span>; </span><br><span class="line"><span class="keyword">echo</span>(<span class="variable">$tainted</span>);</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">  exploit localhost:<span class="number">9000</span>/vuln.php/?input=&lt;script&gt;<span class="title function_ invoke__">alert</span>(<span class="number">1</span>);&lt;/script&gt;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>



<h2 id="17-return-by-reference"><a href="#17-return-by-reference" class="headerlink" title="17. return_by_reference"></a>17. return_by_reference</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getParam</span>(<span class="params">&amp;<span class="variable">$ref</span></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$ref</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;input&#x27;</span>];</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$tainted</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( <span class="title function_ invoke__">getParam</span>(<span class="variable">$tainted</span>))&#123;</span><br><span class="line">    <span class="keyword">echo</span>(<span class="variable">$tainted</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">  </span><br><span class="line">---</span><br><span class="line">  exploit localhost:<span class="number">9000</span>/vuln.php/?input=&lt;script&gt;<span class="title function_ invoke__">alert</span>(<span class="number">1</span>);&lt;/script&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="18-global"><a href="#18-global" class="headerlink" title="18. global"></a>18. global</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">source.php</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">  <span class="variable">$global_var</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;input&#x27;</span>];</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">vul.php  </span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require_once</span>(<span class="string">&#x27;source.php&#x27;</span>);</span><br><span class="line"><span class="keyword">echo</span>(<span class="variable">$global_var</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">  exploit localhost:<span class="number">9000</span>/vuln.php/?input=&lt;script&gt;<span class="title function_ invoke__">alert</span>(<span class="number">1</span>);&lt;/script&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getParam</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">global</span> <span class="variable">$var</span>;</span><br><span class="line">    <span class="variable">$var</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;input&#x27;</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">printGlobal</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">global</span> <span class="variable">$var</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$var</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">getParam</span>();</span><br><span class="line"><span class="title function_ invoke__">printGlobal</span>();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>



<h2 id="19-Field"><a href="#19-Field" class="headerlink" title="19. Field"></a>19. Field</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">vuln.php</span><br><span class="line">  <span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require_once</span>(<span class="string">&#x27;classassignment.php&#x27;</span>);</span><br><span class="line"><span class="variable">$foo</span> = <span class="keyword">new</span> <span class="title class_">Foo</span>();</span><br><span class="line"><span class="variable">$foo</span>-&gt;<span class="title function_ invoke__">setParam</span>(<span class="string">&#x27;variable&#x27;</span>, <span class="variable">$_GET</span>[<span class="string">&#x27;input&#x27;</span>]);</span><br><span class="line"><span class="keyword">echo</span>(<span class="variable">$foo</span>-&gt;<span class="title function_ invoke__">getParam</span>());</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">  </span><br><span class="line">classassignment.php</span><br><span class="line">  <span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Foo</span></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$variable</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setParam</span>(<span class="params"><span class="variable">$variableName</span>, <span class="variable">$par</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="variable">$variableName</span> = <span class="variable">$par</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getParam</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;variable;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">  </span><br><span class="line">  ---</span><br><span class="line">  exploit localhost:<span class="number">9000</span>/vuln.php/?input=&lt;script&gt;<span class="title function_ invoke__">alert</span>(<span class="number">1</span>);&lt;/script&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/04/07/xss-patterns/" data-id="cl1d6yihe0025kjw52bwubxdk" data-title="xss patterns" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-static-sum" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/03/17/static-sum/" class="article-date">
  <time class="dt-published" datetime="2021-03-17T00:52:56.000Z" itemprop="datePublished">2021-03-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/03/17/static-sum/">静态分析之殇</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h1><p>计算机高级语言带来了软件开发的便利性， 其解决的问题是：如何使用更接近人类的交流方式与机器进行交流。 因此不可或缺的是一个从人类阅读的语言到机器阅读的语言之间的一个桥梁。 这个转化过程叫做编译。 在编译过程中，从信息的高级语言形式，到机器码形式我们可以看到还有几层中间语言：AST, IR…其实汇编语言就很像机器语言了，可以看成他的一层壳。但是语义还不是很方便人类提取，高级语言解决了这个问题。 再看高级语言往汇编去的路上。 有AST， 为什么要有这一层，我想，因为AST是一种将语法结构化的数据结构。 而高级语言和机器语言是给人和机器去看的， 而中间语言是要被处理的。 而计算机处理一种信息最方便的方式就是将他结构化，对信息中的每一个最小单元进行定位。 而树状结构是层级的，方便与遍历token之间的关系，从而检查语法， 解析语义。 但是程序是用来执行的， 他是一种强逻辑性语言，没有歧义。 因此程序中每一条执行流都是明确的。 而如果要分析程序中的控制流， 和数据流等，AST这种结构就不太合适了。一个是因为，流分析往往是以基本块为单位的，基本块的最小单位是一条statement，而一条statement表示成AST树状结构很复杂， 也没有必要(这样就成了在树上画图，结构会很复杂，见属性图)。对于流分析，这种statement展开是没有必要的，而此时,AST也要向汇编码汇聚，所以我猜这样才出现了IR。</p>
<p>可以把软件分析分作两个阶段：1. Complie 阶段和2. Run-time阶段，在compile的分析都是静态阶段， 此时，程序还没有产生Activation Records。</p>
<h1 id="0x01-流"><a href="#0x01-流" class="headerlink" title="0x01 流"></a>0x01 流</h1><p>静态分析， 就是自动化的去分析程序的流。 我们常见的流有一个过程内的控制流和数据流，以及过程间的调用。这些流会在程序中构造一张张的图。 控制流图， 数据流图， 调用图， 类图…。每一张图对应一种不同的层级关系或者功能。有几点需要注意：</p>
<ol>
<li><p>控制流图唯一，数据流图不唯一。 控制流图往往取决于AST结构。 AST结构定了，控制流图就定了(这里我觉得我可能 有误解)。而数据流图会对分析的目的不同而不同，可以正向构建也可以后向构建。只要目的达成， 就有意义。通常过程内的流图，叫做CFG, 而过程间的(加上Call Graph)的大流图，叫做ICFG</p>
</li>
<li><p>常见的数据流分析问题有reache definition, live variable和available expression。</p>
</li>
</ol>
<h1 id="0x02-问题"><a href="#0x02-问题" class="headerlink" title="0x02 问题"></a>0x02 问题</h1><h2 id="敏感问题"><a href="#敏感问题" class="headerlink" title="敏感问题"></a>敏感问题</h2><p>其实有各种各样的敏感问题，就是指的静态分析不能cover所有情况而引起的误报。</p>
<h3 id="流敏感"><a href="#流敏感" class="headerlink" title="流敏感"></a>流敏感</h3><p>流敏感， 指的是一个程序的执行流上，每条语句上相同的变量可能是不同的。 这是静态下所不能覆盖所有情况的(理论上)，比如一个变量初始化声明后被外部输入影响了，静态怎确定？所以纯静态只能做到相对的减少这些误报。实现流敏感一般是需要基于控制流图。</p>
<h3 id="路径敏感"><a href="#路径敏感" class="headerlink" title="路径敏感"></a>路径敏感</h3><p>路径敏感，是指对执行流上的分支的， 程序实际会走那条路径，纯静态在理论上也是不能确定所有情况的。</p>
<h3 id="上下文敏感"><a href="#上下文敏感" class="headerlink" title="上下文敏感"></a>上下文敏感</h3><p>上下文是过程间的调用， 一个过程被调用，在不同的调用点(call site)其返回值也不同。</p>
<h3 id="Field-x2F-Index-敏感"><a href="#Field-x2F-Index-敏感" class="headerlink" title="Field&#x2F;Index 敏感"></a>Field&#x2F;Index 敏感</h3><p>一个复合数组， 在理论上是可以无穷维度的， 因此静态怎么去分析？ 传统的静态分析做法是， 将数组标识符看作一个变量， 而不考虑下标的影响。(静态分析解决此类问题也可以叫数组敏感哈(随便你怎么叫))</p>
<ul>
<li><p>field敏感问题:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Foo</span> <span class="variable">foo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Foo</span>();</span><br><span class="line">foo.ParamA = GetUserInput();</span><br><span class="line">foo.ParamB = String.Empty;</span><br><span class="line">            </span><br><span class="line">Execute(foo.ParamB);</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Foo</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> string ParamA;</span><br><span class="line">    <span class="keyword">public</span> string ParamB;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>source点，和sink点不是一个field</p>
</li>
<li><p>index敏感问题：</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">string [] myArray = <span class="keyword">new</span> <span class="title class_">string</span>[len];</span><br><span class="line">myArray[<span class="number">0</span>] = GetUserInput();</span><br><span class="line">myArray[<span class="number">1</span>] = String.Empty;</span><br><span class="line">Execute(myArray[<span class="number">1</span>]); </span><br></pre></td></tr></table></figure>

<p>数组敏感中可以看到user_input传到了索引0中，而执行的是下标1的元素。</p>
<h3 id="Object-敏感"><a href="#Object-敏感" class="headerlink" title="Object 敏感"></a>Object 敏感</h3><p>字段这种存储在object上的内容，他的生存周期不是一个函数栈， 因此他可以经由不同函数操作。实现字段敏感可使用安德森算法(流不敏感，上下文不敏感)先做个指针分析，找到每个object指针指向的内容(提高指针分析的精度对后续精度的提升目前来看可能不大)。</p>
<p>解决各种敏感问题，常见的思路，一个在每个program point 建立记录信息，这是静态思路。 还有就是动静结合的方式。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Foo</span> <span class="variable">foo1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Foo</span>();</span><br><span class="line">foo1.ParamA = GetUserInput();</span><br><span class="line"><span class="type">Foo</span> <span class="variable">foo2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Foo</span>();</span><br><span class="line">foo2.ParamA = String.Empty;</span><br><span class="line">Execute(foo2.ParamA); </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Foo</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> string ParamA;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h2 id="动态问题"><a href="#动态问题" class="headerlink" title="动态问题"></a>动态问题</h2><h2 id="调用"><a href="#调用" class="headerlink" title="调用"></a>调用</h2><p>一个数据被传到一个过程中，理论上， 是可以抛出去无限层的， 每一层的返回值都不一定包含原来的信息了。因此静态很难确定， 通常的做法也是去限定层数。</p>
<h2 id="循环问题"><a href="#循环问题" class="headerlink" title="循环问题"></a>循环问题</h2><p>对于循环和递归，理论上，是可以有无限层的， 这也导致了，很难确定，一个变量的具体值。 对于循环，对于不同分析，需要不同考虑，比如污点分析， 可能不需要考虑回边情况。 因为循环的回边，如果没有因外的话，是回到了前必经节点，也就是说， 对信息流传播不会有影响，因为不会引入新的节点(至少我现在是这么想)。</p>
<p>对于递归，要做全程序分析，是不得不处理的，同循环一样，去掉自己到自己的调用边，还有的处理方式是， 在调用点建summary（啊呀具体我忘了，之后补充）。 </p>
<h2 id="指针分析与动态特性"><a href="#指针分析与动态特性" class="headerlink" title="指针分析与动态特性"></a>指针分析与动态特性</h2><p>这是大问题， 在java中，指针分析加反射就够受的了。 在脚本语言中， 还有各种动态特性(具体可以看RIPS14年NDSS那一篇built-in函数建模的)。这个， 再议～</p>
<h1 id="0x03-web安全"><a href="#0x03-web安全" class="headerlink" title="0x03 web安全"></a>0x03 web安全</h1><p>这一张的题目起的比较大，这里指的其实是信息流安全， 就是web中的信息流漏洞，如各种漏洞。通常静态使用污点分析的方式去做。</p>
<h2 id="数据流分析"><a href="#数据流分析" class="headerlink" title="数据流分析"></a>数据流分析</h2><h2 id="前后向"><a href="#前后向" class="headerlink" title="前后向"></a>前后向</h2><p>作为一种数据流分析，没有标准， 前向和后向流分析都可以。后向分析，有时候可以排除路径爆炸，但是后向很难知道数据边上具体传的是啥。</p>
<h2 id="算法"><a href="#算法" class="headerlink" title="算法"></a>算法</h2><p>通常使用的是迭代数据流算法，即在控制流上对program point进行数据流推算，然后迭代收敛，到达不定点。</p>
<p>图可达性算法， 将数据流做成有向图结构，在图上作分析。[2002 Mohen]</p>
<h2 id="CHECK"><a href="#CHECK" class="headerlink" title="CHECK"></a>CHECK</h2><p>除了污点分析自身的各种敏感问题，和静态分析很难cover的复合结构和调用问题》 还有各种CHECK的检查问题。</p>
<p>在我看来， CHECK可以分为两大类： validation和sanitization。 validation就是通过分支，将不安全的输入引导一个敏感函数不可达的分支中。 而sanitization就是通过对用户输入变形， 从而让威胁失去意义。 sanitization通常有很多叫法，一般的，在输入端做的叫sanitization, 而在输入数据走完逻辑后输出的地方叫做escaping，  反正意思都是一样就是转译。</p>
<p>不论是validation还是sanitization都要有规则， 其中都可以用黑白名单实现。而sanitization中除了黑白名单规则，还可以进行编码，如htmlspecialchars, htmlenities，将敏感符号转义成html实体编码。</p>
<p>还有一种通常叫cast, 就是强制类型转换(int)$a。 </p>
<p>以上是对数据流进行直接check， 还有间接check。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">  <span class="variable">$action</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;action&#x27;</span>];</span><br><span class="line"><span class="keyword">switch</span>(<span class="variable">$action</span>)</span><br><span class="line">  <span class="keyword">case</span> <span class="string">&quot;login&quot;</span>:</span><br><span class="line">					<span class="keyword">echo</span> <span class="variable">$action</span>;</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> <span class="string">&quot;logout&quot;</span>:</span><br><span class="line">					<span class="keyword">echo</span> <span class="variable">$action</span>;</span><br><span class="line">					<span class="keyword">break</span></span><br><span class="line">  <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>如这个简易的路由。 这时看起来并没有显示的安全检测， 但是其实是隐式的限制，数据是在一个指定的域里才可以进入危险分支。</p>
<p>再如，用户输入必须在数据库中存在， 才能进入危险分支， 这种在web非常常见。</p>
<p>最后就是一些用户身份验证， 和表单验证。 这些常常在路径中截断控制流。 因此我们做静态分析时，很难达到一个精准的状态。</p>
<h2 id="触发"><a href="#触发" class="headerlink" title="触发"></a>触发</h2><p>静态分析到了漏洞， 不行，不一定能出发， 这也是很多扫描器和AGE工具比静态分析工具好使的原因。 在触发环节， 你可能要满足各种验证条件和访问顺序才能把控制流引过了， 且污点数据依旧有效，这具有很大的不确定性。</p>
<p>在web中，要达到这一点，需要考虑：</p>
<ol>
<li>资源加载问题， 通常对于PHP这一种脚本语言， 加载代码是自动化的。 而且现在的代码通常是结构化mvc，实现自动化加载，总之。你要找到你的污点信息流在客户端的操作入口。需要分析路由(多入口web能相对简单一些)。</li>
<li>函数可达性， 确定资源被加载了， 就要进入该过程。</li>
<li>块可达性， 确定信息流入口的基本块是可达的。</li>
</ol>
<h3 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h3><p><a target="_blank" rel="noopener" href="https://medium.com/swlh/sensitivities-in-static-code-analysis-3cab7b07dea">https://medium.com/swlh/sensitivities-in-static-code-analysis-3cab7b07dea</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/03/17/static-sum/" data-id="cl1d6yihb001ukjw5ftfffq4f" data-title="静态分析之殇" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-soundiness" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/02/02/soundiness/" class="article-date">
  <time class="dt-published" datetime="2021-02-02T00:37:44.000Z" itemprop="datePublished">2021-02-02</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/02/02/soundiness/">soundiness</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="0x01-从soundness到soundiness"><a href="#0x01-从soundness到soundiness" class="headerlink" title="0x01 从soundness到soundiness"></a>0x01 从soundness到soundiness</h1><blockquote>
<p>The typical reasons for such choices are engineering compromises: implementers of such tools are well aware of how they could handle complex language features soundly (e.g., by assuming that a complex language feature can exhibit any behavior), but do not do so because this would make the analysis unscalable or imprecise to the point of being useless. Therefore, the dominant practice is one of treating soundness as an engineering choice.[1]</p>
</blockquote>
<p>目前，所有的静态分析工具都希望他们的工具能覆盖所有的情况(soundness), but现在的程序结构越来越复杂…势必有很多问题，是当前静态分析技术无法解决的(称之为Hard Language Feature)。</p>
<p>首先， 我们来看什么是soundness</p>
<blockquote>
<h2 id="Soundness"><a href="#Soundness" class="headerlink" title="Soundness"></a>Soundness</h2><p>Conservative approximation: the analysis captures all program behaviors, or the analysis result all possible executions of the program.</p>
</blockquote>
<p>这里的Conservative其实就是Over, 可以看到理想的soundness理论上分析处出实际程序运行时所有的路径和情形。</p>
<p>然而，无论是当前学术界和工业界都无法达到soundness。但是这些文章或技术一般都不会说自己是unsoundness的，因为通常unsoundness是故意的忽略掉分析一些行为，以达到更高效率的目的。 而这一些技术是想soundness的，但是又无法达到理想的soundness，在这种情形下，这些文章就会产生一些误导。 如一些分析工具，文章说的很好， 但是实际用起来有很多的情况cover不了导致大量误报造成结果直接不可用…</p>
<p>在想sound，sound不了。我又不是unsound的，这种情况下，就产生了soundy分析的概念。15年提出[2]的，呼吁将这一类分析结果，是soundiness的。</p>
<p><img src="/soundiness/truthiness.png" alt="truthiness"></p>
<h1 id="0x02-hard-language-features"><a href="#0x02-hard-language-features" class="headerlink" title="0x02 hard language features"></a>0x02 hard language features</h1><p>几乎所有现代语言中，都有一些对于静态分析来比较hard 的点：</p>
<p><img src="/soundiness/image-20210202094033999.png" alt="image-20210202094033999"></p>
<h2 id="Java-Reflection"><a href="#Java-Reflection" class="headerlink" title="Java Reflection"></a>Java Reflection</h2><p>以反射为例：</p>
<p><img src="/soundiness/image-20210202094244020.png" alt="image-20210202094244020"></p>
<p>反射的提出为了使得软件架构低耦合，高复用的目的。 如MVC框架中，框架要和web程序解耦，就需要通过反射去调用控制器中的方法，而不是改框架调用控制器。</p>
<p>在Java中， 反射使用的是对Class, method, field分别生成Metaobject, 然后使用这些metaobject来调用反射API接口来动态的达到静态调用效果。</p>
<p>反射是很重要的， 那么，如何静态分析呢？05年的APLAS提出了<code>String Constant analysis + Pointer Analysis</code>。</p>
<p>他们的工作， 他是通过字符串常量分析+指针分析去分析的。直观理解就是通过指针分析定位到每个metaobject的定义处，然后做字符串常量分析，去全文匹配到目标的位置。 但是问题是， 这种只能cover发射中的触发参数写在程序中的。 但是如果string value不存在， 何如？</p>
<blockquote>
<ul>
<li>Configuration files (配置文件输入)</li>
<li>Internet. (网络输入)</li>
<li>Command lines (命令行输入)</li>
<li>Complex string manipulations (复杂的字符串解析)</li>
<li>Dynamically generated (动态生成)</li>
<li>Encrypted (加密的，需要解码)</li>
</ul>
</blockquote>
<p>(插一句， 在静态安全分析中，字符串输入当作标识符真的是一大难题，感觉处理好了字符串输入，就能处理好许多静态安全问题)</p>
<p>(而我觉得目前来说，之所以大部分的漏洞都是通过手工和fuzz得到，就是因为静态分析不能cover许许多多问题)</p>
<p>这个工作的问题可以总结为： 名字不知道，啥也不知道。</p>
<p>在14年ECOOP, 南大李樾和谭添老师做了一个工作[4] (膜)，他们的方法 <code>Type Inference+String analysis+Pointer Analysis</code></p>
<p>他们的方法为：生时不可解， 用时亦可推。</p>
<p><img src="/soundiness/image-20210202113047743.png" alt="image-20210202113047743"></p>
<p>通过反射使用点，结合java强大的类型系统，去推到这个方法的线索(如有几个参数， 这些参数是什么类型)[5]。</p>
<p>目前解决这些问题还是使用动态方式比较通用，如[6]去跑java的测试用例，得到的信息供给静态分析使用， 此类工作(Assisted by Dynamic Analysis)快，准。但是soundness做的不够好。</p>
<h2 id="Native-Code"><a href="#Native-Code" class="headerlink" title="Native Code"></a>Native Code</h2><p>Native Code 是另外一种hard analysis的情况。 核心就是一种跨语言的调用，如何去静态分析。</p>
<p><img src="/soundiness/image-20210202114600176.png" alt="image-20210202114600176"></p>
<p>Java中提供了native关键字去声明调用JNI(Java Native Interface), 他是一套java调用底层平台c&#x2F;c++功能的接口， 没有函数体。实现逻辑在c&#x2F;c++中。这种机制能够使JVM同本地的动态链接库进行交互。</p>
<p><img src="/soundiness/image-20210202114857543.png" alt="image-20210202114857543"></p>
<p>那么这种跨语言，如何去做程序分析呢？</p>
<p>现在通常分析器通常去进行手工建模(Manually models the critical native code)…</p>
<p><img src="/soundiness/image-20210202115838235.png" alt="image-20210202115838235"></p>
<p>这里是对调用c&#x2F;c++中的arraycopy进行手工建模成java逻辑， 然后转化为三地址码。</p>
<p>最近的工作[7] (ISSTA2020), 有直接在二进制上分析跨语言的调用。</p>
<h1 id="reference"><a href="#reference" class="headerlink" title="reference"></a>reference</h1><p><a target="_blank" rel="noopener" href="http://soundiness.org/#Introduction">[1] http://soundiness.org/#Introduction</a></p>
<p><a target="_blank" rel="noopener" href="https://dl.acm.org/doi/10.1145/2644805">[2] https://dl.acm.org/doi/10.1145/2644805</a></p>
<p><a target="_blank" rel="noopener" href="https://www.semanticscholar.org/paper/Reflection-Analysis-for-Java-Livshits-Whaley/aa15b4f072b5d9f8f72b41b39c060ee5b5fb2807">[3] https://www.semanticscholar.org/paper/Reflection-Analysis-for-Java-Livshits-Whaley/aa15b4f072b5d9f8f72b41b39c060ee5b5fb2807</a></p>
<p><a target="_blank" rel="noopener" href="https://yuleisui.github.io/publications/ecoop14.pdf">[4] https://yuleisui.github.io/publications/ecoop14.pdf</a></p>
<p><a target="_blank" rel="noopener" href="https://www.semanticscholar.org/paper/Understanding-and-Analyzing-Java-Reflection-Li-Tan/3e358882af7a2e782fdb02c0ccf260f00728aff0">[5] https://www.semanticscholar.org/paper/Understanding-and-Analyzing-Java-Reflection-Li-Tan/3e358882af7a2e782fdb02c0ccf260f00728aff0 </a></p>
<p><a target="_blank" rel="noopener" href="https://www.semanticscholar.org/paper/Taming-reflection%3A-Aiding-static-analysis-in-the-of-Bodden-Sewe/1753d3e97fdbe7799b9625cb873b77eef506a608">[6] https://www.semanticscholar.org/paper/Taming-reflection%3A-Aiding-static-analysis-in-the-of-Bodden-Sewe/1753d3e97fdbe7799b9625cb873b77eef506a608</a></p>
<p><a target="_blank" rel="noopener" href="https://www.semanticscholar.org/paper/Identifying-Java-calls-in-native-code-via-binary-Fourtounis-Triantafyllou/8da9ef89f6b211193e2376a7d289f6b087f7cb5c">[7] https://www.semanticscholar.org/paper/Identifying-Java-calls-in-native-code-via-binary-Fourtounis-Triantafyllou/8da9ef89f6b211193e2376a7d289f6b087f7cb5c</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/02/02/soundiness/" data-id="cl1d6yih7001gkjw5g7rghp8d" data-title="soundiness" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-security" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/01/15/security/" class="article-date">
  <time class="dt-published" datetime="2021-01-15T01:14:26.000Z" itemprop="datePublished">2021-01-15</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/01/15/security/">安全性分析</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>这是我<del>最后一次</del>抄ppt了(认真脸)</p>
<h1 id="0x01-安全"><a href="#0x01-安全" class="headerlink" title="0x01 安全"></a>0x01 安全</h1><p>信息安全基本功，(完整性、保密性、可用性)…</p>
<p>首先讨论一个基本问题，什么是安全：</p>
<blockquote>
<p>Achieving some goals in the presence of adversaries</p>
<p>在有敌人的情况下仍要达到某个特殊目标</p>
</blockquote>
<p><img src="https://tva1.sinaimg.cn/large/008eGmZEgy1gmru5lf4ghj306006hq2u.jpg"></p>
<p>在cyber世界， 我们的坏人不言而喻， 我们的目标保护我们的计算机系统在有坏人的情况下还能正常运行，而且数据不会泄露。</p>
<p><img src="/debreach/image-20210118143612640.png" alt="image-20210118143612640"></p>
<p><img src="/debreach/image-20210118143702213.png" alt="image-20210118143702213"></p>
<p>我们来关注注入问题和信息泄露问题，为啥呢？ 因为他们属于一大类问题： 信息流的问题。</p>
<h1 id="0x02-信息流安全"><a href="#0x02-信息流安全" class="headerlink" title="0x02 信息流安全"></a>0x02 信息流安全</h1><p><img src="/debreach/image-20210118143903537.png" alt="image-20210118143903537"></p>
<p>在一个wechat登录界面中， 密码是一个敏感信息， 合法的信息流动是将密码从客户端流到服务器(可信赖一方)。</p>
<p>如果敏感信息流到了怀仁手上，是我们不想要的。</p>
<p>如何保护保护信息呢？</p>
<p>最常用的手段是访问控制(Access Control), 应用程序需要有授权才能访问一个信息， 它关心的是信息任何被访问。 但是信息一旦被访问， 如何操作就不在其管辖范围。</p>
<p>而信息流安全(Information Flow Security), 会追踪信息的流动， 保证程序以安全的方式处理这些信息。 关注的是信息是如何传播的， 在端到端之间的信息流动中保证数据的安全。</p>
<p>所以说一个实际的信息系统，想要保护信息安全，就既要有访问控制机制，又要有信息流安全检查[1]。</p>
<h2 id="什么是信息流"><a href="#什么是信息流" class="headerlink" title="什么是信息流"></a>什么是信息流</h2><blockquote>
<p> Information flow: if the information in variable x is transferred to variable y, then there is information flow x-&gt;y [2]</p>
</blockquote>
<p><img src="/debreach/image-20210118145110826.png" alt="image-20210118145110826"></p>
<p>信息载体(变量x)，传入了y, 这就是系统中的一个信息流动。</p>
<h2 id="信息流和Security结合"><a href="#信息流和Security结合" class="headerlink" title="信息流和Security结合"></a>信息流和Security结合</h2><p>要考虑信息流和安全结合起来， 需要考虑两点， 第一我们就要给信息流的载体，变量进行一个安全分级， 第二点我们需要在安全等级的基础上制定信息流动的策略。</p>
<h3 id="Security-Levels"><a href="#Security-Levels" class="headerlink" title="Security Levels"></a>Security Levels</h3><p>最简单说是将变量分为两级:</p>
<ol>
<li><p>H, meaning <code>high</code> security, secret information (秘密信息)</p>
</li>
<li><p>L, meaning <code>low</code>security, public observable information (系统以外可已观测到的)</p>
<p><img src="/debreach/image-20210118145706312.png" alt="image-20210118145706312"></p>
</li>
</ol>
<p>以上代码 broadcast(l)就是可以被广播出去的信息， h就是不能被信息系统之外不允许被观测到的。</p>
<p>这种安全等级可以抽象为格来表述的[3]。</p>
<p><img src="/debreach/image-20210118150635775.png" alt="image-20210118150635775"></p>
<p>格可以很复杂， 而且它可能不是线性上升的。</p>
<p><img src="/debreach/image-20210118150709113.png" alt="image-20210118150709113"></p>
<p>现在有了安全等级分类， 下一步就是制定策略</p>
<h3 id="Information-Flow-Policy"><a href="#Information-Flow-Policy" class="headerlink" title="Information Flow Policy"></a>Information Flow Policy</h3><p>信息流安全策略是限制这个信息流如何在不同安全等级中进行流动的。这里介绍一种不干涉策略(Noninterreference policy)[4]， 他的思想是： </p>
<blockquote>
<p> 高安全等级的变量不能影响到信息流中地安全等级的变量。就是说你不能够在信息可观测的底安全等级变量中，观测到高安全等级信息。</p>
</blockquote>
<p><img src="/debreach/image-20210118151455095.png" alt="image-20210118151455095"></p>
<p>嗯…</p>
<p><img src="/debreach/image-20210118151610860.png" alt="image-20210118151610860"></p>
<p>看这些例子， 总之，高密集变量不能赋值给地密级遍历中。</p>
<p><img src="/debreach/image-20210118151657627.png" alt="image-20210118151657627"></p>
<p>就是保证格上始终是按照边上升的</p>
<p><img src="/debreach/image-20210118151733378.png" alt="image-20210118151733378"></p>
<h1 id="0x03-Confidentiality-保密性-and-Integrity-完整性"><a href="#0x03-Confidentiality-保密性-and-Integrity-完整性" class="headerlink" title="0x03 Confidentiality(保密性) and Integrity(完整性)"></a>0x03 Confidentiality(保密性) and Integrity(完整性)</h1><p>从信息泄露的角度讲，需要阻止的信息流是从高到低， 但是完整性与保密性正好相反， 他要阻止的是从低安全流向高安全从而破坏高安全信息的完整性[5]。</p>
<p><img src="/debreach/image-20210118152255244.png" alt="image-20210118152255244"></p>
<p>完整性涵盖了一大类漏洞，如注入漏洞, 注入漏洞…还是注入漏洞。</p>
<p><img src="/debreach/image-20210118152448073.png" alt="image-20210118152448073"></p>
<p>从而可见， 保密性和完整性是信息流安全中的一体两面。 如此， 我们可以用一种手段解决这两种问题。</p>
<h2 id="扩展安全性概念"><a href="#扩展安全性概念" class="headerlink" title="扩展安全性概念"></a>扩展安全性概念</h2><p>完整性要保证数据在信息系统中的准确性(accuracy)、完全性(completeness)、一致性(consistency)</p>
<ul>
<li><p>Accuracy </p>
<p>可信的关键数据应该不被污染(操作才能正常， 如信息流安全中的各种注入)</p>
</li>
<li><p>Completeness</p>
<p>数据库应该存储所有完整的数据</p>
</li>
<li><p>Consistency</p>
<p>文件传输系统发送方和接收方内容必须一致。</p>
</li>
</ul>
<p>完整性需要保证整个系统运行是正确的。</p>
<h1 id="0x04-显式流-Explicit-Flows-和隐藏信道-Covert-Channels"><a href="#0x04-显式流-Explicit-Flows-和隐藏信道-Covert-Channels" class="headerlink" title="0x04 显式流(Explicit Flows)和隐藏信道(Covert Channels)"></a>0x04 显式流(Explicit Flows)和隐藏信道(Covert Channels)</h1><p>该部分讨论了信息流中，信息的传播方式，所有的流都是显示传播的吗(沿数据流图传播)。 当然还有侧信道(隐藏信道)或者隐式流。</p>
<p><img src="/debreach/image-20210118153545945.png" alt="image-20210118153545945"></p>
<p>控制流可以被敏感信息影响， 通过控制流的方式去泄漏信息。</p>
<p><img src="/debreach/image-20210118160246443.png" alt="image-20210118160246443"></p>
<p>以上例子是一些隐藏信道[6]。</p>
<ul>
<li><p>Implicit flows:  隐式流， 不是为了传递信息，仍然能够利用控制信息传递出敏感信息。</p>
</li>
<li><p>Termination channels： 终止信息， 通过程序是否终止传递敏感信息</p>
</li>
<li><p>Timing channels: 时间通道，根据运行时间的区别，获得隐藏信息</p>
</li>
<li><p>Exceptions: 通过异常泄露数据</p>
<p>…</p>
</li>
<li><p><img src="/debreach/image-20210118160625484.png" alt="image-20210118160625484"></p>
</li>
</ul>
<p>虽然隐式流比较难以发现， 但是隐藏信道泄露出的数据往往是有限的。</p>
<h1 id="0x05-Taint-Analysis"><a href="#0x05-Taint-Analysis" class="headerlink" title="0x05 Taint Analysis"></a>0x05 Taint Analysis</h1><p>污点分析是目前大量使用的信息流安全问题的分析方法。</p>
<p>思路：将数据分为两类， 其中将关注的一类数据打上标记，关注这些数据的传播。</p>
<h2 id="source"><a href="#source" class="headerlink" title="source"></a>source</h2><p>污点数据的源头， 污点数据的来源往往是某些特定方法的返回值。</p>
<h2 id="sink"><a href="#sink" class="headerlink" title="sink"></a>sink</h2><p>污点分析关心的是，从source打上标记的污点数据，是否会流向特殊的sink。</p>
<p><img src="/debreach/image-20210118161205249.png" alt="image-20210118161205249"></p>
<p>两个例子：</p>
<p><img src="/debreach/image-20210118161501315.png" alt="image-20210118161501315"></p>
<h2 id="Taint-and-Pointer-Analysis-Together"><a href="#Taint-and-Pointer-Analysis-Together" class="headerlink" title="Taint and Pointer Analysis, Together"></a>Taint and Pointer Analysis, Together</h2><p>2017年的P&#x2F;Taint论文正式提出要将指针分析和污点分析结合起来[7]。</p>
<p>污点分析本质上是追踪程序中的污点数据， 而指针分析的本质上是跟踪程序中的抽象对象如何在程序中流动。</p>
<p>那么我们就可以看作一类问题：</p>
<ul>
<li>Treat tainted data as (artificial) objects                                 —&gt; 将污点数据看作一类特殊的object</li>
<li>Treats source as allocation sites(of tainted data)                —&gt; 将source看作是敏感数据的allocation site</li>
<li>Leverages pointer analysis to propagate tainted data.     —-&gt; 借助指针分析追踪污点数据</li>
</ul>
<p>那么通过上下文不敏感指针分析为例，来改造成一个污点分析。</p>
<h2 id="Define"><a href="#Define" class="headerlink" title="Define"></a>Define</h2><ol>
<li><p>Domain: </p>
<p><img src="/debreach/image-20210118162349114.png" alt="image-20210118162349114"></p>
</li>
</ol>
<p>在指针分析的Domain(varibales, Fields, Objects)的基础上加入一类Tainted data。 （ti表示来自于程序中call site i中的数据）</p>
<p>(可以右边图中看到原先指针分析中的All objects(堆上的object), 现在分为两类，tainted data也看作一个T字头的objects。。。)</p>
<ol start="2">
<li><p>Inputs:</p>
<ul>
<li><p>Source: 一类方法关注他的return </p>
</li>
<li><p>Sink:   另一类方法， 关注他的参数中是否传入了taint</p>
</li>
</ul>
</li>
<li><p>Outputs:</p>
<ul>
<li>TaintFlows: 输出一个集合， 元素是&lt;ti, m&gt;这个pairs, 表示在call site i处会有一个污点数据t,将流到sink方法m当中。</li>
</ul>
</li>
</ol>
<h2 id="Rules"><a href="#Rules" class="headerlink" title="Rules"></a>Rules</h2><p> 污点分析借助指针分析做的，</p>
<h1 id="0x06-使用Datalog实现污点分析操作"><a href="#0x06-使用Datalog实现污点分析操作" class="headerlink" title="0x06 使用Datalog实现污点分析操作"></a>0x06 使用Datalog实现污点分析操作</h1><h2 id="Datalog"><a href="#Datalog" class="headerlink" title="Datalog"></a>Datalog</h2><p><img src="/security/image-20210126115602820.png" alt="image-20210126115602820"></p>
<p>简单说一下Datalog是一门逻辑声明式编程语言，他的操作元素是一系列的谓词(predicate)，为此中是一个一个的fact。最初输入的谓词叫做EDB, 而推出来的是IDB。而对于谓词逻辑推导叫做Rules，Rules左边是头部，通过一个一个的原子操作(包含relational和arithmetic)复合逻辑运算(逗号是与，还有或非)得到头部(头部可以是多个谓词)。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">//  symbol declare</span><br><span class="line">.type P &lt;: symbol</span><br><span class="line">.type A &lt;: number</span><br><span class="line"></span><br><span class="line">// EDB predict</span><br><span class="line">.decl Age(person: P, age: A)</span><br><span class="line"></span><br><span class="line">// facts</span><br><span class="line">Age(&quot;Xiaoming&quot;, 18).</span><br><span class="line">Age(&quot;Xiaohong&quot;, 23).</span><br><span class="line">Age(&quot;Alan&quot;, 16).</span><br><span class="line">Age(&quot;Abao&quot;, 31).</span><br><span class="line"></span><br><span class="line">// IDB predict</span><br><span class="line">.decl Audlt(person: P, age: A) output</span><br><span class="line"></span><br><span class="line">// rules</span><br><span class="line">Audlt(person, age) :- Age(person, age), age&gt;=18.</span><br></pre></td></tr></table></figure>



<p>上文就是使用souffle实现的图示的datalog关系，可以看到灰常的直观，那么他的输出IDB为：</p>
<p><img src="/security/image-20210126120329197.png" alt="image-20210126120329197"></p>
<p>以为datalog支持谓词推出自己的facts(递归)， 因此支持很多复杂的操作， 如指针分析：</p>
<p><img src="/security/image-20210126120426056.png" alt="image-20210126120426056"></p>
<p>如上是一个简单的过程内指针分析, 它的推导出的内容：</p>
<p><img src="/security/image-20210126120514215.png" alt="image-20210126120514215"></p>
<p><img src="/security/image-20210126120520304.png" alt="image-20210126120520304"></p>
<p>看和表中是一毛一样。</p>
<p>然后再演示一个过程间的：</p>
<p><img src="/security/image-20210126141708850.png" alt="image-20210126141708850"></p>
<p>目标代码中，为了处理第五行里的call, 需要4个东西：</p>
<ol>
<li><p>Dispatch： </p>
<p>EDB需要增加</p>
<ul>
<li>VCall(l:S, x:V, k:M) 记录l点的call方法k, x接收</li>
<li>Dispatch(o:O, k:M, m:M) 记录Dispatch到的方法</li>
<li>ThisVar(m:M, this:V) 记录方法中的this</li>
</ul>
<p>IDB需要增加</p>
<ul>
<li>CallGraph(l:S, m:M), l点的call</li>
<li>Reachable(m:M), 记录可达方法</li>
</ul>
</li>
<li><p>传参数</p>
<p>EDB增加：</p>
<ul>
<li>Argument(l:S, i:N, a:V), l点的调用的实参列表</li>
<li>Parameter(m:M, i:N, p:V), 形参列表</li>
</ul>
</li>
<li><p>传返回值</p>
<p>EDB增加:</p>
<p>MethodReturn(m:M, ret:V), 方法的return </p>
<p>CallReturn(l:S, r:V), 接受返回值</p>
<p><img src="/security/image-20210126170849123.png" alt="image-20210126170849123"></p>
</li>
</ol>
<p>污点分析还需要改点。</p>
<p><img src="/security/image-20210126171038704.png" alt="image-20210126171038704"></p>
<p><img src="/security/image-20210126171054264.png" alt="image-20210126171054264"></p>
<h1 id="reference"><a href="#reference" class="headerlink" title="reference"></a>reference</h1><p>[1] A practical system needs both access and flow control to satisfy all security requirements. – D.Denning, 1976</p>
<p>[2] Dorothy E.Denning and Peter J.Denning, “Certification of Programs for Secure Information Flow”. CACM 1977</p>
<p>[3] Dorothy E.Denning, “A Lattice Model of Secure Information Flow”. CACM 1976</p>
<p>[4] J.A. Goguen and J.Meseguer, “Security policies and security models”. S&amp;P 1982</p>
<p>[5] Ken Biba, “<em>Integrity Considerations for Secure Computer Systems</em>”. Technical Report, ESD-TR-76-372, USAF Electronic Systems Division, Bed-ford, MA, 1977.</p>
<p>[6] <em>Butler W. Lampson, “</em>A Note on the Confinement Problem*”. CACM 1973.</p>
<p>[7] <em>Neville Grech and Yannis Smaragdakis, “</em>P&#x2F;Taint: Unified Points-to and Taint Analysis*”. OOPSLA 2017.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/01/15/security/" data-id="cl1d6yih6001fkjw51bm5e9aq" data-title="安全性分析" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-cha" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/01/02/cha/" class="article-date">
  <time class="dt-published" datetime="2021-01-01T23:01:39.000Z" itemprop="datePublished">2021-01-02</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/01/02/cha/">CHA</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>资料： <a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1GQ4y1T7zm?from=search&amp;seid=7528278619420042576">https://www.bilibili.com/video/BV1GQ4y1T7zm?from=search&amp;seid=7528278619420042576</a></p>
<blockquote>
<p>01:30 Motivation</p>
<p>04:40 Call Graph Construction(CHA)</p>
<p>65:40 Interprocedural Control-Flow Graph</p>
<p>71:45 Interprocedural Data-Flow Analysis</p>
</blockquote>
<h1 id="Problem-of-Intraprocedural-Analysis"><a href="#Problem-of-Intraprocedural-Analysis" class="headerlink" title="Problem of Intraprocedural Analysis"></a>Problem of Intraprocedural Analysis</h1><p>过程内的常量传播过于保守， 造成结果的不准确</p>
<img src="cha/image-20210102095211276.png" alt="image-20210102095211276" style="zoom:40%;" />

<p>如上所示，对于一个常量传播:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">foo</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> ten();  <span class="comment">// 返回一个常量10</span></span><br><span class="line">  addOne(<span class="number">42</span>); <span class="comment">// 传出一个常量42</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">ten</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">10</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">addOne</span><span class="params">(<span class="type">int</span> x)</span> &#123;</span><br><span class="line">  <span class="type">int</span> <span class="variable">y</span> <span class="operator">=</span> x + <span class="number">1</span>;  <span class="comment">// y值本程序中是确定的，但是只做过程内分析是不确定的。</span></span><br><span class="line">  <span class="keyword">return</span> y;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>涉及到过程间方法调用的元素： 1. Call site(实参) 2. function decl(形参) 。</p>
<p>实际上，在分析foo的时候n就是10, 在分析addOne的时候x就是42,y就是43，但是过程内分析的时候，是不知道过程外的信息的，因此这里就是NAC。</p>
<p>在传统的过程内分析中，都是保守的假设(safe-approximation)。 </p>
<img src="cha/image-20210102095421699.png" alt="image-20210102095421699" style="zoom:60%;" />

<p>在过程间分析时，作为caller, foo就可以通过return边得到n的值。</p>
<p>作为callee, addOne就可以通过call边得到x和y的值。(caller得return, callee得实参)。</p>
<p>这样就可以弥补过程内数据流分析过度假设造成精度的丢失。 </p>
<p>做过程间分析需要的信息有： </p>
<ol>
<li>构造call graph</li>
<li>根据call graph，构造ICFG（过程间控制流图）</li>
<li>IDFG（过程间数据流分析）</li>
</ol>
<h1 id="Call-Graph"><a href="#Call-Graph" class="headerlink" title="Call Graph"></a>Call Graph</h1><p>为了过程间分析， 引入了call graph。</p>
<img src="cha/image-20210102100152715.png" alt="image-20210102100152715" style="zoom:20%;" />

<blockquote>
<p>本图foo函数作为caller，call了bar和baz, bar又调用了baz。</p>
</blockquote>
<p>重要程度不言而喻（要有过程间的控制流边，就先要建立call graph边那(所有跨函数分析的基础)）</p>
<h2 id="构造CG"><a href="#构造CG" class="headerlink" title="构造CG"></a>构造CG</h2><img src="cha/image-20210102100255628.png" alt="image-20210102100255628" style="zoom:30%;" />



<p>蓝色为精度指标， 绿色为速度指标。 这里介绍CHA。</p>
<p>首先看下java中函数调用方法。</p>
<p><img src="/cha/image-20210102100409591.png" alt="image-20210102100409591"></p>
<ul>
<li><p>static call: 静态调用（有点像非oo的function call）</p>
</li>
<li><p>Special call:  </p>
<ul>
<li>如： </li>
<li><ol>
<li>调用构造函数 </li>
<li>调用类自己的私有的实例方法</li>
<li>调用父类中的实例方法</li>
</ol>
</li>
</ul>
</li>
<li><p>Virtual call:  其他调用实例方法(大部分的oo调用，用来实现__多态__特性)</p>
</li>
</ul>
<p>static call和special call的目标方法只有一个， 比较好处理的。 关键是处理virtual call。</p>
<p>在程序中，某一个程序点在其运行时Receiving objects的不同，可能调用不同的目标方法，所以由于__多态__的原因(polymorphism), 一个virtual call在运行期间调用的method可能是__大于一个__的(<code>运行时才能决定，取决于运行时的具体reciving object</code>)。</p>
<blockquote>
<p>所以对于OO语言， 如何处理virtual call 是构造call graph的关键所在</p>
</blockquote>
<h2 id="Method-Dispatch-of-Virtual-Calls"><a href="#Method-Dispatch-of-Virtual-Calls" class="headerlink" title="Method Dispatch of Virtual Calls"></a>Method Dispatch of Virtual Calls</h2><p> 在处理virtual call中， 一个关键的步骤就是<code>method dispatch</code>。</p>
<p>__Dispatch__在过程间分析中比较重要的一个概念。</p>
<img src="cha/image-20210102101028005.png" alt="image-20210102101028005" style="zoom:30%;" />



<p>在程序运行时， call site调用 virtual call, 要去解这个方法需要两个关键：</p>
<ol>
<li>Receiver object 的具体类型。（右边例子里变量o指向的对象的具体类型）</li>
<li>Call site处方法的具体签名。(右边的例子里为foo(…))</li>
</ol>
<p>动态的时候去求解这个virtual call的过程也叫做<code>method dispatch</code></p>
<p>通过一个signature可以确定唯一的一个方法：</p>
<p><img src="/cha/image-20210102102131163.png" alt="image-20210102102131163"></p>
<ul>
<li>Class type: 类名</li>
<li>Method name: 方法名</li>
<li>Descriptor： 由两部分构成： 1.返回值类型 2. 参数类型</li>
</ul>
<p><img src="/cha/image-20210102102936695.png" alt="image-20210102102936695"></p>
<p>定义一个函数Dispatch， 这个函数模拟了动态时dispatch一个virtual call的具体过程。他的输入就是c(receiver object 的类型)， m(call si te这一点方法的签名)。</p>
<p>dispatch函数的目的是找到一个能够被调用的方法， 必须是一个具体的有方法体的方法，所以返回的必须是一个非抽象的方法。</p>
<ol>
<li><p>首先在c类中找是否有这样一个非抽象方法m’, </p>
</li>
<li><p>如果c没有，就去找c的所有父类c’(注意，是找父类)，直到找到目标方法m’。</p>
</li>
</ol>
<p><img src="/cha/image-20210102103447307.png" alt="image-20210102103447307"></p>
<p> 这个例子中有ABC三个类，如果dispatch中x.foo()这个call site的两个元素：1. x:  receiver object的具体类型是 B(因为它指向 new B()这个类), 2. Foo()这个call site的签名： &lt;B: void foo() &gt; 。所以首先回到B类中进行dispatch, B类中没有foo方法， 就去父类A中去找。</p>
<p>y.foo()中就是C的foo方法, 因为他的dispatch函数中，c是receiver object 指向的new C() 类型， 而且内部有一个foo方法供m匹配上。</p>
<h1 id="CHA-Class-Hierarchy-Analysis"><a href="#CHA-Class-Hierarchy-Analysis" class="headerlink" title="CHA(Class Hierarchy Analysis)"></a>CHA(Class Hierarchy Analysis)</h1><h2 id="Dispatch"><a href="#Dispatch" class="headerlink" title="Dispatch"></a>Dispatch</h2><p><img src="/cha/image-20210102105706369.png" alt="image-20210102105706369"></p>
<p>CHA是用来解整个程序call graph的一方法， 他需要知道整个程序的class以及继承信息。 核心思想是对于一个virtual call， 基于这个virtual call的声明类型(不是recevier的具体类型)，以及receiver variable a。</p>
<p><img src="/cha/image-20210102110314592.png" alt="image-20210102110314592"></p>
<p>核心思想是给定一个receiver variable a, 他可能会指向他的类型下的所有子类型(即本身)。</p>
<p>来看CHA的算法：</p>
<p><img src="/cha/image-20210103195541252.png" alt="image-20210103195541252"></p>
<p>CS： call site, 即调用点</p>
<p>T:  target methods，返回的目标方法</p>
<p>m: 目标方法的签名</p>
<p>有三个分支， 分别处理<code>static call</code>, <code>special call</code>和<code>virtual call</code></p>
<ol>
<li><p>static call: 静态调用直接放入</p>
</li>
<li><p>Special call: special call有三种： 父类方法(super), 构造方法和似有方法</p>
<p>其中父类方法比较特殊，需要Dispatch(cm,m) cm指的是方法m的类型(不是声明类型，A c &#x3D; new C(), 从C类找)。</p>
</li>
<li><p>Virtual call: </p>
<p><img src="/cha/image-20210103200229662.png" alt="image-20210103200229662"></p>
</li>
</ol>
<p>注意这里不是唯一的了， 所以使add 目标调用点的声明类型开始找所有符合方法签名m的本类或子类中的c’。</p>
<p><img src="/cha/image-20210103200405069.png" alt="image-20210103200405069"></p>
<p>注意三点：</p>
<ol>
<li>从本类以及子类中找所有的foo方法</li>
<li>其中包含dispatch, 如果本类中没有foo, 回望父类中找，因此Resolve(b.foo())中B无foo(),因此dispatch到了A.foo()。</li>
<li>和new B()无关(尽管new B()中不能调c.foo(), d.foo())，还是根据variable b的声明类(即B类)去找。</li>
</ol>
<h2 id="通过CHA构建Call-Graph"><a href="#通过CHA构建Call-Graph" class="headerlink" title="通过CHA构建Call Graph"></a>通过CHA构建Call Graph</h2><p><img src="/cha/image-20210103201000619.png" alt="image-20210103201000619"></p>
<p>从入口方法开始，没遇到一个可达方法，去解目标方法，得到新的方法后，再去解新的方法的可达方法。。。知道算法停止，得到call grap:</p>
<p><img src="/cha/image-20210103201150287.png" alt="image-20210103201150287"></p>
<p>三个数据结构：</p>
<ul>
<li>WL: worklist , 需要被处理的目标方法， 开始只有入口方法。</li>
<li>CG: Call graph, 存调用变。</li>
<li>RM:  可达方法，一个方法进入RM说明已经分析过了。</li>
</ul>
<p>算法：</p>
<p>一个大的While循环。以起初main方法为例，首先将main方法从worklist中取出来，如果main方法不在RM中说明没有分析过， 进入call graph分析过程， 从main方法中找到所有的call site, 对每一个call site进行单个call site结点的CHA resolve(cs)得到该call site所有可能的target method, 对于每一个target method m’, 将其在call graph中与main方法中对应的call site相连(cs-&gt;m’), 并将这些target method标记为可达method(add m’ to WL), 此时main方法加入到RM里了，之后不会再被重复分析。(每次分析的目标方法:remove m from WL, add m to RM)。</p>
<p><img src="/cha/image-20210103202612835.png" alt="image-20210103202612835"></p>
<p>虚线是call graph其中C.m()并无调用关系。 此时WL&#x3D;[]，构造完成，其中橙色的是每一个需要分析的method, 从中去找每一个call site（如B.bar()这个函数体为空，因此无任何call site), 找到所有call site, 对每个call site进行CHA 的resolve，得到调用边放入(cg，即虚线关系)，新增加的method放入WL（如果和RM重复就不分析了，因为已经分析过了）。</p>
<h1 id="Interprocedural-Contrl-Flow-Graph"><a href="#Interprocedural-Contrl-Flow-Graph" class="headerlink" title="Interprocedural Contrl-Flow Graph"></a>Interprocedural Contrl-Flow Graph</h1><p><img src="/cha/image-20210103203046532.png" alt="image-20210103203046532"></p>
<p>ICFG就是在过程内的CFG的过程加上一堆call site的调用边和返回边连接起来。</p>
<p><img src="/cha/image-20210103203135345.png" alt="image-20210103203135345"></p>
<p><img src="/cha/image-20210103210513165.png" alt="image-20210103210513165"></p>
<h1 id="Interprocedural-Data-Flow-Graph"><a href="#Interprocedural-Data-Flow-Graph" class="headerlink" title="Interprocedural Data-Flow Graph"></a>Interprocedural Data-Flow Graph</h1><p>在ICFG的基础上进行常量传播为例</p>
<p><img src="/cha/image-20210103210615560.png" alt="image-20210103210615560"></p>
<p>这里的转移函数除了node上的， 还需要加上边上的x&#x3D;val(a)的参数传递以及b&#x3D;val(y)的return传递，而加上那一条实现边(黄色标注)是为了传播a中的常量，如果没有这条边a的内容就会从过程外传到c&#x3D;b-3这很不科学。</p>
<p><img src="/cha/image-20210103211000777.png" alt="image-20210103211000777"></p>
<p>还有一点要注意就是，如下b&#x3D;ten()需要把b从过程内的常量传播中移除，这样b&#x3D;10传到下一条stmt，不然b&#x3D;7传下来的话就是NAC。</p>
<p>O了。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/01/02/cha/" data-id="cl1d6yigx000mkjw50bfj452d" data-title="CHA" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-loops" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/12/06/loops/" class="article-date">
  <time class="dt-published" datetime="2020-12-06T01:07:21.000Z" itemprop="datePublished">2020-12-06</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/12/06/loops/">程序分析之Loops in Flow Graphs</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>此文为编译原理(龙书)9.6章， 补充南大重续分析第6节之后。</p>
<h1 id="1-支配结点"><a href="#1-支配结点" class="headerlink" title="1. 支配结点"></a>1. 支配结点</h1><h2 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h2><h3 id="支配结点"><a href="#支配结点" class="headerlink" title="支配结点"></a>支配结点</h3><p>Dominators, 即支配结点， 如果从一段程序的entry point 到结点n的所有路径， 都经过结点m，那么我们就可以说m支配n，<code>记为 m dom n</code></p>
<p>支配结点性质：</p>
<ul>
<li>reflexive: a dom a （每个结点支配本身，不过为了区分的本身的支配结点也可以叫strict dom）</li>
<li>transitive:  a dom b and b dom c &#x3D;&gt; a dom c (具有传递性)</li>
<li>antisymmetric:  a dom b and b dom a &#x3D;&gt; a&#x3D;&#x3D;b</li>
</ul>
<h3 id="直接支配结点"><a href="#直接支配结点" class="headerlink" title="直接支配结点"></a>直接支配结点</h3><p>此外， 在到达一个结点的支配路径上的最后一个结点，记为<code>直接支配结点（immediate dominator）</code>， 如果一个结点记为n，他的直接支配结点记为m<code>(m idom n)</code>。在n的支配路径上，当支配结点不是自身时，支配节点d一定也支配m。 </p>
<p>为啥要强调直接支配呢？要看我们表示流图中支配关系的数据结构： 支配树</p>
<h3 id="支配树"><a href="#支配树" class="headerlink" title="支配树"></a>支配树</h3><p>首先，手工来找每一个支配结点的支配对象。此处我们的入口结点是1号结点， 我们可以看到，1号结点支配所有结点， 而2号结点在1号结点的分支上，下层所有结点都可以从3号结点到达， 因此2号结点仅支配它自身(任何结点都支配自身)。 如图，以此类推。如此生成一颗支配结点树。</p>
<img src="loops/image-20201208181751573.png" alt="image-20201208181751573 " style="zoom:20%;" />

<p>这颗树上，入口为程序根结点，每个结点支配它的后代结点：</p>
<img src="loops/image-20201208182015843.png" alt="image-20201208182015843 " style="zoom:30%;" />

<p>生成树的性质：</p>
<ul>
<li><p>顶点： 程序入口点</p>
</li>
<li><p>边： 直接支配结点</p>
</li>
<li><p>路径： 所有支配路径</p>
</li>
</ul>
<h2 id="支配路径分析算法"><a href="#支配路径分析算法" class="headerlink" title="支配路径分析算法"></a>支配路径分析算法</h2><p>要设计一个算法，来求出一段程序中每个结点的支配路径。 那么整个算法的思想如下：</p>
<blockquote>
<p>如果p1,p2,p3….pk是结点n的所有前驱， 并且d不等于n,  那么当且仅当每个d dom pi时(pi为每个p)，d dom n。</p>
</blockquote>
<p>也就是说，n的一个前驱结点如果要是称为n的支配结点d，那么必须支配到达n点的所有前驱。因此他表示成的数据结构也就是一棵树(回溯祖先只有一条路经)。</p>
<p>比如上面的程序流图中，4到8点之间有5，6，7三个点， 4号结点同时支配5,6,7,因此4号结点支配8号结点；而5号结点到8号结点之间有7号结点， 5号结点并不支配7号结点(他只支配本身)， 因此5号结点并不能支配8号结点。</p>
<p>好算法原理介绍完了，接下来我们设计这个程序分析。</p>
<img src="loops/%E6%88%AA%E5%B1%8F2020-05-17%20%E4%B8%8B%E5%8D%889.56.10.png" alt="截屏2020-05-17 下午9.56.10 " style="zoom:80%;" />

<p>对照这张表，分析次算法。</p>
<ul>
<li><p>Domain: 基于抽象的数据集， 应该选择所有点</p>
</li>
<li><p>Direction: 求每个程序点的支配路径，Forwards更直观</p>
</li>
<li><p>May&#x2F;Must: 为了保证我们的分析结果safe，那么这应该是一个must-approximation，以确保支配路径的唯一性。</p>
</li>
<li><p>Boundary: 边界条件，由于是前向的，Must分析， 那么程序的边界应该是OUT[entry]， 从上到下，而初始应该不是空集，而是本结点为支配结点(入口结点是所有结点的支配结点)，即OUT[entry] &#x3D; {entry}</p>
</li>
<li><p>Initialization: 因为Meet是交运算，每个程序结点的初始化应该是所有路径OUT[B]&#x3D;N(假设所有结点都是他的支配结点)</p>
</li>
<li><p>Transfer funciton: 每个基本块内的转移函数，因为是前向分析，所以转移函数应该IN[B]union上本身{B}。F(x) &#x3D; xU{B}</p>
</li>
<li><p>在merge处(程序数据的合并点)我们取交集。</p>
</li>
</ul>
<img src="loops/image-20201206101945309.png" alt="image-20201206101945309 " style="zoom:67%;" />

<p>这个算法的Transfer function和之前的-kill +gen的不同， 需要注意。</p>
<p>拿来那张Must分析的图：</p>
<img src="loops/%E6%88%AA%E5%B1%8F2020-08-13%20%E4%B8%8A%E5%8D%888.54.34.png" alt="截屏2020-08-13 上午8.54.34 " style="zoom:67%;" />

<p>初始时所有前驱点都是支配结点，然后将这个集合不断缩小知道最大不动点，求最大下界。</p>
<p>因此我们的Iterative Algorithm有：</p>
<img src="loops/image-20201206102844236.png" alt="image-20201206102844236 " style="zoom:50%;" />

<p>来看具体的例子：</p>
<img src="loops/image-20201206104654556.png" alt="image-20201206104654556 " style="zoom:50%;" />

<p>D(n)是所有结点的支配结点的集合。</p>
<p>D(1)是入口结点， 支配结点就是它本身。</p>
<p>D(2)中的转移函数回吧IN[B]即D(1)union上自身{2} &#x3D;&gt; {1,2}</p>
<p>D(3)同理， 转移函数{3}unionIN[B]，这里的IN[B]是有四条边， 根据merge取并集，我们有D(1)nD(2)nD(4)nD(8)因为4，8没有分析，所以他们的OUT[B]都是初始值，所有点。因此D3 &#x3D; {1,3}。</p>
<p>停止条件：</p>
<p>因为我们的OUT[B]&#x3D;IN[B]union本身，我们看第一次迭代后，其实已经达到了不动点。比如D(3)在第二次迭代时，D(1)是恒不变的，D(2)就是不变的。此时D(4) &#x3D; {1,3,4}, D(8) &#x3D; {1,3,4,7,8} 他们的并集一定是小于等于4的结点集合,即{1,3,4}，而只要有前驱1,2在，那么支配结点的并集就一定是小于3的。(不考虑环路)</p>
<p>如果不考虑环路了， 那么在无环图上，根据支配结点的性质， <code>除了入口结点，每一个结点都有唯一的直接支配结点</code>。再比如4号结点，有3和7两个入边，要证明停止， 我们就要证明7号的支配结点一定包含{1,3}而不会再包含2，那么算法就停止了。也就是说只计算一次，路径中的所有支配结点都出现了，不会再添加其他的了。如果再添加了2，即{1,2,3}那么程序中到达4就会有两条路经，1，3，4和1，2，3，4。</p>
<p>如此一来， 算法变成了：</p>
<img src="loops/image-20201206113136795.png" alt="image-20201206113136795 " style="zoom:50%;" />

<p>没有了while循环。</p>
<h1 id="2-深度优先生成树"><a href="#2-深度优先生成树" class="headerlink" title="2. 深度优先生成树"></a>2. 深度优先生成树</h1><p>我们需要分析循环XD，现在，我们根据支配路径分析算法， 得到了生成树，也就是说得到了流图上每一个点的支配路径信息。而实际控制流图所走的路径中间夹杂着支配结点之外的结点。此外，要在流图中刻画循环，我们需要知道流图中什么时候前进，什么时候回退了。这些信息需要生成一个深度优先生成树来提供。</p>
<img src="loops/image-20201207105042417.png" alt="image-20201207105042417 " style="zoom:70%;" />

<p>要在流图上进行深度优先搜索所得到的序列: 1,2,3,4,5,6,7,8,9,10 。我们可以生成深度优先生成树， 这棵树的后序遍历序列(10,9,8,7,6,5,4,3,2,1)之反就是我们所需的序列。</p>
<p>实现这个算法：</p>
<img src="loops/image-20201207105419198.png" alt="image-20201207105419198 " style="zoom:30%;" />

<p>具体算法：</p>
<img src="loops/image-20201207105454286.png" alt="image-20201207105454286 " style="zoom:60%;" />

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding=utf-8</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">dfst</span></span><br><span class="line"><span class="string">～～～～</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">_visit = <span class="built_in">set</span>()</span><br><span class="line"></span><br><span class="line">_graph = &#123;</span><br><span class="line">        <span class="number">1</span>: [<span class="number">3</span>, <span class="number">2</span>],</span><br><span class="line">        <span class="number">2</span>: [<span class="number">3</span>],</span><br><span class="line">        <span class="number">3</span>: [<span class="number">4</span>],</span><br><span class="line">        <span class="number">4</span>: [<span class="number">3</span>, <span class="number">6</span>, <span class="number">5</span>],</span><br><span class="line">        <span class="number">5</span>: [<span class="number">7</span>],</span><br><span class="line">        <span class="number">6</span>: [<span class="number">7</span>],</span><br><span class="line">        <span class="number">7</span>: [<span class="number">4</span>, <span class="number">8</span>],</span><br><span class="line">        <span class="number">8</span>: [<span class="number">10</span>, <span class="number">9</span>],</span><br><span class="line">        <span class="number">9</span>: [<span class="number">1</span>],</span><br><span class="line">        <span class="number">10</span>: [<span class="number">7</span>]</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">_c = <span class="built_in">len</span>(_graph)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">search</span>(<span class="params">n</span>):</span><br><span class="line">    _visit.add(n)</span><br><span class="line">    <span class="built_in">print</span>(n)</span><br><span class="line">    <span class="keyword">for</span> s <span class="keyword">in</span> _graph[n]:</span><br><span class="line">        <span class="keyword">if</span> s <span class="keyword">not</span> <span class="keyword">in</span> _visit:</span><br><span class="line">            search(s)</span><br><span class="line">    <span class="keyword">global</span> _c</span><br><span class="line">    _c = _c -<span class="number">1</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;_c = &#123;&#125;&quot;</span>.<span class="built_in">format</span>(_c))</span><br><span class="line"></span><br><span class="line">search(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">output=&gt;</span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">3</span></span><br><span class="line"><span class="number">4</span></span><br><span class="line"><span class="number">6</span></span><br><span class="line"><span class="number">7</span></span><br><span class="line"><span class="number">8</span></span><br><span class="line"><span class="number">10</span></span><br><span class="line">_c=<span class="number">9</span></span><br><span class="line"><span class="number">9</span></span><br><span class="line">_c=<span class="number">8</span></span><br><span class="line">_c=<span class="number">7</span></span><br><span class="line">_c=<span class="number">6</span></span><br><span class="line">_c=<span class="number">5</span></span><br><span class="line"><span class="number">5</span></span><br><span class="line">_c=<span class="number">4</span></span><br><span class="line">_c=<span class="number">3</span></span><br><span class="line">_c=<span class="number">2</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line">_c=<span class="number">1</span></span><br><span class="line">_c=<span class="number">0</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>如此一来可以看到：</p>
<p><img src="/loops/image-20201208100007943.png" alt="image-20201208100007943"></p>
<p>图中流图的边可以分为三种：</p>
<p>1） 实线边，即深度优先生成树算法生成的边，也就是<code>前进边(Advancing edge)</code>，这些边推进流图向下执行。</p>
<ol start="2">
<li>虚线边中从子节点指向其祖先的，也就是<code>后退边(Retreating edge)</code>，这些边指向上层。</li>
</ol>
<p>3）另外一些虚线边(5-&gt;7, 2-&gt;3)，这些边互相都不为祖先。也即是<code>交叉边(cross edge)</code>。</p>
<h1 id="3-自然循环"><a href="#3-自然循环" class="headerlink" title="3. 自然循环"></a>3. 自然循环</h1><h2 id="回边"><a href="#回边" class="headerlink" title="回边"></a>回边</h2><p>给了一个流图， 要对循环进行分析。首先，我们定义了支配结点这一二元关系。然后通过直接支配结点，我们构建了一颗深度优先生成树，在这颗树上，顶点就是程序入口点，边就是直接支配关系，所有的路径就是所有的支配路径。有了这层关系，我们在树上不上了虚边，在后退边中，我们现在定义一种回边。这种回边一定是后退边(但是后退边不一定是回边)。回边的定义是这样的如果1 dom 9  现在有一条边，他的头是9，尾是1那么也就是说尾支配了头，这就是一条回边。</p>
<p>上边说了，后退边不一定是回边，如：</p>
<p><img src="/loops/image-20201208174753377.png" alt="image-20201208174753377"></p>
<p>这是鲸书第七章的一个例子。从流图a中我们可以看到c和d的流形成一个环路， 但是他生成的任意一种深度优先生成树(或de在前或c在前)。都有一条后退边，指向一个他的非支配结点。</p>
<blockquote>
<p>因为我们在第一步计算了一个结点的所有支配对象，在第二步计算出了流图的深度优先生成树。那么我们就可以拿到所有支配路径，以及支配路径上所有结点的支配结点信息。通过生成树，我们就可以知道流图上那一些边是后退边，通过支配结点的计算，我们就可以知道后退边指向的是不是支配他的结点，从而判断一条后退边是不是回边。</p>
</blockquote>
<h2 id="自然循环"><a href="#自然循环" class="headerlink" title="自然循环"></a>自然循环</h2><p>如果一个流图中，他的每一种深度优先生成树中所有后退边都是回边，那么这张流图就是 <code>可规约的（reducible）</code>，此时他每一种遍历情况下生成的深度优先生成树的所有后退边的集合，都是相同的。</p>
<h3 id="自然循环定义："><a href="#自然循环定义：" class="headerlink" title="自然循环定义："></a>自然循环定义：</h3><ul>
<li>必须具有一个唯一的入口结点， 称为循环头(header)。</li>
<li>具有一条进入循环头的回边。</li>
</ul>
<img src="loops/image-20201208204910207.png" alt="image-20201208204910207 " style="zoom:30%;" />

<p>在此图中可以看到， 在流图中找自然循环， 首先，找出所有回边。</p>
<p>然后如4-3: 这歌循环中3号结点为循环头，找到所有不经过3而到达4的结点：</p>
<p>4， 5，6，7，8，10。 然后再加上循环头3就是这个自然循环的组成。</p>
<h3 id="构造一条回边的自然循环："><a href="#构造一条回边的自然循环：" class="headerlink" title="构造一条回边的自然循环："></a>构造一条回边的自然循环：</h3><img src="loops/image-20201208205823633.png" alt="image-20201208205823633 " style="zoom:33%;" /> 

<p>算法说明一下，注意两点，一是n初始的时候已经在Loop中了， 二是找的是栈顶指针的前驱，弹出后，有前驱再压栈。比如还是在4-3的自然循环中，我们第一次循环压入了4， 然后找到了前驱m&#x3D;[3,8], 3是循环头不过if, 因此8被压栈；下一轮8出栈，7入栈；再一轮7出栈，5、6、10入栈。。。</p>
<blockquote>
<p>所以说这里就是以循环头为上界进行一个流图的反向深度遍历。</p>
</blockquote>
<h3 id="自然循环性质"><a href="#自然循环性质" class="headerlink" title="自然循环性质"></a>自然循环性质</h3><ul>
<li>除非两个循环有相同的循环头， 否则他们要不分离，要么嵌套。</li>
<li>一个循环不包含其他循环称为最内层循环(innermost loop)&#x2F;同理流图中包含所有循环的是最外循环</li>
<li>下图中包含同一个循环头，很难说哪一个是最内循环(可能是循环中的if…else)，因此合并循环</li>
</ul>
<img src="loops/image-20201208211513630.png" alt="image-20201208211513630 " style="zoom:30%;" />

<h1 id="后记：-循环优化"><a href="#后记：-循环优化" class="headerlink" title="后记： 循环优化"></a>后记： 循环优化</h1><p>补充虎书第18章循环优化的内容</p>
<h2 id="Loop-nest-Tree"><a href="#Loop-nest-Tree" class="headerlink" title="Loop-nest Tree"></a>Loop-nest Tree</h2>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2020/12/06/loops/" data-id="cl1d6yih0000ukjw53bwo6049" data-title="程序分析之Loops in Flow Graphs" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-PHP-Static-Analysis-Theory" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/11/14/PHP-Static-Analysis-Theory/" class="article-date">
  <time class="dt-published" datetime="2020-11-14T03:15:48.000Z" itemprop="datePublished">2020-11-14</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/11/14/PHP-Static-Analysis-Theory/">Static Detection of Security Vulnerabilities in Scripting Languages</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="Static-Detection-of-Security-Vulnerabilities-in-Scripting-Languages"><a href="#Static-Detection-of-Security-Vulnerabilities-in-Scripting-Languages" class="headerlink" title="Static Detection of Security Vulnerabilities in Scripting Languages"></a>Static Detection of Security Vulnerabilities in Scripting Languages</h1><p>本文为Stanford大学2005年发表的文章追本溯源，这个Yichen Xie和Alex Aiken团队似乎是PHP安全静态分析比较早的，那个时候，台大的Huang等的WebSSARI应该出来了； Livshits等的Pixy也在构建中。 这一篇理论性的东西比较多，都是在构建数学模型，有借鉴意义。 再拿来总结一下。</p>
<p>本文提出的是一个PHP安全漏洞的静态分析算法， 他们提出了一种三层架构从块内，过程内， 过程间三个级别进行静态分析。 尝试解决脚本语言独有的一些的动态特性，如动态类型， 代码包含。</p>
<h2 id="贡献"><a href="#贡献" class="headerlink" title="贡献"></a>贡献</h2><ul>
<li><p>提出了一个对于PHP的过程间静态分析算法。 尝试解决一些动态语言特有的挑战， 如： 动态代码加载， 动态变量类型转化， pervasive use of hash tables and regular expression matching. </p>
<p>如上所说， 本文的核心方法时提出了一种三层结构， 利用隔离处理，想上传播的思想。 在<code>intrablock</code>, <code>intraprocedural</code>, and <code>interprocedual </code>三个level上做文章。 如在每个BB（basic block）中， 作者尝试利用符号执行去model动态特征(dynamic features)， 然后将结果生成block summaries, 这些summaries供上层分析使用， 从而帮助我们hidden了下层内部的复杂结构。 </p>
</li>
<li><p>本文使用上述静态分析方法寻找SQL注入， 但是we believe that, with small modifications, the same techniques can be applied to detecting other vulnerabilities such as XSS and code injection in web applications.</p>
</li>
<li><p>本文experimentally validate our approach by implementing the analysisi algorithm and running it on 6 popular web application written in PHP. 找到了105个0day.</p>
</li>
</ul>
<h2 id="Scripting-Language-Dynamic-Feautres"><a href="#Scripting-Language-Dynamic-Feautres" class="headerlink" title="Scripting Language Dynamic Feautres"></a>Scripting Language Dynamic Feautres</h2><p>每次遇到这个章节， 我都想总结一下:</p>
<img src="PHP-Static-Analysis-Theory/image-20210711161321077.png" alt="image-20210711161321077 " style="zoom:40%;" />

<p>如上例子， 作者对比了PHP与JAVA构造SQL语句时的不同，JAVA用的是prepared statements(当然PHP引入PDO后也是这样，但是int类型还是会出问题)。而PHP直接拼接字符串(<code>natural integration</code>)。</p>
<img src="PHP-Static-Analysis-Theory/image-20210711161557125.png" alt="image-20210711161557125" style="zoom:40%;" />

<p><code>implicit casting</code>  主要涉及到字符串,这种web app中最常见的输入。 在代码中常常做出各种诡异的转化。</p>
<img src="PHP-Static-Analysis-Theory/image-20210711161827521.png" alt="image-20210711161827521" style="zoom:40%;" />

<img src="PHP-Static-Analysis-Theory/image-20210711162140830.png" alt="image-20210711162140830" style="zoom:40%;" />  



<p>如使用，<code>extract</code>会根据参数讲数组的键值映射成变量，(这一块没太看清楚,可能就是讲extract这种函数动态向符号表引入变量)。</p>
<h2 id="ANALYSIS"><a href="#ANALYSIS" class="headerlink" title="ANALYSIS"></a>ANALYSIS</h2><p>本文主要的贡献是还是一些理论上的形式化分析， 没有看到工程上的东西。</p>
<h3 id="步骤："><a href="#步骤：" class="headerlink" title="步骤："></a>步骤：</h3><ol>
<li>生成AST</li>
</ol>
<p>AST:  将PHP解析成抽象语法树(用的PHP5.0.5)， 还是以文件为单位的， 将文件中无封装的无的语句作为main function, 每一个文件有一个main, 0-N个user-defined function, 分析从main function开始。</p>
<ol start="2">
<li>建BB，建CFG</li>
</ol>
<p>分析文件中的每个function的ast。 划分BB,本文用的粒度是<code>single entry, single exit sequences of tatements</code>(看到还有以单条statement为粒度的)。然后构建CFG，遇到conditional jumps在CFG edge上label branch predicate。</p>
<ol start="3">
<li><p>Simulated using Symbol execution</p>
<p>对每一个基本块， 作者使用了动态特性去理解块中的每一条statement对global state of the program所带来的影响，并将这些信息记录成summary。</p>
</li>
<li><p>Reachability analysis</p>
<p>即数据流的可达性分析， 建立在构造好summaries的块之上，combine <code>block summaries</code> into a <code>function summary</code> , 此时function summary建立了(即第二层)，每个<code>function summary</code> 描述了<code>pre- and post-conditions of a function</code></p>
</li>
<li><p>处理calls</p>
<p>在function内做可达性分析时， 难免会遇到其他过程的调用，此时需cover。</p>
</li>
</ol>
<p>具体来看：</p>
<h2 id="1-Simulate-Basic"><a href="#1-Simulate-Basic" class="headerlink" title="1. Simulate Basic"></a>1. Simulate Basic</h2><p>在语言建模的基础上，完成转化，生成每个块的summary（BlockSummary）</p>
<img src="PHP-Static-Analysis-Theory/image-20201114140707691.png" alt="image-20201114140707691 " style="zoom:50%;" />

<p>这个总的算法，输入为一个基本块，初始一个<code>state</code> 用来初始化块中变量状态(<code>x</code>-&gt;<code>x0</code>) 。 并在循环中迭代更新状态，如果遇到return和exit，则为出口；end block（迭代完成）也为出口，过程间分析时遇到<code>exit</code>也为出口。用每一个基本块的simulate后的state做一个summary, 然后返回这个块的summary。</p>
<p><code>intra-block simulation</code>的关键 问题就是在于如何simulate state， 以下讨论<code>simulation process</code>:</p>
<h2 id="Language：-先对语言进行建模"><a href="#Language：-先对语言进行建模" class="headerlink" title="Language： 先对语言进行建模"></a>Language： 先对语言进行建模</h2><img src="PHP-Static-Analysis-Theory/image-20201114142327873.png" alt="image-20201114142327873 " style="zoom:50%;" />



<p>在此作者根据需求， 对PHP语言进行建模， 形成了一个子集：</p>
<ol>
<li><p>变量值类型(Value Type): 字符，布尔，数组，静态无法确认的数据(如形参) </p>
</li>
<li><p>常量值类型(Constant): 字符串，数字，true, false, null</p>
</li>
<li><p>L-val(location value)，这里有variable x, 实参，array </p>
</li>
<li><p>表达式(Expression)：常量表达式，变量表达式， 二元操作表达式， 一元操作表达式， 表达式类型转化。 </p>
</li>
<li><p>语句(Statement):  赋值语句(表达式运算)，赋值语句(过程调用) ，返回值语句return, 退出语句exit，包含语句include。</p>
<p>其中提到了，include这种statement是scripting language所特有的(which allows prorammers to dynamically insert code into the program)。</p>
</li>
</ol>
<h2 id="Simulation-State-Memory-Location-gt-Value"><a href="#Simulation-State-Memory-Location-gt-Value" class="headerlink" title="Simulation State(Memory Location -&gt; Value)"></a>Simulation State(Memory Location -&gt; Value)</h2><p><code>Simulation State</code> 是一个映射， 此映射: Memory Location-&gt;their value representations, 此处的<code>memory location</code> 指的是一个<code>program variable</code>(e.g., x), 或者<code>a hash table accessed via another location</code>（e.g. x[key]).</p>
<img src="PHP-Static-Analysis-Theory/image-20210713163228163.png" alt="image-20210713163228163" style="zoom:50%;" />

<blockquote>
<p>The simulation state maps memory locations to their value representations</p>
<img src="PHP-Static-Analysis-Theory/image-20210715164509813.png" alt="image-20210715164509813" style="zoom:50%;" />
</blockquote>
<p>图(a)是完整的表述。这一段就是形成一个Location到value的映射。</p>
<img src="PHP-Static-Analysis-Theory/image-20201114145427950.png" alt="image-20201114145427950 " style="zoom:50%;" />

<p>在开始分析的时候， Loc会被初始化为一个<code>L0</code>, 组成了simulation的初始状态集合。然后迭代value， 这里的value分为三类，具体看图(a)中的value representation部分，可以表示为三类分别是(String, Boolean和Integer)。</p>
<ul>
<li><p>String:</p>
<p>String是最基本的类型，也是我们关注的类型。modeling string 的精确程度，直接影响了分析的精确性。</p>
<p>作者认为，<code>modeling concatenation well enables an analysis to better understand information flow in a script</code>. 举例子来说，就像用户输入的GET, POST会拿来拼接SQL语句，SQL查询结果又会拼接到HTML中， 这是常见的动态web操作。因此，作者将<code>string values are represented as an ordered concatenation of string segments,.</code></p>
<img src="PHP-Static-Analysis-Theory/image-20210713162322867.png" alt="image-20210713162322867" style="zoom:67%;" />
</li>
<li><p>Boolean:</p>
</li>
<li><p>Integer:</p>
<p>Support track integer constants and binary and unary operations between them. We also support type cast from integers to Boolean and string values.</p>
</li>
</ul>
<h3 id="Locations和L-val转化规则"><a href="#Locations和L-val转化规则" class="headerlink" title="Locations和L-val转化规则"></a>Locations和L-val转化规则</h3><p>这里在解释L-val, 首先看模型：</p>
<img src="PHP-Static-Analysis-Theory/image-20201114152059860.png" alt="image-20201114152059860 " style="zoom:50%;" />

<p>如上面对Lv的规则的定义， var, arg,dim三种(注意当时的文章都不考虑OO)。</p>
<p>看下边这个例子：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$hash</span> = <span class="variable">$_POST</span>; <span class="comment">//$_POST这个hash table赋给$hash</span></span><br><span class="line"><span class="variable">$key</span> = <span class="string">&quot;user&quot;</span>; <span class="comment">//常量赋值</span></span><br><span class="line"><span class="variable">$userid</span> = <span class="variable">$hash</span>[<span class="variable">$key</span>]; </span><br></pre></td></tr></table></figure>

<p>分析这段代码， 首先看初始状态</p>
<img src="PHP-Static-Analysis-Theory/image-20201114152915770.png" alt="image-20201114152915770 " style="zoom:50%;" />

<p>我们让每一个符号指向一个初始状态。然后根据上边的规则定义， 根据var的规则处理前两条：</p>
<img src="PHP-Static-Analysis-Theory/image-20201114153406937.png" alt="image-20201114153406937 " style="zoom:50%;" />

<p>他们都指向了一个unique location。</p>
<p>第三条来用dim的规则定义处理。此时根据横线上方两条条件规则(e是名e’是键)，分别映射到_POST0和[‘userid’]那么他将映射到L[阿尔法]中， 即_POST[userid]0。</p>
<hr>
<h3 id="Exp转化规则"><a href="#Exp转化规则" class="headerlink" title="Exp转化规则"></a>Exp转化规则</h3><img src="PHP-Static-Analysis-Theory/image-20201114154757715.png" alt="image-20201114154757715 " style="zoom:50%;" />

<p>因为脚本语言是一种动态类型， 在运行解释器会选择当前运算最适合的规则(弱类型)。那么就带了了类型转化问题。</p>
<img src="PHP-Static-Analysis-Theory/image-20201114154900851.png" alt="image-20201114154900851 " style="zoom:50%;" />





<hr>
<h3 id="Statements转化规则"><a href="#Statements转化规则" class="headerlink" title="Statements转化规则"></a>Statements转化规则</h3><p>赋值有两种： 表达式计算赋值，和过程间调用赋值。 先看表达式计算如何被model:</p>
<p><img src="/PHP-Static-Analysis-Theory/image-20210715171024725.png" alt="image-20210715171024725"></p>
<p>Assignment rule：</p>
<ol>
<li>resolves the left-hand side into a memory location l. (上式lv&#x3D;&gt;l)</li>
<li>evaluates the right-hand side into a value v.(上式e&#x3D;&gt;v)</li>
</ol>
<p>然后根据rule update the simulation state after the assignment maps <code>l</code> to the new value <code>v</code>。 </p>
<hr>
<h3 id="Block-summary"><a href="#Block-summary" class="headerlink" title="Block summary"></a>Block summary</h3><p>经过以上的转化后， 将块内信息转化为block summary，一个块summary是由六元组组成:</p>
<p><img src="/PHP-Static-Analysis-Theory/image-20210719203339317.png" alt="image-20210719203339317"></p>
<ul>
<li><p>Error set: 在进入BB时，每一个variables必须是sanitized的状态。</p>
</li>
<li><p>Definitions: the set of memory locations defined in the current block. </p>
</li>
<li><p>Value flow:  the set of pairs of locations (l1, l2), l1 on the entry becomes a substring of l2 on exit.</p>
</li>
<li><p>Termination predicate: 块中是否含有程序终结, true if the current block contains a exit statement, or if it calls a function that causes the progmra to terminate.</p>
</li>
<li><p>Return value:  返回值， records the representation for the return value if any, undefined otherwise. </p>
</li>
<li><p>Untaint set:  向每个后继块传递当前的未过滤变量集合(由于有分支的存在，故每一个后继得到的summary可能不同)</p>
</li>
</ul>
<h3 id="Intraprocedural-Analysis"><a href="#Intraprocedural-Analysis" class="headerlink" title="Intraprocedural Analysis"></a>Intraprocedural Analysis</h3><p><img src="/PHP-Static-Analysis-Theory/image-20210719204831765.png" alt="image-20210719204831765"></p>
<p>一个过程内的抽象，是基于他的块抽象的：</p>
<ul>
<li>Error set: the set of <code>memory locations(variables, parameters, and hash access)</code>, 因为查的是SQL注入， 所以当其中一个memory locations的value流入database query时， 必须有记录他被sanitized了,否则error</li>
<li>Return set:  the set of parameters or global variables 进入了return value（only string）</li>
<li>Sanitized values:  the set of parameters or global variables,使用前向数据流可达性分析来探测被过滤输入流入每一个包含return的块。</li>
<li>Program Exit:  一个指明当前function是否退出程序， 穷举所有CFG可达块。  如果没有return, 此程序就是一个exit function(也不一定，有的分支执行到最后就默认返回null了)</li>
</ul>
<h3 id="Interprocedural-Analysis"><a href="#Interprocedural-Analysis" class="headerlink" title="Interprocedural Analysis"></a>Interprocedural Analysis</h3><p>本文的分层次污点分析的最高层， interprocedural层。分析intra的summary, 对于每一个function call点， f(e1…en)分析一下四个方面：</p>
<ul>
<li><p>Pre-conditions:  使用error set 证明the set of parameters and global variables在进入该过程时都是安全的</p>
</li>
<li><p>Exit condition:  如果进入了一个exit function, 就将之后所有的stmt删除。</p>
</li>
<li><p>Post-conditions:  </p>
</li>
<li><p>Return value:  </p>
<p><img src="/PHP-Static-Analysis-Theory/image-20210719210926117.png" alt="image-20210719210926117"></p>
</li>
</ul>
<p><img src="/PHP-Static-Analysis-Theory/image-20210719210938703.png" alt="image-20210719210938703"></p>
<h2 id="ExPERIMENTAL-RESULTS"><a href="#ExPERIMENTAL-RESULTS" class="headerlink" title="ExPERIMENTAL RESULTS"></a>ExPERIMENTAL RESULTS</h2><p><img src="/PHP-Static-Analysis-Theory/image-20210719211022777.png" alt="image-20210719211022777"></p>
<p>没有 False Positive, 确定没有误报？</p>
<h2 id="CASE-STUDY"><a href="#CASE-STUDY" class="headerlink" title="CASE STUDY"></a>CASE STUDY</h2><p><img src="/PHP-Static-Analysis-Theory/image-20210719211058506.png" alt="image-20210719211058506"></p>
<p>但是我并没有看到具体的符号执行啊。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2020/11/14/PHP-Static-Analysis-Theory/" data-id="cl1d6yigr000akjw527yd0ahh" data-title="Static Detection of Security Vulnerabilities in Scripting Languages" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/paper/" rel="tag">paper</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-NDSS-14-RIPS" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/11/01/NDSS-14-RIPS/" class="article-date">
  <time class="dt-published" datetime="2020-11-01T07:24:12.000Z" itemprop="datePublished">2020-11-01</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/11/01/NDSS-14-RIPS/">Simulation of Built-in PHP Feature for Precise Static Code Analysis</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>文章题目： Simulation of Built-in PHP Feature for Precise Static Code Analysis.</p>
<p>作者： Johannes Dahse &amp; Toorstem Holz</p>
<p>RIPS研究PHP静态分析几乎绕不开的工具， 一是选择的时间点好，2014年左右PHP还是比较火的。二是工具确实不多。 这篇文章发了14年的NDSS，还是有些东西值得借鉴的。</p>
<h2 id="技术背景"><a href="#技术背景" class="headerlink" title="技术背景"></a>技术背景</h2><p>首先， 作者在技术背景部分分析了一些PHP这种highly dynamic lanuage的痛点。</p>
<p><img src="/NDSS-14-RIPS/image-20201101153514155.png" alt="image-20201101153514155"></p>
<ul>
<li><p>1） 动态类型&#x2F;弱类型</p>
<p>脚本语言在变量声明时不用声明类型的确给静态分析带来不少麻烦，而动态类型指的是在运行时类型是可以变得(its variables are not bound to a specific data type).</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$var1</span> = <span class="number">1</span>; <span class="variable">$var2</span> = <span class="string">&#x27;test&#x27;</span>;</span><br><span class="line"><span class="variable">$var2</span> = <span class="variable">$var1</span> + <span class="variable">$var2</span>; <span class="comment">//1 </span></span><br></pre></td></tr></table></figure>


</li>
<li><ol start="2">
<li>variable Variables</li>
</ol>
<p>这个貌似是PHP独有的，叫$$特性？</p>
 <figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$name</span> = <span class="string">&quot;x&quot;</span>;</span><br><span class="line"><span class="variable">$x</span> = <span class="string">&quot;test&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$$name</span>; <span class="comment">//test</span></span><br><span class="line"><span class="variable">$y</span> = $&#123;<span class="title function_ invoke__">getVar</span>()&#125;; <span class="comment">//变量名可以是一个表达式ZZ</span></span><br></pre></td></tr></table></figure>
</li>
<li><ol start="3">
<li><p>Dynamic Arrays</p>
<p>动态数组，PHP的数组是hash table实现的。可以存任何不同的数据类型，而且在初始化的时候key值可以省略在运行时指定。</p>
<p><img src="/NDSS-14-RIPS/image-20201101154933544.png" alt="image-20201101154933544"></p>
</li>
</ol>
</li>
</ul>
<p>注意这里新添加的自动索引了6, 神不神奇？会按照“4”开始算，把”4”改成”664”就是’e’的索引就是666。（还是说脚本语言的不规范性）</p>
<ul>
<li><ol start="4">
<li><p>Dynamic Constants</p>
<p>通过define()在于形式动态定一个常量， 通过constant()运行时访问。</p>
</li>
</ol>
</li>
<li><ol start="5">
<li>Dynamic Function</li>
</ol>
<p>function动态调用， 这个说的就太多了。</p>
<p><img src="/NDSS-14-RIPS/image-20201101155917397.png" alt="image-20201101155917397"></p>
</li>
</ul>
<p>第2行向我们讲述了， 不仅变量名可以是表达式， 方法名也可以是表达式； 第三行是一个回调函数，在动态的时候才知道执行啥。另外，还有<code>fun_get_arg()</code>和<code>func_get_args()</code>在运行时动态从call site拿参数; <code>create_function()</code>动态创建一个方法体org。</p>
<ul>
<li><ol start="6">
<li><p>Dynamic Code </p>
<p>动态执行代码， 通过<code>eval</code>, <code>assert</code>，小马常用到。这些代码在动态运行时才能知道， 给静态分析增加了难度。</p>
</li>
</ol>
</li>
<li><ol start="7">
<li><p>Dynamic includes </p>
<p>这个吐糟也比较多， 大型PHP项目尝尝被分割成若干文件和目录，他们的拼接为静态分析也增加了难度。类似<code>include</code>，使用这种操作，将文件中的代码返回到include处。尤其是现在又加了惰性加载机制。autoload()这种在静态分析目前只有猜了。</p>
</li>
</ol>
</li>
<li><ol start="8">
<li>Built-in Functinos</li>
</ol>
<p>   本文关注和要解决的主要challenge。不像Java, PHP的内建函数都是用C写的， 在ZEND执行时调用。大约有228个扩展5701个内建函数， 他们在静态分析PHP代码时无法被hook到，这就导致了分析的不精确。</p>
</li>
</ul>
<p><img src="/NDSS-14-RIPS/image-20201101162437988.png" alt="image-20201101162437988"></p>
<p>如图，第二个位置月份可以是字符型， 这里如果要能探测到XSS就要对list(), printf()进行精确建模。</p>
<ul>
<li><ol start="9">
<li><p>Superglobals</p>
<p> 我们的超全局变量， 需要精确的标明哪些可控。开发者经常忽略FILES和SERVER的安全性。</p>
</li>
</ol>
</li>
</ul>
<h2 id="方法设计"><a href="#方法设计" class="headerlink" title="方法设计"></a>方法设计</h2><h3 id="纵览"><a href="#纵览" class="headerlink" title="纵览"></a>纵览</h3><ol>
<li><p>还是文件为单位， 首相将散乱在文件中的代码解析成main AST(脚本语言通常没有main方法做入口)， 然后将user-defined function们收集起来， 将函数名， 参数等信息存入分析环境， 然后将其函数体构建成separate AST独立于main AST。</p>
</li>
<li><p>有了 AST， 下一步构建CFG(控制流图)， 分析AST如果发现<code>conditional jump</code> ,  就开辟一个新的基本块(<code>basic block</code>);并使用<code>basic edge</code>相连接。</p>
</li>
<li><p>有了CFG， 下一步构建PDG(数据依赖图)咯， 以基本块为单位，每当一个BB产生， 就分析一下他的<code>adta flow</code> 。</p>
</li>
<li><p>实现Intra(过程内)和Inter(过程间)分析，当遇到<code>call site</code> 就在环境中找到该方法名并进入其AST进行分析，从而实现<code>inter</code>能力。</p>
</li>
<li><p>实现污点分析。</p>
</li>
</ol>
<p>(说的挺复杂，开源版的RIPS的基础分析能力还是以分析tokens流并以各种数据结构辅助追踪为主)</p>
<h2 id="创新点"><a href="#创新点" class="headerlink" title="创新点"></a>创新点</h2><p>那么本paper novel在什么地方呢：</p>
<ul>
<li>在污点分析时添加了sanitization tags来表明数据被过滤</li>
<li>为952个内建方法建模，从而更精准的把控整个分析流的变化</li>
<li>在处理include file时，当作functions来处理，而不是直接加入到当前CFG，防止重复分析, 减少开销</li>
<li>根据基本块边来总结他们之间的sanitization影响</li>
<li>实现了后向污点分析，每一个基本块的分析结果，cache到一个变量里。</li>
<li>使用上下文敏感字符分析(context-sensitive stirng analysis)来精炼污点分析结果，基于当前环境。</li>
</ul>
<h2 id="CFGBuilder"><a href="#CFGBuilder" class="headerlink" title="CFGBuilder"></a>CFGBuilder</h2><p>要构建一个CFG, 先定义statements, 划分基本块。</p>
<p><img src="/NDSS-14-RIPS/image-20201102203138487.png" alt="image-20201102203138487"></p>
<p>这里作者定义了几种划分基本块的stmt， 配合算法：  </p>
<p><img src="/NDSS-14-RIPS/image-20201102203339071.png" alt="image-20201102203339071"></p>
<p> 中间的循环AST上的每一个点，如果遇到四种stmt的情况。 </p>
<ul>
<li><p>JSTMT, 遇到IF, Switch, Try, Ternary, LogicalOr（后两个没见过）， 就递归分析每个分支下的基本块。将入口条件加到基本块头。</p>
</li>
<li><p>LSTMT, 生成循环基本块</p>
</li>
<li><p>SSTMT, 停止，基本块下的stmts不可达</p>
</li>
<li><p>RSTMT, return,到达return或者是探测到程序退出，就不和下一个基本块建立连接。</p>
<p>这里增量在<code>simluate()</code>方法上，来看。</p>
</li>
</ul>
<h2 id="simulating-Basic-Blocks"><a href="#simulating-Basic-Blocks" class="headerlink" title="simulating Basic Blocks"></a>simulating Basic Blocks</h2><p>静态分析能干的事，就是编译器或者解释器能干的事。 RIPS为获取基本块内的data flow, 在控制流的基础上进行所谓的simulating，实现simulating:</p>
<ol>
<li>制定symbols:   值-val, 变量名-varibale, 常量-constant, 数组-ArrayDimFetch… 每一个symbol都会有几个状态(type, encoding, sanitization)，通过观察状态变化做到对类型，编码以及sanitize的敏感。</li>
</ol>
<p>2）Block Summary: 此过程就是将制定的符号集在块中使用进行后向追踪。生成一些块属性(block Summary):</p>
<pre><code>  * DataFlow - 记录变量/数组的assign
  * Constants - 记录常量的assign
  * GlobalDefines - 记录名称，加入global scope
  * ReturnValue - 记录块中的返回值(每个块一个返回， return和exit后的代码丢弃)
  * registerGlobals - 记录使用extract()或者import_request_varibales()注册变量
</code></pre>
<p>在每个块的后向data flow分析后记录以上内容， 生成block summary.</p>
<ol start="3">
<li><p>Data Flow Analysis</p>
</li>
<li><p>Simulating Includes and Dynamic Code： php 的includes是一个动态表达式，通过路径去找，找到加入，若无正则匹配。eval同理。</p>
</li>
<li><p>Simulating Built-in Functions:</p>
</li>
</ol>
<p>​     本文重点。 对621个内建函数进行数据流建模， configured name and effected parameters. 分类如下：</p>
<ul>
<li>Alphanumeric(284):  返回值只有字母数字组成的，effectively sanitize. 如: md5(), strlen()</li>
<li>Argument(122): 原样返回实参或部分的, 如： trim(), strrev()</li>
<li>escape(20): mysql_real_escap_string()这种， 遇到将symbol中的sanitization属性打上SQLI_SQ 和 SQLI_DO标签(如果没遇到就SQLI_NQ)</li>
<li>Substring(6): substr(), chunk_split()这种，返回实参字串的。 </li>
<li>Encode(18):  urlencode(), base64_encode() …</li>
<li>Decode(25): urldecode(), base64_decode()…</li>
<li>Callbacks(51): 回调函数，如果调用函数名事字符串，就调用分析。如果是变量，正则猜测。</li>
</ul>
<h2 id="Intra-produral-Analysis"><a href="#Intra-produral-Analysis" class="headerlink" title="Intra-produral Analysis"></a>Intra-produral Analysis</h2><p>实现intra</p>
<h2 id="Inter-procedural-Analysis"><a href="#Inter-procedural-Analysis" class="headerlink" title="Inter-procedural Analysis"></a>Inter-procedural Analysis</h2><p>实现inter</p>
<h2 id="Simluating-Block-Edges"><a href="#Simluating-Block-Edges" class="headerlink" title="Simluating Block Edges"></a>Simluating Block Edges</h2><p>块与块之间的simluating, 考虑validation的情况</p>
<ul>
<li>operators(6): isset(), empty()…</li>
<li>Type  checks(21): is_numeric()…</li>
<li>File checks(11): is_file()…</li>
<li>Whitelists(3): array_search()</li>
<li>Regex(8): 正则</li>
</ul>
<p>（原来validatation的情况可以放到块与块间，这样就和sanitization的情况分开来去了）。</p>
<h2 id="Taint-Analysis"><a href="#Taint-Analysis" class="headerlink" title="Taint Analysis"></a>Taint Analysis</h2><p>污点分析探测漏洞的过程略。:&gt;</p>
<h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>之前看这篇觉得没啥东西， 仔细分析来东西还是挺多的， 毕竟顶会。</p>
<p>他几乎把所有语言特性层和面向过程层的东西讲到了， 缺少OO层的分析，也是后来不上人针对发文的。</p>
<p>(为什么看起来这么高大上的东西开源版本用起来和…一样)</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2020/11/01/NDSS-14-RIPS/" data-id="cl1d6yigp0007kjw5bi0f8cfd" data-title="Simulation of Built-in PHP Feature for Precise Static Code Analysis" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/paper/" rel="tag">paper</a></li></ul>

    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/2/">&laquo; Prev</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><a class="page-number" href="/page/5/">5</a><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/4/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/paper/" rel="tag">paper</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/php/" rel="tag">php</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pl/" rel="tag">pl</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/paper/" style="font-size: 15px;">paper</a> <a href="/tags/php/" style="font-size: 10px;">php</a> <a href="/tags/pl/" style="font-size: 20px;">pl</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/02/">February 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/01/">January 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/12/">December 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/09/">September 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/08/">August 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/07/">July 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/04/">April 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">March 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/02/">February 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">January 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">December 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">November 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">October 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">September 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">August 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">July 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">June 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">May 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">January 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">September 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">November 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">July 2018</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2022/02/24/web/">Web应用系中注入类漏洞调研</a>
          </li>
        
          <li>
            <a href="/2022/02/18/data-mining/">data_mining</a>
          </li>
        
          <li>
            <a href="/2022/02/14/pop/">A Survey about PHP Object Injection</a>
          </li>
        
          <li>
            <a href="/2022/02/06/logic-machine/">Logic Machine</a>
          </li>
        
          <li>
            <a href="/2022/01/26/fuz/">Fuzzing</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2022 iohex<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>